var Ke=Object.defineProperty;var We=(e,s,o)=>s in e?Ke(e,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[s]=o;var w=(e,s,o)=>(We(e,typeof s!="symbol"?s+"":s,o),o),ye=(e,s,o)=>{if(!s.has(e))throw TypeError("Cannot "+o)};var B=(e,s,o)=>(ye(e,s,"read from private field"),o?o.call(e):s.get(e)),te=(e,s,o)=>{if(s.has(e))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(e):s.set(e,o)},R=(e,s,o,i)=>(ye(e,s,"write to private field"),i?i.call(e,o):s.set(e,o),o);import{l as ve,_ as K,C as ie,b as Be,o as Ye,m as ke,n as He,q as se,e as Xe}from"./xcs-canvas-5c2592d6.js";import{bq as f,br as I,bs as ze,bt as ae,bu as d,bv as je,bw as Q,bx as qe,b8 as U,by as Ge,bz as Je,bA as Ze,bB as $,bC as ne,aV as Pe,bD as Qe,bE as et}from"../assets/index-83a10b2e.js";import{k as Me,I as Ve,q as De,D as Fe,u as tt,a3 as W}from"./xcs-vue-family-70642f71.js";import{D as st}from"./devicedata-18553816.js";import{B as ot,c as rt}from"./params-f8cc805d.js";import{p as it}from"./urlparam-4b6ed041.js";const at=""+new URL("../assets/cover-6177d8fa.png",import.meta.url).href,nt=""+new URL("../assets/d1-turn-on-ead43083.png",import.meta.url).href,ct=""+new URL("../assets/d1-ready-b4700482.png",import.meta.url).href,ge={cover:at,d1TurnOn:nt,readyImg:ct};var x=(e=>(e[e.RED_CROSS=0]="RED_CROSS",e[e.LOW_LIGHT=1]="LOW_LIGHT",e[e.RED_DOT=2]="RED_DOT",e))(x||{}),oe=(e=>(e[e.ZERO=0]="ZERO",e[e.TWO=2]="TWO",e[e.FIVE=5]="FIVE",e[e.TEN=10]="TEN",e[e.TWENTY=20]="TWENTY",e[e.FORTY=40]="FORTY",e))(oe||{}),j=(e=>(e.WORK_PREPARED="WORK_PREPARED",e.WORK_STARTED="start:workingOnline",e.WORK_CONTINUE="ok:WORKING_ONLINE",e.WORK_OFFLINE="ok:WORKING_OFFLINE",e.WORK_PAUSED="ok:PAUSING",e.WORK_STOPED="WORK_STOPED",e.WORK_STOPED_INSTRUCT1="M314 N3",e.WORK_FINISHED="ok:IDLE",e.WORK_FINISHED_INSTRUCT1="MSG:Pgm End",e.WORK_FINISHED_INSTRUCT2="[MSG:Pgm End]",e.WORK_FINISHED_INSTRUCT3="ok[MSG:Pgm End]",e.WORK_FINISHED_INSTRUCT4="M28",e))(j||{});const v={FLAME:"err:flameCheck",LIMIT:"err:limitCheck",TILT:"err:tiltCheck",MOVING:"err:movingCheck",NO_KEY_LOCK:"M66 S1"},lt=[{code:v.FLAME,msg:"err_flame_check"},{code:v.LIMIT,msg:"err_limit_check"},{code:v.TILT,msg:"err_tilt_check"},{code:v.MOVING,msg:"err_moving_check"},{code:v.NO_KEY_LOCK,msg:"err_key_lock"}],dt={CANCEL:["WORK_STOPED","M314 N3"],OK:["ok","ok512"],IDLE:["ok:IDLE","MSG:Pgm End","ok[MSG:Pgm End]"],WORKING:["ok:WORKING_ONLINE"],WORKING_OFFLINE:["ok:WORKING_OFFLINE"],WORKING_ONLINE:["start:workingOnline"],START_WORKING_OFFLINE:["ok:WORKING_ONLINE_READY"],PAUSING:["ok:PAUSING"],NO_USB_KEY_LOCK:["M66 S1"],HAVE_USB_KEY_LOCK:["M66 S0"],USB_KEY_LOCK_ERROR:["ok:KEY_LOCK_ERROR"],ERROR:["ok:ERROR","ok:TMP_ERROR",v.FLAME,v.MOVING,v.TILT,v.LIMIT]};var L=(e=>(e.LASER_PLANE="LASER_PLANE",e.LASER_CYLINDER="LASER_CYLINDER",e.SUPER_LASER_PLANE="SUPER_LASER_PLANE",e.LASER_CONVEYOR_FEEDER="LASER_CONVEYOR_FEEDER",e))(L||{}),E=(e=>(e.VECTOR_CUTTING="VECTOR_CUTTING",e.VECTOR_ENGRAVING="VECTOR_ENGRAVING",e.FILL_VECTOR_ENGRAVING="FILL_VECTOR_ENGRAVING",e.BITMAP_ENGRAVING="BITMAP_ENGRAVING",e.KNIFE_CUTTING="KNIFE_CUTTING",e))(E||{}),q=(e=>(e.BITMAP="BITMAP",e.VECTOR="VECTOR",e))(q||{}),J=(e=>(e.LEFT="left",e.RIGHT="right",e.TOP="top",e.BOTTOM="bottom",e.CENTER="center",e))(J||{}),be=(e=>(e.Error="error",e))(be||{});const mt={WORK_PREPARED:f.BEFORE_START,["start:workingOnline"]:f.START_PROCESS,["ok:WORKING_ONLINE"]:f.START_PROCESS,["ok:WORKING_OFFLINE"]:f.START_PROCESS,["ok:PAUSING"]:f.PAUSE_PROCESS,WORK_STOPED:f.CANCEL_PROCESS,["M314 N3"]:f.CANCEL_PROCESS,["ok:IDLE"]:f.FINISH_PROCESS,["MSG:Pgm End"]:f.FINISH_PROCESS,["[MSG:Pgm End]"]:f.FINISH_PROCESS,["ok[MSG:Pgm End]"]:f.FINISH_PROCESS,M28:f.FINISH_PROCESS},pt=Me({__name:"ProcessingDataForm",props:{ext:null,deviceInfo:null,elementValues:null,deviceValues:null,selectedTypes:null},setup(e){const s=e,o=()=>{var u;const n=(u=s.deviceInfo)==null?void 0:u.power,m=s.deviceValues.mode,c=s.selectedTypes[0];return ve(xe,t=>{const a=!(t.ignorePower||[]).includes(n);return t.imageType===c&&t.modes.includes(m)&&a})},i={[I.VECTOR_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat"],[I.FILL_VECTOR_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat","density","bitmapScanMode"],[I.VECTOR_CUTTING]:["processIgnore","processingType","materialType","power","speed","repeat"],[I.BITMAP_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat","bitmapMode","density","bitmapScanMode"]};return(n,m)=>{const c=ze;return Fe(),Ve(c,De({ext:e.ext,"fields-map":i,"element-values":e.elementValues,"device-values":e.deviceValues,"device-info":e.deviceInfo,"selected-types":e.selectedTypes,"type-options":o},n.$attrs),null,16,["ext","element-values","device-values","device-info","selected-types"])}}}),ut={[I.VECTOR_CUTTING]:{processingLightSource:"blue",power:1,speed:16,repeat:1},[I.VECTOR_ENGRAVING]:{processingLightSource:"blue",power:1,speed:20,repeat:1},[I.FILL_VECTOR_ENGRAVING]:{processingLightSource:"blue",power:1,speed:80,repeat:1,density:100,bitmapScanMode:"zMode"},[I.BITMAP_ENGRAVING]:{processingLightSource:"blue",power:1,speed:80,repeat:1,bitmapMode:"grayscale",density:100,bitmapScanMode:"zMode"}},xe=[{value:I.VECTOR_ENGRAVING,label:"device.processing_type.line_engrave",color:16421416,fillColor:"#f9932b",isFill:!1,imageType:ae.VECTOR,modes:[d.LASER_PLANE,d.LASER_CYLINDER,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER]},{value:I.FILL_VECTOR_ENGRAVING,label:"device.processing_type.fill_engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[d.LASER_PLANE,d.LASER_CYLINDER,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER],imageType:ae.VECTOR},{value:I.VECTOR_CUTTING,label:"device.processing_type.line_cut",color:10036991,fillColor:"#9928ff",isFill:!1,modes:[d.LASER_PLANE,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER],imageType:ae.VECTOR,ignorePower:[2]},{value:I.BITMAP_ENGRAVING,label:"device.processing_type.engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[d.LASER_PLANE,d.LASER_CYLINDER,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER],imageType:ae.BITMAP}],ht={[d.LASER_PLANE]:{material:0,thickness:null,perimeter:null,diameter:null},[d.LASER_CYLINDER]:{material:0,thickness:null,rotaryAttachmentType:"roller",perimeter:null,diameter:null},[d.PASS_THROUGH]:{material:0,thickness:null,perimeter:null,diameter:null},[d.PASS_THROUGH]:{material:0,thickness:null,perimeter:null,diameter:null},[d.LASER_CONVEYOR_FEEDER]:{material:0,thickness:null,perimeter:null,diameter:null}},Et=[{icon:"ext-laser-plane",label:"device.mode.laser_flat",value:d.LASER_PLANE},{icon:"ext-laser-cylinder",label:"device.mode.laser_cylindrical",value:d.LASER_CYLINDER},{icon:"ext-super-laser-plane",label:"device.mode.super_laser_plane",value:d.SUPER_LASER_PLANE}],gt=Me({__name:"ProcessingModeForm",props:{ext:null,deviceValues:null,deviceInfo:null,handler:{type:Function}},setup(e){const s=e,o=(c,u)=>{if(c==="mode"){const t=i(u);s.handler(c,{value:u,processingTypeList:t})}else s.handler(c,u)},i=c=>{var r;const u=(r=s.deviceInfo)==null?void 0:r.power,t=c||s.deviceValues.mode;return ve(xe,a=>{const l=!(a.ignorePower||[]).includes(u);return a.modes.includes(t)&&l})},n=Et.map(({icon:c,label:u,value:t})=>({icon:c,label:u,value:t})),m={[d.LASER_PLANE]:["mode","material"],[d.LASER_CYLINDER]:["mode","material","rotaryAttachmentType","catchMode"],[d.PASS_THROUGH]:["mode","material"],[d.SUPER_LASER_PLANE]:["mode","material"],[d.LASER_CONVEYOR_FEEDER]:["mode","material"]};return(c,u)=>{const t=je;return Fe(),Ve(t,De({ext:e.ext,"device-values":e.deviceValues,"mode-options":tt(n),"device-info":e.deviceInfo,"fields-map":m,handler:o,"process-types":i},c.$attrs),null,16,["ext","device-values","mode-options","device-info"])}}}),_t=W({loader:()=>K(()=>import("./devicesettings-daa3b91b.js"),["./devicesettings-daa3b91b.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./setting.vue_vue_type_style_index_0_lang-315c55c2.js","./setting.vue_vue_type_script_setup_true_lang-0ee96bfb.js","./modal-c96d5b67.js","./button-00b27872.js","./light-87cce264.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js","./scrollbar-5a89bf25.js","./fade-in.cssr-8e3c8f09.js","./image-bad03660.js","./spin-afa417d1.js","./text-3b674000.js","./light-28752129.js","./checkbox-9495194d.js","./inputnumber-fff11604.js","./headers-069f588a.js","./use-message-cd8b9f19.js"],import.meta.url)}),Rt=W({loader:()=>K(()=>import("./walkbordertipmodal-8ef7ba48.js"),["./walkbordertipmodal-8ef7ba48.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./setting.vue_vue_type_style_index_0_lang-315c55c2.js","./modal-c96d5b67.js","./button-00b27872.js","./light-87cce264.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js","./scrollbar-5a89bf25.js","./fade-in.cssr-8e3c8f09.js","./image-bad03660.js","./spin-afa417d1.js","./text-3b674000.js","./light-28752129.js"],import.meta.url)}),ft=W({loader:()=>K(()=>import("./walkbordersettings-ebbef082.js"),["./walkbordersettings-ebbef082.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./headers-069f588a.js","./light-87cce264.js","./light-28752129.js","./devicedata-18553816.js","./params-f8cc805d.js","./urlparam-4b6ed041.js"],import.meta.url)}),Tt=W({loader:()=>K(()=>import("./previewleftsider-cf4e385a.js"),["./previewleftsider-cf4e385a.js","./setting.vue_vue_type_style_index_0_lang-315c55c2.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./checkbutton.vue_vue_type_script_setup_true_lang-c0bad176.js","./button-00b27872.js","./light-87cce264.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js","./scrollbar-5a89bf25.js","./fade-in.cssr-8e3c8f09.js","./headers-069f588a.js","./light-28752129.js","./element-17c18d0e.js","./inputnumber-fff11604.js","./text-3b674000.js","./grid-9031c693.js","./devicedata-18553816.js","./params-f8cc805d.js","./urlparam-4b6ed041.js"],import.meta.url)}),Lt=W({loader:()=>K(()=>import("./uploadturnon-b5204cd3.js"),["./uploadturnon-b5204cd3.js","./xcs-vue-family-70642f71.js","./text-3b674000.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./fade-in.cssr-8e3c8f09.js","./light-28752129.js","./image-bad03660.js","./space-5433d955.js","./use-style-1280d407.js","./scrollbar-5a89bf25.js","../assets/index-83a10b2e.js","./index-55948043.js"],import.meta.url)}),yt=W({loader:()=>K(()=>import("./changelogbutton-db5e6f6a.js"),["./changelogbutton-db5e6f6a.js","./xcs-vue-family-70642f71.js","./button-00b27872.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js"],import.meta.url)}),Pt=W({loader:()=>K(()=>import("./uploadturnonfooter-8d4525f0.js"),["./uploadturnonfooter-8d4525f0.js","./xcs-vue-family-70642f71.js","./button-00b27872.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js"],import.meta.url)}),St=W({loader:()=>K(()=>import("./success-cb46d31c.js"),["./success-cb46d31c.js","./xcs-vue-family-70642f71.js","./text-3b674000.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./fade-in.cssr-8e3c8f09.js","./light-28752129.js","./image-bad03660.js","./space-5433d955.js","./use-style-1280d407.js","./scrollbar-5a89bf25.js","../assets/index-83a10b2e.js","./index-55948043.js"],import.meta.url)}),Nt={DeviceSetting:_t,WalkBorderTipModal:Rt,WalkBorderSettings:ft,ProcessingModeForm:gt,ProcessingDataForm:pt},{LASER_PLANE:Ct,LASER_CYLINDER:It,SUPER_LASER_PLANE:wt}=L,{VECTOR_ENGRAVING:ce,FILL_VECTOR_ENGRAVING:le,VECTOR_CUTTING:de,BITMAP_ENGRAVING:me}=E,At={speed:{[Ct]:[{type:ce,min:1,max:80,defaultValue:1},{type:le,min:1,max:400,defaultValue:1},{type:de,min:1,max:20,defaultValue:1},{type:de,min:1,power:[40],max:60,defaultValue:1},{type:me,min:1,max:400,defaultValue:1}],[It]:[{type:ce,roller:!0,min:1,max:25,defaultValue:1},{type:le,roller:!0,min:1,max:400,defaultValue:1},{type:me,roller:!0,min:1,max:400,defaultValue:1},{type:ce,catch:!0,min:1,max:120,defaultValue:1},{type:le,catch:!0,min:1,max:400,defaultValue:1},{type:me,catch:!0,min:1,max:400,defaultValue:1}],[wt]:[{type:ce,min:1,max:80,defaultValue:1},{type:le,min:1,max:400,defaultValue:1},{type:de,min:1,max:20,defaultValue:1},{type:de,min:1,max:60,power:[40],defaultValue:1},{type:me,min:1,max:400,defaultValue:1}]},offset:[{power:10,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}},{power:20,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}},{power:40,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}},{power:2,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}}]},Ot=[{code:"err:flameCheck",msg:"err_flame_check"},{code:"err:limitCheck",msg:"err_limit_check"},{code:"err:tiltCheck",msg:"err_tilt_check"},{code:"err:movingCheck",msg:"err_moving_check"}],$t=`# d1-pro BITMAP HEAD
\${isContinuousLight ? 'M4': ''}
# motion_start
# motionConfig=\${motionConfig}
`,vt=`# d1-pro BITMAP TAIL
# motion_end
`,kt=`# d1-pro HEAD
M17 S1
M207 \${ isWalkBorder ? 'S0':'S1'}
M106 \${crossCommand}
M205 X\${width} Y\${height}
\${typeCommand}
G92 X\${startPoint.x} Y\${startPoint.y}
G0 F9600
G1 F1000
`,Gt=`# d1-pro TAIL
G90
G0 X\${startPoint.x} Y\${startPoint.y}
M18
\${needFire ? 'M9 S'+ lowLightPower + ' N9007199254740991':''}
`,Mt=`
# d1-pro VECTOR HEAD
\${isContinuousLight ? 'M3': ''}
# motion_start
# motionConfig=\${motionConfig}
G90
`,Vt=`# d1-pro VECTOR TAIL
# motion_end
`,X={gCodeTail:Gt,gCodeHead:kt,bitmapHead:$t,vectorHead:Mt,bitmapTail:vt,vectorTail:Vt},Dt={head(e){const{crossCommand:s,size:{w:o,h:i},typeCommand:n,startPoint:m,isWalkBorder:c}=e;return ie(X.gCodeHead)({crossCommand:s,width:o,height:i,typeCommand:n,startPoint:m,isWalkBorder:c})},tail(e){const{needFire:s,startPoint:o,lowLightPower:i}=e;return ie(X.gCodeTail)({needFire:s,lowLightPower:i,startPoint:o})},vectorHead(e){const s=ie(X.vectorHead),{isContinuousLight:o,color:i}=e;return s({isContinuousLight:o,motionConfig:JSON.stringify({color:i})})},vectorTail(){return X.vectorTail},bitmapHead(e){const s=ie(X.bitmapHead),{isContinuousLight:o,color:i,enableRelative:n}=e;return s({isContinuousLight:o,enableRelative:n,motionConfig:JSON.stringify({color:i})})},bitmapTail(){return X.bitmapTail}},z=(e,s)=>{let o;try{o=JSON.parse(e)}catch(i){o=s,console.debug("[JSON.parse]",e,i)}return o},Ft=[{name:"progress",url:"/progress"},{name:"version",url:"/system",params:{action:"version"},transformResponse(e){const s=z(e);return s==null?void 0:s.version}},{name:"ping",url:"/ping"},{name:"machineType",url:"/getmachinetype"},{name:"laserPowerType",url:"/getlaserpowertype"},{name:"system",url:"/system",params:{action:"mac"}},{name:"setLaserPower",url:"/cmd",params:{cmd:"M9"}},{name:"toRedCrossMode",url:"/cmd",params:{cmd:"M97 S0"}},{name:"toLowLightMode",url:"/cmd",params:{cmd:"M97 S1"}},{name:"setRedCrossOffset",url:"/cmd",params:{cmd:"M98"}},{name:"openPowerApply",url:"/cmd",params:{cmd:"M204 X500 Y40"}},{name:"queryKeyLockStatus",url:"/system",params:{action:"usb_key_sta"},timeout:5e3,transformResponse(e){const s=z(e);return!s.hasOwnProperty("usb_key_sta")||s.usb_key_sta==="0"}},{name:"setDeviceName",url:"/cmd",params:{cmd:"M100"}},{name:"setProcessPause",url:"/cnc/data",params:{action:"pause"}},{name:"setFlameAlarm",url:"/cmd",params:{cmd:"M310"}},{name:"setFlameAlarmSensitivity",url:"/cmd",params:{cmd:"M309"}},{name:"setTiltStop",url:"/cmd",params:{cmd:"M317"}},{name:"setMoveStop",url:"/cmd",params:{cmd:"M318"}},{name:"setLimitSwitch",url:"/cmd",params:{cmd:"M319"}},{name:"openRedPoint",url:"/cmd",params:{cmd:"M97 S0"}},{name:"stopWalkBorder",url:"/cmd",params:{cmd:"M108"}},{name:"getWorkingSta",url:"/system",params:{action:"get_working_sta"},timeout:5e3,transformResponse(e){const s=z(e);return!s.hasOwnProperty("working")||s.working==="0"}},{name:"getSDCardStatus",url:"/peripherystatus",transformResponse(e){return z(e,{sdCard:0}).sdCard===1}},{name:"cmd",url:"/cmd",params:{cmd:""}},{name:"deviceInfo",timeout:6e3,list:[{url:"/system",params:{action:"get_dev_name"}},{url:"/system",params:{action:"version"}},{url:"/getlaserpowertype"},{url:"/system",params:{action:"dotMode"}},{url:"/system",params:{action:"offset"}},{url:"/peripherystatus"}],transformResult(e){const[s,o,i,n,m,c]=e,u=(s==null?void 0:s.name)||"",t=o==null?void 0:o.version,r=o==null?void 0:o.sn,a=i==null?void 0:i.power,p=n==null?void 0:n.dotMode,l=m.x??0,h=m.y??0,T=c.flameAlarmSensitivity??2,A=c.movingStopFlag??0,k=c.limitStopFlag??0,O={power:a,isRedLight:a===2,gMode:p,redCrossOffsetX:l,redCrossOffsetY:h,flameAlarmSensitivity:T,moveStop:A,limitSwitch:k};return u&&(O.name=u),r&&(O.snCode=r),t&&(O.version=t),console.log(["=> info",O]),O}},{name:"framing",url:"/framing"},{name:"uploadGcode",url:"/cnc/data",type:"post",headers:{"Content-Type":"multipart/form-data"},timeout:0,transformRequest:e=>{const s=new FormData,o=new Blob([e.gcode],{type:"text/plain"});return s.append("tmp.gcode",o),s},transformResponse(e){return z(e,{result:""}).result==="ok"}},{name:"downloadFirmware",responseType:"blob",timeout:0},{name:"updateFirmware",url:"/upgrade",type:"post",headers:{"Content-Type":"multipart/form-data"},timeout:0,transformRequest:e=>{const s=new FormData,o=new Blob([e],{type:"application/macbinary"});return s.append("file",o),s},transformResponse(e){if(typeof e=="string"&&e.toLocaleUpperCase()==="OK")return Promise.resolve(!0);try{return z(e,{result:""}).result.toLocaleUpperCase()==="OK"?Promise.resolve(!0):(console.error(["=> D1-pro uploadFirmware fail",e]),Promise.resolve(!1))}catch(s){return console.error(["=> D1-pro uploadFirmware fail",s]),Promise.resolve(!1)}}},{name:"stopProcessing",url:"/cnc/data",params:{action:"stop"}},{name:"endProcessing",url:"/cmd",params:{cmd:`M108 
`}}],{FIVE:bt,TEN:xt,TWENTY:Se,TWO:Ne,FORTY:Ce}=oe,Ie=5,we=2,pe={min:1,max:10,default:3,enable:!0},ue={min:80,max:180,default:160,enable:!0},Ut={power:{min:1,max:10,default:10,enable:!1},speed:{min:80,max:180,default:160,enable:!0},enable:!0},Kt={canStopWalkBorder:!0,walkBorder:{default:Ut,[bt]:{power:pe,speed:ue,enable:!0},[xt]:{power:pe,speed:ue,enable:!0},[Se]:{power:{...pe,default:we},speed:ue,enable:!0},[Ce]:{power:{...pe,default:Ie},speed:ue,enable:!0}},buildParams:{delta:.1,neg_sign:0,swap_xy:0,enableRelative:!0,accel:{defaultValue:2500,list:[{key:2,value:500}]},overScanRequired:!0,finishInOneTime:!1},extendDirection:{[Q.LASER_CYLINDER]:qe.BOTTOM},showOverTemperature:{[Ne]:!0},showLowLight:{[Ne]:!1},lowLightPower:{[Ce]:{value:Ie,formula:e=>e/5},[Se]:{value:we}},backlash:[]},{LASER_PLANE:y,LASER_CONVEYOR_FEEDER:P,LASER_CYLINDER:S,SUPER_LASER_PLANE:N}=Q,{RED_CROSS:g,LOW_LIGHT:_,RED_DOT:M}=x,{ZERO:C,FIVE:V,TEN:D,TWENTY:F,TWO:he,FORTY:b}=oe,Wt={base:{width:424,height:400,angle:0},data:[{key:`${y}${g}${C}`,width:424,height:400},{key:`${y}${g}${V}`,width:424,height:400},{key:`${y}${g}${D}`,width:424,height:400},{key:`${y}${g}${F}`,width:424,height:390},{key:`${y}${g}${b}`,width:430,height:348},{key:`${y}${_}${C}`,width:430,height:400},{key:`${y}${_}${V}`,width:430,height:400},{key:`${y}${_}${D}`,width:430,height:400},{key:`${y}${_}${F}`,width:430,height:390},{key:`${y}${_}${b}`,width:430,height:369},{key:`${y}${M}${C}`,width:430,height:390},{key:`${y}${M}${he}`,width:430,height:390},{key:`${S}${g}${C}`,width:424,height:400},{key:`${S}${g}${V}`,width:424,height:400},{key:`${S}${g}${D}`,width:424,height:400},{key:`${S}${g}${F}`,width:424,height:390},{key:`${S}${g}${b}`,width:430,height:348},{key:`${S}${_}${C}`,width:430,height:400},{key:`${S}${_}${V}`,width:430,height:400},{key:`${S}${_}${D}`,width:430,height:400},{key:`${S}${_}${F}`,width:430,height:390},{key:`${S}${_}${b}`,width:430,height:369},{key:`${S}${M}${C}`,width:430,height:390},{key:`${S}${M}${he}`,width:430,height:390},{key:`${N}${g}${C}`,width:424,height:930},{key:`${N}${g}${V}`,width:424,height:930},{key:`${N}${g}${D}`,width:424,height:930},{key:`${N}${g}${F}`,width:424,height:930},{key:`${N}${g}${b}`,width:430,height:888},{key:`${N}${_}${C}`,width:430,height:930},{key:`${N}${_}${V}`,width:430,height:930},{key:`${N}${_}${D}`,width:430,height:930},{key:`${N}${_}${F}`,width:430,height:930},{key:`${N}${_}${b}`,width:430,height:909},{key:`${N}${M}${C}`,width:430,height:930},{key:`${N}${M}${he}`,width:430,height:930},{key:`${P}${g}${C}`,width:424,height:3050},{key:`${P}${g}${V}`,width:424,height:3050},{key:`${P}${g}${D}`,width:424,height:3050},{key:`${P}${g}${F}`,width:424,height:3050},{key:`${P}${g}${b}`,width:430,height:3050},{key:`${P}${_}${C}`,width:430,height:3050},{key:`${P}${_}${V}`,width:430,height:3050},{key:`${P}${_}${D}`,width:430,height:3050},{key:`${P}${_}${F}`,width:430,height:3050},{key:`${P}${_}${b}`,width:430,height:3050},{key:`${P}${M}${C}`,width:430,height:3050},{key:`${P}${M}${he}`,width:430,height:3050}]},Z={...Ge,auto_measure:"device.common.auto_measure",focal_length_is_empty:"device.process.focal_length_is_empty",no_tf_card:"device.process.no_tf_card",no_key_lock:"device.process.no_key_lock"},_e={addonCheckLists:["TFCard","UsbKeyLock","processingKey"],rules:{TFCard:{checkKey:"TFCardStatus",correctStatus:!0,ignoreConnectType:["SERIAL"],handler:()=>({type:U.text,text:Z.no_tf_card})},UsbKeyLock:{checkKey:"UsbKeyLockStatus",correctStatus:!0,handler:()=>({type:U.text,text:Z.no_key_lock})},processingKey:{checkKey:"processingKey",wrongStatus:"LASER_CYLINDER400",handler:()=>({type:U.text,text:"device.process.cylinder_red_cross_warning_tip"})}}},Bt={[Q.LASER_PLANE]:{addonStatusRules:_e,collisionRules:{checkSizeType:"totalSize",ignoredDirection:[],handler:()=>({type:U.text,text:Z.element_out_zoom})}},[Q.LASER_CYLINDER]:{addonStatusRules:_e,collisionRules:{checkSizeType:"totalSize",ignoredDirection:["bottom"],handler:()=>({type:U.text,text:Z.element_out_zoom})},integrityDataRules:{requireKeys:["rotateMultiple"],handler:()=>({type:U.text,text:Z.catch_data_empty})}},[Q.SUPER_LASER_PLANE]:{addonStatusRules:_e,collisionRules:{checkSizeType:"totalSize",ignoredDirection:[],handler:()=>({type:U.text,text:Z.element_out_zoom})}}},Yt=[{name:"uploadGcode",type:"set",cmd:e=>e},{name:"enterWalkBorderMode",type:"set",cmd:`M8 N13 
`},{name:"enterProcessingMode",type:"set",cmd:`M8 N11 
`},{name:"stopWalkBorder",type:"set",cmd:`M108 
`},{name:"stopProcessMode",type:"set",cmd:`M8 N1 
`},{name:"setLaserPower",type:"set",cmd:e=>e},{name:"queryKeyLockStatus",type:"get",cmd:"M66",options:{timeout:5e3,dataTransform(e){return!e.includes("S")||e==="S0"}}},{name:"toRedCrossMode",type:"set",cmd:"M97 S0"},{name:"toLowLightMode",type:"set",cmd:"M97 S1"},{name:"setRedCrossOffset",type:"set",cmd:"M98"},{name:"setDeviceName",type:"set",cmd:"M100"},{name:"setFlameAlarm",type:"set",cmd:"M310"},{name:"setFlameAlarmSensitivity",type:"set",cmd:"M309"},{name:"setMoveStop",type:"set",cmd:"M318"},{name:"setTiltStop",type:"set",cmd:"M317"},{name:"setLimitSwitch",type:"set",cmd:"M319"},{name:"setProcessPause",type:"set",cmd:"M22 S1"},{name:"cmd",type:"set",cmd:e=>e},{name:"setStatus",type:"set",cmd:"M8"},{name:"openRedPoint",type:"set",cmd:"M97 S0"},{name:"openPowerApply",type:"set",cmd:"M204 X500 Y40"},{name:"getWorkingSta",type:"get",cmd:"M96",options:{timeout:5e3,dataTransform(e){return!e.includes("N")||e==="N0"}}},{name:"stopProcessing",type:"set",cmd:`M108 
`,options:{timeout:5e3}},{name:"configWifi",type:"set",cmd({data:e}){const{username:s,passwd:o}=e;return`M2001 "${s}" "${o}"`}},{name:"listWifi",type:"get",cmd:"M2000",options:{timeout:1e4,dataTransform(e){let s=e.match(/[^\s\"](.*?)\"/g)||[];return Be(s)||(s=s.slice(1),s=[...new Set(s)],s=s.map(o=>o.slice(0,o.length-1))),s}}},{name:"deviceInfo",type:"get",cmd:["M97","M99","M116","M304","M2002","M98","M310","M318","M319","M100","M309"],options:{timeout:1e4,dataTransform(e){const[s,o,i,n,m,c,u,t,r,a,p]=e,l={};if(s&&(l.gMode=Number(s.replace("S",""))),o&&(l.version=o),i){const[,h]=(i||"0").replace(/X|Y/g,"").split(" ");l.power=Number(h)}if(n&&(l.snCode=n),m&&(l.ip=m),c){const[h="",T=""]=c.split(" ");l.redCrossOffsetX=Number(h.replace("X","")),l.redCrossOffsetY=Number(T.replace("Y",""))}return u&&(l.flameAlarm=Number(u.replace("N",""))),t&&(l.moveStop=Number(t.replace("N",""))),r&&(l.limitSwitch=Number(r.replace("N",""))),a&&(l.name=a),p&&(l.flameAlarmSensitivity=Number(p.replace("N",""))),console.log(["=> info",l]),l}}},{name:"ip",type:"get",cmd:"M2002",options:{timeout:1e4}},{name:"goBorder",type:"set",cmd(e){if(Ye(e))return e;const{x:s=0,y:o=0,z:i=0,width:n=100,height:m=100,power:c=50,speed:u=6e3}=e??{},t=(a=s,p=o,l=i,h=c,T=u)=>`G1 X${a} Y${p} Z${l} S${h} F${T}`;return["M17 S1",t(),t(n,o),t(n,m),t(s,m),t(),"M18"].join(`
`)}}],Ht={id:"D1Pro",name:"xTool D1 Pro",cover:ge.cover,readyImg:ge.readyImg,guidePic:ge.d1TurnOn,productID:"MDP",firmwareContentId:"xcs-d1pro-firmware",canUseSocket:!0,connectType:"wifi",deviceExceptions:Ot,protocols:{network:Ft,serial:Yt},firmware:{shouldHandshake:!1},processingArea:Wt,gcodeHooks:Dt,useCheckButtonInProcess:!0,calculateTime:{accelX:2500,accelY:300,accelU:100,thresholdAngle:175},supportUrls:{firmware:"https://s.xtool.com/doc/d1pro/firmware",faqUrl:"https://s.xtool.com/doc/d1pro/lower-machine-error",laserFaq:"https://s.xtool.com/doc/d1pro/unrecognized-laser-head"},process:Kt,checkRules:Bt,deviceMetaData:At,firmwareSteps:{changeLog:{footer:yt,nextStep:"uploadTurnOn"},uploadTurnOn:{nextStep:"download",content:Lt,footer:Pt},success:{content:St}},showOverTemperature:{[oe.TWO]:!0},showAirAssistSetTip:{[oe.FORTY]:!0}},Ae=Ht,{PREVIEW:Xt,UPLOAD:zt,PROCESSING:jt}=Je;function qt(e,s,o){return[{name:Xt,placeholder:{leftSider:{component:Tt,props:{ext:e,disConnect:o.disConnect,info:o.info,isInProcessing:o.isInProcessing,onChangeLowLight(n){e.settingParams.isLowLight=n.isLowLight,e.settingParams.lightPower=n.lightPower,e.setLowLight({isLowLight:n.isLowLight,lightPower:n.lightPower})},onChangeStartPoint:n=>{e.settingParams.startPointOrder=n+1,e.processParams.startPointId=n}}}}},{name:zt},{name:jt}]}const Jt=(e,s,o)=>{const i={roller:()=>s,catch:()=>ke(o)&&o<32?1.17*Math.PI*o:120};return i[e]&&i[e]()},Oe=({key:e,isFortyWatt:s,rotaryAttachmentType:o,diameter:i})=>e==="VECTOR_CUTTING"?s?60:20:Jt(o,25,i),Zt={LASER_PLANE:{material:0,thickness:null,perimeter:null,diameter:null},LASER_CYLINDER:{material:0,thickness:null,focalLength:null,rotaryAttachmentType:"roller",perimeter:null,diameter:null},PASS_THROUGH:{material:0,thickness:null,focalLength:null,perimeter:null,diameter:null}},Y={DEFAULT:{VECTOR_CUTTING:{max:e=>e?60:20,min:1},VECTOR_ENGRAVING:{max:80,min:1},FILL_VECTOR_ENGRAVING:{max:400,min:1},BITMAP_ENGRAVING:{max:400,min:1},KNIFE_CUTTING:{max:80,min:1}},LASER_CYLINDER:{VECTOR_CUTTING:{max:({isFortyWatt:e,rotaryAttachmentType:s,diameter:o})=>Oe({key:"VECTOR_CUTTING",isFortyWatt:e,rotaryAttachmentType:s,diameter:o}),min:1},VECTOR_ENGRAVING:{max:({isFortyWatt:e,rotaryAttachmentType:s,diameter:o})=>Oe({key:"VECTOR_ENGRAVING",isFortyWatt:e,rotaryAttachmentType:s,diameter:o}),min:1},FILL_VECTOR_ENGRAVING:{max:400,min:1},BITMAP_ENGRAVING:{max:400,min:1},KNIFE_CUTTING:{max:80,min:1}},SUPER_LASER_PLANE:{VECTOR_CUTTING:{max:e=>e?60:20,min:1},VECTOR_ENGRAVING:{max:80,min:1},FILL_VECTOR_ENGRAVING:{max:400,min:1},BITMAP_ENGRAVING:{max:400,min:1},KNIFE_CUTTING:{max:80,min:1}}},Qt=[{type:E.VECTOR_ENGRAVING,label:"line_engrave",color:16421416,fillColor:"#f9932b",isFill:!1,modes:[L.LASER_PLANE,L.LASER_CYLINDER,L.SUPER_LASER_PLANE],imageType:q.VECTOR,components:["ignore","processingType","materialType","power","speed","repeat"]},{type:E.FILL_VECTOR_ENGRAVING,label:"fill_engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[L.LASER_PLANE,L.LASER_CYLINDER,L.SUPER_LASER_PLANE],imageType:q.VECTOR,components:["ignore","processingType","materialType","power","speed","repeat","density","bitmapScanMode"]},{type:E.VECTOR_CUTTING,label:"line_cut",color:10036991,fillColor:"#9928ff",isFill:!1,modes:[L.LASER_PLANE,L.SUPER_LASER_PLANE],imageType:q.VECTOR,components:["ignore","processingType","materialType","power","speed","repeat"]},{type:E.BITMAP_ENGRAVING,label:"engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[L.LASER_PLANE,L.LASER_CYLINDER,L.SUPER_LASER_PLANE],imageType:q.BITMAP,components:["ignore","processingType","materialType","power","speed","repeat","bitmapMode","density","bitmapScanMode"]},{type:E.KNIFE_CUTTING,label:"cut",color:2597107,fillColor:"#27a1f2",isFill:!1,modes:[],imageType:q.VECTOR,components:[]}],es=[{value:L.LASER_PLANE,label:"device.mode.laser_flat",iconName:"ext-laser-plane",components:["deviceMode","material"],processingTypes:e=>e?[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.BITMAP_ENGRAVING]:[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.VECTOR_CUTTING,E.BITMAP_ENGRAVING]},{value:L.LASER_CYLINDER,label:"device.mode.laser_cylindrical",iconName:"ext-laser-cylinder",components:["deviceMode","material","rotaryAttachmentType","catchMode"],processingTypes:[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.BITMAP_ENGRAVING]},{value:L.SUPER_LASER_PLANE,label:"device.mode.super_laser_plane",iconName:"ext-super-laser-plane",components:["deviceMode","material"],processingTypes:e=>e?[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.BITMAP_ENGRAVING]:[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.VECTOR_CUTTING,E.BITMAP_ENGRAVING]}];class ts extends st{onGModeOrPowerChange(s){s.forEach(o=>{const i=this.data.value.get(o);i&&this.updateProcessingArea(o,i.mode)})}}const{RED_DOT:Re,RED_CROSS:$e,LOW_LIGHT:ss}=x,{LASER_CYLINDER:os}=Q;class rs extends ot{constructor(){super(...arguments);w(this,"_startPointId",0);w(this,"_lowLightOpen",!1);w(this,"_lowLightPower",0);w(this,"isMovingLaserHead",!1)}set startPointId(o){this._startPointId=o}set lowLightPower(o){this._lowLightPower=o}set lowLightOpen(o){this._lowLightOpen=o}get startPoint(){const{x:o=0,y:i=0,width:n,height:m}=this.totalSize,c=o+n/2,u=i+m/2,r=[{x:o,y:i},{x:c,y:i},{x:o+n,y:i},{x:o,y:u},{x:c,y:u},{x:o+n,y:u},{x:o,y:i+m},{x:c,y:i+m},{x:o+n,y:i+m}][this._startPointId];return{x:Number(r.x.toFixed(3)),y:Number(r.y.toFixed(3))}}get locateMode(){return this.deviceInfo.power===2?Re:this.deviceInfo.gMode}get needFire(){return this.locateMode===ss&&this._lowLightPower&&this._lowLightOpen&&(this.isWalkBorder||this.isMovingLaserHead)}get isCrossOn(){return[Re,$e].includes(this.locateMode)&&(this.isWalkBorder||this.isMovingLaserHead)}get typeCommand(){const o=rt(this.deviceData);return[os].includes(this.deviceData.mode)?`M102 S${o}`:"M101"}get accel(){const i=this.config.process.buildParams.accel;if(ke(i))return i;if(He(i)){const{list:n,defaultValue:m}=i,c=n.find(u=>Number(u.key)===Number(this.deviceInfo.power));return c?c.value:m}return 2500}parse(){if(!this.deviceData)return;const o=(()=>{const n=(()=>{const m=this.locateMode===$e,c=this.deviceInfo.power;return m&&this.isWalkBorder?{x:this.deviceInfo.redCrossOffsetX,y:this.deviceInfo.redCrossOffsetY}:m&&!this.isWalkBorder?{x:this.deviceInfo.redCrossOffsetX+(c===40?0:-16),y:this.deviceInfo.redCrossOffsetY+(c===40?-21:0)}:{x:0,y:0}})();return{x:this.startPoint.x-n.x,y:this.startPoint.y-n.y}})();return{...super.parse(),typeCommand:this.typeCommand,needFire:this.needFire,crossCommand:this.isCrossOn?"S1":"S0",startPoint:o,lowLightPower:this._lowLightPower,isContinuousLight:this.locateMode===Re,accel:this.accel}}}const{CANCEL:is,ERROR:as,IDLE:ns,WORKING_OFFLINE:cs,WORKING_ONLINE:ls,WORKING:ds,NO_USB_KEY_LOCK:ms,HAVE_USB_KEY_LOCK:ps,USB_KEY_LOCK_ERROR:us}=dt,hs=!0;function Es(e){var s,o,i,n,m;return m=class extends e{constructor(...t){super(Ae,...t);w(this,"processingTypes",Qt);w(this,"processingModes",es);te(this,s,!1);te(this,o,!1);te(this,i,void 0);te(this,n,!1);w(this,"settingParams",{startPointOrder:1,isLowLight:!1,moveSpeed:50,lightPower:3,distance:20});w(this,"deviceDataValues",ht);w(this,"elementDataValues",ut);w(this,"changeWalkBorderParams",()=>{const t=this.config.process.walkBorder,{power:r,speed:a}=t[this.deviceInfo.power]??t.default;this.walkBorderParams={speed:a.default,power:this.deviceInfo.gMode===x.RED_CROSS?0:r.default}});this.addonStatus=Object.assign({},super.addonStatus,{UsbKeyLockStatus:!0,TFCardStatus:!0}),this.deviceData=new ts(Zt,()=>this.speedScope,()=>this.getProcessingModes,this.processingTypes,()=>this.getProcessingArea)}get getProcessingArea(){const t=this.config.processingArea.base,r=[];return this.processingModes.forEach(a=>{const p=this.config.processingArea.data.find(l=>l.key===`${a.value}${this.info.isRedLight?x.RED_DOT:this.info.gMode}${this.info.power}`);p&&r.push({...p,key:a.value})}),{base:t,data:r}}get processingAreaKey(){const{gMode:t,power:r,isRedLight:a}=this.deviceInfo;return`${a?x.RED_DOT:t}${r}`}initProcessParams(t){this.processParams=new rs(t)}get getProcessingModes(){return this.processingModes.map(t=>({...t,processingTypes:se(t.processingTypes)?t.processingTypes(this.info.isRedLight):t.processingTypes}))}get speedScope(){const t=(this.info.power??0)===40;return{DEFAULT:{...Y.DEFAULT,VECTOR_CUTTING:{max:Y.DEFAULT.VECTOR_CUTTING.max(t),min:1}},LASER_CYLINDER:{...Y.LASER_CYLINDER,VECTOR_CUTTING:{max:(r,a)=>Y.LASER_CYLINDER.VECTOR_CUTTING.max({isFortyWatt:t,rotaryAttachmentType:r,diameter:a}),min:1},VECTOR_ENGRAVING:{max:(r,a)=>Y.LASER_CYLINDER.VECTOR_ENGRAVING.max({isFortyWatt:t,rotaryAttachmentType:r,diameter:a}),min:1}},SUPER_LASER_PLANE:{...Y.SUPER_LASER_PLANE,VECTOR_CUTTING:{max:Y.SUPER_LASER_PLANE.VECTOR_CUTTING.max(t),min:1}}}}get useSocket(){const t="40.31.005",{version:r=""}=this.deviceInfo;return Ze(r,t)>0}get ui(){return Nt}async checkDeviceOnline(){const t=super.checkDeviceOnline();if(t)return t;if(!await this.apis.getWorkingSta())return{type:U.text,text:Ge.device_is_working}}checkProcessData({canvasData:t,centralAxisPosition:r,isWalkBorder:a,dataSource:p}){const l=p.currentDeviceData.mode,{power:h,gMode:T}=this.deviceInfo,A=`${l}${h}${T}`;return this.addonStatus={...this.addonStatus,processingKey:A},super.checkProcessData({canvasData:t,centralAxisPosition:r,isWalkBorder:a,dataSource:p})}updateDeviceInfo(t){var h;const r=this.info,a=(t==null?void 0:t.power)===x.RED_DOT;t.gMode=(t==null?void 0:t.gMode)??this.info.gMode;const p=a?x.RED_CROSS:t.gMode;super.updateDeviceInfo(Object.assign(t||{},{isRedLight:a,gMode:p})),a&&((h=this.apis)==null||h.toRedCrossMode(),this.apis.setLaserPower("S0 N0"));const l=()=>{var T;this.settingParams.lightPower=((T=this.config.process.lowLightPower[this.deviceInfo.power])==null?void 0:T.value)||3};r.power!==this.deviceInfo.power&&(console.log("激光头功率发生改变",r.power,"=>",this.deviceInfo.power),this.emit($.BATCH_UPDATE_PROCESSING_AREA),l()),r.gMode!==this.deviceInfo.gMode&&(console.log("定位方式发生改变",r.gMode,"=>",this.deviceInfo.gMode),this.emit($.BATCH_UPDATE_PROCESSING_AREA),this.changeWalkBorderParams())}get projectData(){const t=Xe({id:Ae.productID,power:this.info.power,data:this.deviceData.data.value,materialList:[]});return console.log(["=> getProjectData",t]),t}get isWifiConnect(){return this.connectType===ne.WIFI}getProcessingSteps(t,r){return qt(this,t,r)}async stopWalkBorder(){this.emit($.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!1),await super.stopWalkBorder(),await this.setLowLight({isLowLight:this.settingParams.isLowLight,lightPower:this.settingParams.lightPower})}downloadFirmware(t){return this.connectType===ne.SERIAL?Pe.downloadFirmware({...t,url:t.url[0]}):super.downloadFirmware(t)}updateFirmware(t){var r,a,p;return this.connectType===ne.SERIAL?Pe.updateFirmware({...t,firmwarePath:t.data,baud:115200,port:(r=this.device)==null?void 0:r.connectIdentify}):super.updateFirmware(t,(p=(a=this.config)==null?void 0:a.firmware)==null?void 0:p.shouldHandshake)}async checkFirmwareUpdated(t){return this.connectType===ne.SERIAL?(await Qe(3e3),Promise.resolve(!0)):super.checkFirmwareUpdated(t,{delay:1e3,loopCount:20})}async onConnected(){this.appContext.resetProcessingState();const t=await this.apis.queryKeyLockStatus();this.addonStatus={...this.addonStatus,UsbKeyLockStatus:t};const r=await this.apis.getWorkingSta();if(this.isWifiConnect){const a=await this.apis.getSDCardStatus();this.addonStatus={...this.addonStatus,TFCardStatus:a}}r||this.deviceCmdParsing(j.WORK_OFFLINE)}async uploadGCodeByHttp(t,r){const{onProgress:a,isFullPath:p=!1}=r||{};if(this.uploadGcodeHelper){const{baseUrl:A,url:k,params:O={}}=await this.apis.uploadGcode({method:"info"}),Ee=await this.builder.gcode(t),re=`${A}${k}${it({...O,filetype:1})}`,ee=await this.builder.gcodeHeadAndTail(t);try{return(await super.uploadByBuilder({url:re,path:Ee,options:{isFullPath:p,headCode:ee.headCode,tailCode:ee.tailCode,useFormData:!0,onProgress:H=>{se(a)&&a(H)},onCancel:H=>{R(this,i,H)}}})).result==="ok"?(this.deviceCmdParsing(j.WORK_PREPARED),Promise.resolve(!0)):Promise.reject(!1)}catch(G){return console.log("uploadGcode by builder error",G),Promise.reject(!1)}}const l=await this.builder.gcode(t),{signal:h,cancel:T}=et();return R(this,i,T),await this.apis.uploadGcode({data:{gcode:l},signal:h,url:"?filetype=1",onUploadProgress:A=>{const k=A.loaded/A.total;console.log({complete:k}),se(a)&&a(k)}}),this.deviceCmdParsing(j.WORK_PREPARED),Promise.resolve(!0)}async uploadGCode(t){this.processParams.isWalkBorder=!1,this.processParams.isMovingLaserHead=!1;const r=this.processParams.parse();return this.isWifiConnect?this.uploadGCodeByHttp(r,t):(await this.builder.gcode(r),this.apis.enterProcessingMode(),this.deviceCmdParsing(j.WORK_PREPARED),Promise.resolve(!0))}startProcessing(){return this.uploadGCode()}pauseProcessing(){return this.apis.setProcessPause()}async stopSendGcode(){var t,r;if(this.isWifiConnect)try{const a=Promise.all([(r=this.apis)==null?void 0:r.endProcessing(),this.apis.stopProcessing()]);return this.useSocket||(this.deviceCmdParsing(j.WORK_STOPED),console.log("不支持socket固件版本升级")),R(this,s,!0),a}catch(a){console.log("取消加工错误=>",a)}else return(t=this.device)==null||t.stopReadGcodeFile(),this.apis.stopProcessing()}async cancelProcessing(){const t=await this.stopSendGcode();return this.isWifiConnect||this.apis.stopProcessMode(),t}async startWalkBorder(t){if(console.log("上传走边框gcode",t),this.emit($.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!0),this.isWifiConnect)return this.apis.uploadGcode({data:{gcode:t},url:"?filetype=0"});{await this.apis.enterWalkBorderMode(),t=`M206 
 ${t}`;const r=t.split(`
`).join(":")+`
`;return this.apis.cmd(r)}}cancelUploadGCode(){se(B(this,i))&&B(this,i).call(this)}exportLog(){throw new Error("current device no log.")}getPower(t){let r=t;const{power:a}=this.deviceInfo,p=this.config.process.lowLightPower[a];return p&&p.formula&&(r=p.formula(t)),r}async setLowLight(t){const{isLowLight:r,lightPower:a}=t,p=this.getPower(a),l=Number.MAX_SAFE_INTEGER,h=r?`M9 S${p*10} N${l}`:"M9 S0 N0",T=this.isWifiConnect?{params:{cmd:h}}:h;await this.apis.setLaserPower(T),this.processParams.lowLightOpen=r,this.processParams.lowLightPower=p*10}async movingLaserHead(t){var H;const{mode:r}=(H=this.dataSource)==null?void 0:H.currentDeviceData,a=r===d.LASER_CYLINDER;R(this,o,!1),this.processParams.isMovingLaserHead=!0;const{moveSpeed:p,direction:l,distance:h,lightPower:T}=t,{current:{width:A=0,height:k=0},base:{width:O=0,height:Ee=0}}=this.getCurrentArea(r),re=A||O,ee=k||Ee;let G=[];if(l===J.CENTER)G=[`M205 X${re} Y${ee}`,"M28"],this.setLowLight({isLowLight:!1,lightPower:this.settingParams.lightPower});else{const Ue={[J.BOTTOM]:`Y${a?-h:h}`,[J.LEFT]:`X${-h}`,[J.RIGHT]:`X${h}`,[J.TOP]:`Y${a?h:-h}`}[l],Te=this.processParams.needFire,Le=this.getPower(T);G=["M17 S1","M207 S0",`M106 S${this.processParams.isCrossOn?1:0}`,`M205 X${re} Y${ee}`,`${this.processParams.typeCommand}`,"G92 X0 Y0","G90",`G1 ${Ue} F${p*60} S${Te?Le*10:0}`,"M18"],Te&&G.push(`M9 S${Le*10} N9007199254740991`)}if(this.isWifiConnect)for(const fe of G)await this.apis.cmd({params:{cmd:fe}});else await this.apis.cmd(G.join(`
`)),await this.whenReceiveCmd(f.FINISH_PROCESS);console.log(["移动激光头结束"])}handlerProcessingError(t){if(as.includes(t)){R(this,o,!0);const r=lt.find(({code:a})=>a===t);r&&(this.emit(be.Error,r),this.emit(f.CANCEL_PROCESS),this.stopWalkBorder()),B(this,n)&&(this.stopSendGcode(),console.log("==停止发送gcode==="),R(this,n,!1)),console.log("===设备报错===")}}handlerProcessingUsbKey(t){us.includes(t)&&(R(this,o,!0),R(this,n,!1),console.log("===安全钥匙报错===")),ms.includes(t)&&(this.settingParams.isLowLight=!1,this.emit($.UPDATE_DEVICE_INFO,{isUsbKeyLock:!1}),this.addonStatus={...this.addonStatus,UsbKeyLockStatus:!1},console.log("===没有安全钥匙===")),ps.includes(t)&&(this.emit($.UPDATE_DEVICE_INFO,{isUsbKeyLock:!0}),this.addonStatus={...this.addonStatus,UsbKeyLockStatus:!0},console.log("===有安全钥匙==="))}handlerProcessingFinish(){!this.processParams.isWalkBorder&&!this.processParams.isMovingLaserHead&&(this.processParams.lowLightOpen=!1,this.settingParams.isLowLight=!1)}handlerProcessingEvent(t){const r=mt[t];if(r===f.BEFORE_START&&(R(this,s,!1),R(this,o,!1),console.log("===进入ready状态===")),ls.includes(t)&&(this.apis.uploadGcode({type:"D",name:this.builder.gcodeFileName}),R(this,n,!0),console.log("===串口开始加工===")),ds.includes(t)&&(R(this,s,!1),console.log("串口继续加工")),cs.includes(t)&&(R(this,s,!1),R(this,o,!1),console.log("===离线模式开始加工===")),r===f.PAUSE_PROCESS&&console.log("===设备暂停状态==="),is.includes(t)&&(R(this,s,!0),console.log("===设备加工取消==="),this.emit($.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!1),B(this,n)&&!this.processParams.isWalkBorder&&(this.stopSendGcode(),console.log("==停止发送gcode==="),R(this,n,!1))),this.handlerProcessingError(t),ns.includes(t)&&(this.handlerProcessingFinish(),console.log("===设备加工完成===")),r){B(this,o)||B(this,s)?this.emit($.UPDATE_DEVICE_INFO,{currentStatus:f.CANCEL_PROCESS}):this.emit($.UPDATE_DEVICE_INFO,{currentStatus:r});const a=this.whenReceiveCmdResolveMap.get(r);se(a)&&a(r)}}deviceCmdParsing(t){t=t.replace(/[\r\n]/g,""),console.log("=> d1 pro",t),this.handlerProcessingEvent(t),this.handlerProcessingUsbKey(t)}dispose(){this.deviceData.dispose(),super.dispose()}},s=new WeakMap,o=new WeakMap,i=new WeakMap,n=new WeakMap,m}const Ss=Object.freeze(Object.defineProperty({__proto__:null,DeviceExt:Es,v2:hs},Symbol.toStringTag,{value:"Module"}));export{x as L,J as a,Ss as i};
