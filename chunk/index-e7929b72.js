var Ue=Object.defineProperty;var We=(e,s,o)=>s in e?Ue(e,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[s]=o;var y=(e,s,o)=>(We(e,typeof s!="symbol"?s+"":s,o),o),Le=(e,s,o)=>{if(!s.has(e))throw TypeError("Cannot "+o)};var W=(e,s,o)=>(Le(e,s,"read from private field"),o?o.call(e):s.get(e)),Q=(e,s,o)=>{if(s.has(e))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(e):s.set(e,o)},g=(e,s,o,i)=>(Le(e,s,"write to private field"),i?i.call(e,o):s.set(e,o),o);import{l as ve,_ as b,C as re,b as Be,o as Ke,m as Ge,n as Ye,q as ee,e as He}from"./xcs-canvas-5c2592d6.js";import{bq as T,br as S,bs as Xe,bt as ie,bu as d,bv as ze,bw as J,bx as je,b8 as q,by as $e,bz as qe,bA as Je,bB as v,bC as ae,aV as Pe,bD as Ze,bE as Qe}from"../assets/index-83a10b2e.js";import{k as Me,I as Ve,q as ke,D as De,u as et,a3 as x}from"./xcs-vue-family-70642f71.js";import{D as tt}from"./devicedata-18553816.js";import{B as st,c as ot}from"./params-f8cc805d.js";import{p as rt}from"./urlparam-4b6ed041.js";const it=""+new URL("../assets/cover-6177d8fa.png",import.meta.url).href,at=""+new URL("../assets/d1-ready-b4700482.png",import.meta.url).href,nt=""+new URL("../assets/d1-turn-on-ead43083.png",import.meta.url).href,Ee={cover:it,d1TurnOn:nt,readyImg:at};var F=(e=>(e[e.RED_CROSS=0]="RED_CROSS",e[e.LOW_LIGHT=1]="LOW_LIGHT",e[e.RED_DOT=2]="RED_DOT",e))(F||{}),se=(e=>(e[e.ZERO=0]="ZERO",e[e.TWO=2]="TWO",e[e.FIVE=5]="FIVE",e[e.TEN=10]="TEN",e[e.TWENTY=20]="TWENTY",e[e.FORTY=40]="FORTY",e))(se||{}),X=(e=>(e.WORK_PREPARED="WORK_PREPARED",e.WORK_STARTED="start:workingOnline",e.WORK_CONTINUE="ok:WORKING_ONLINE",e.WORK_OFFLINE="ok:WORKING_OFFLINE",e.WORK_PAUSED="ok:PAUSING",e.WORK_STOPED="WORK_STOPED",e.WORK_STOPED_INSTRUCT1="M314 N3",e.WORK_FINISHED="ok:IDLE",e.WORK_FINISHED_INSTRUCT1="MSG:Pgm End",e.WORK_FINISHED_INSTRUCT2="[MSG:Pgm End]",e.WORK_FINISHED_INSTRUCT3="ok[MSG:Pgm End]",e))(X||{});const G={FLAME:"err:flameCheck",LIMIT:"err:limitCheck",TILT:"err:tiltCheck",MOVING:"err:movingCheck",NO_KEY_LOCK:"M66 S1"},ct=[{code:G.FLAME,msg:"err_flame_check"},{code:G.LIMIT,msg:"err_limit_check"},{code:G.TILT,msg:"err_tilt_check"},{code:G.MOVING,msg:"err_moving_check"},{code:G.NO_KEY_LOCK,msg:"err_key_lock"}],lt={CANCEL:["WORK_STOPED","M314 N3"],OK:["ok","ok512"],IDLE:["ok:IDLE","MSG:Pgm End","ok[MSG:Pgm End]"],WORKING:["ok:WORKING_ONLINE"],WORKING_OFFLINE:["ok:WORKING_OFFLINE"],WORKING_ONLINE:["start:workingOnline"],START_WORKING_OFFLINE:["ok:WORKING_ONLINE_READY"],PAUSING:["ok:PAUSING"],NO_USB_KEY_LOCK:["M66 S1"],HAVE_USB_KEY_LOCK:["M66 S0"],USB_KEY_LOCK_ERROR:["ok:KEY_LOCK_ERROR"],ERROR:["ok:ERROR","ok:TMP_ERROR",G.FLAME,G.MOVING,G.TILT,G.LIMIT]};var L=(e=>(e.LASER_PLANE="LASER_PLANE",e.LASER_CYLINDER="LASER_CYLINDER",e.SUPER_LASER_PLANE="SUPER_LASER_PLANE",e.LASER_CONVEYOR_FEEDER="LASER_CONVEYOR_FEEDER",e))(L||{}),E=(e=>(e.VECTOR_CUTTING="VECTOR_CUTTING",e.VECTOR_ENGRAVING="VECTOR_ENGRAVING",e.FILL_VECTOR_ENGRAVING="FILL_VECTOR_ENGRAVING",e.BITMAP_ENGRAVING="BITMAP_ENGRAVING",e.KNIFE_CUTTING="KNIFE_CUTTING",e))(E||{}),z=(e=>(e.BITMAP="BITMAP",e.VECTOR="VECTOR",e))(z||{}),j=(e=>(e.LEFT="left",e.RIGHT="right",e.TOP="top",e.BOTTOM="bottom",e.CENTER="center",e))(j||{}),Fe=(e=>(e.Error="error",e))(Fe||{});const dt={WORK_PREPARED:T.BEFORE_START,["start:workingOnline"]:T.START_PROCESS,["ok:WORKING_ONLINE"]:T.START_PROCESS,["ok:WORKING_OFFLINE"]:T.START_PROCESS,["ok:PAUSING"]:T.PAUSE_PROCESS,WORK_STOPED:T.CANCEL_PROCESS,["M314 N3"]:T.CANCEL_PROCESS,["ok:IDLE"]:T.FINISH_PROCESS,["MSG:Pgm End"]:T.FINISH_PROCESS,["[MSG:Pgm End]"]:T.FINISH_PROCESS,["ok[MSG:Pgm End]"]:T.FINISH_PROCESS},mt=Me({__name:"ProcessingDataForm",props:{ext:null,deviceInfo:null,elementValues:null,deviceValues:null,selectedTypes:null},setup(e){const s=e,o=()=>{var u;const n=(u=s.deviceInfo)==null?void 0:u.power,m=s.deviceValues.mode,c=s.selectedTypes[0];return ve(be,t=>{const a=!(t.ignorePower||[]).includes(n);return t.imageType===c&&t.modes.includes(m)&&a})},i={[S.VECTOR_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat"],[S.FILL_VECTOR_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat","density","bitmapScanMode"],[S.VECTOR_CUTTING]:["processIgnore","processingType","materialType","power","speed","repeat"],[S.BITMAP_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat","bitmapMode","density","bitmapScanMode"]};return(n,m)=>{const c=Xe;return De(),Ve(c,ke({ext:e.ext,"fields-map":i,"element-values":e.elementValues,"device-values":e.deviceValues,"device-info":e.deviceInfo,"selected-types":e.selectedTypes,"type-options":o},n.$attrs),null,16,["ext","element-values","device-values","device-info","selected-types"])}}}),pt={[S.VECTOR_CUTTING]:{processingLightSource:"blue",power:1,speed:16,repeat:1},[S.VECTOR_ENGRAVING]:{processingLightSource:"blue",power:1,speed:20,repeat:1},[S.FILL_VECTOR_ENGRAVING]:{processingLightSource:"blue",power:1,speed:80,repeat:1,density:100,bitmapScanMode:"zMode"},[S.BITMAP_ENGRAVING]:{processingLightSource:"blue",power:1,speed:80,repeat:1,bitmapMode:"grayscale",density:100,bitmapScanMode:"zMode"}},be=[{value:S.VECTOR_ENGRAVING,label:"device.processing_type.line_engrave",color:16421416,fillColor:"#f9932b",isFill:!1,imageType:ie.VECTOR,modes:[d.LASER_PLANE,d.LASER_CYLINDER,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER]},{value:S.FILL_VECTOR_ENGRAVING,label:"device.processing_type.fill_engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[d.LASER_PLANE,d.LASER_CYLINDER,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER],imageType:ie.VECTOR},{value:S.VECTOR_CUTTING,label:"device.processing_type.line_cut",color:10036991,fillColor:"#9928ff",isFill:!1,modes:[d.LASER_PLANE,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER],imageType:ie.VECTOR,ignorePower:[2]},{value:S.BITMAP_ENGRAVING,label:"device.processing_type.engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[d.LASER_PLANE,d.LASER_CYLINDER,d.PASS_THROUGH,d.SUPER_LASER_PLANE,d.LASER_CONVEYOR_FEEDER],imageType:ie.BITMAP}],ut={[d.LASER_PLANE]:{material:0,thickness:null,perimeter:null,diameter:null},[d.LASER_CYLINDER]:{material:0,thickness:null,rotaryAttachmentType:"roller",perimeter:null,diameter:null},[d.PASS_THROUGH]:{material:0,thickness:null,perimeter:null,diameter:null},[d.PASS_THROUGH]:{material:0,thickness:null,perimeter:null,diameter:null},[d.LASER_CONVEYOR_FEEDER]:{material:0,thickness:null,perimeter:null,diameter:null}},ht=[{icon:"ext-laser-plane",label:"device.mode.laser_flat",value:d.LASER_PLANE},{icon:"ext-laser-cylinder",label:"device.mode.laser_cylindrical",value:d.LASER_CYLINDER},{icon:"ext-super-laser-plane",label:"device.mode.super_laser_plane",value:d.SUPER_LASER_PLANE}],Et=Me({__name:"ProcessingModeForm",props:{ext:null,deviceValues:null,deviceInfo:null,handler:{type:Function}},setup(e){const s=e,o=(c,u)=>{if(c==="mode"){const t=i(u);s.handler(c,{value:u,processingTypeList:t})}else s.handler(c,u)},i=c=>{var r;const u=(r=s.deviceInfo)==null?void 0:r.power,t=c||s.deviceValues.mode;return ve(be,a=>{const l=!(a.ignorePower||[]).includes(u);return a.modes.includes(t)&&l})},n=ht.map(({icon:c,label:u,value:t})=>({icon:c,label:u,value:t})),m={[d.LASER_PLANE]:["mode","material"],[d.LASER_CYLINDER]:["mode","material","rotaryAttachmentType","catchMode"],[d.PASS_THROUGH]:["mode","material"],[d.SUPER_LASER_PLANE]:["mode","material"],[d.LASER_CONVEYOR_FEEDER]:["mode","material"]};return(c,u)=>{const t=ze;return De(),Ve(t,ke({ext:e.ext,"device-values":e.deviceValues,"mode-options":et(n),"device-info":e.deviceInfo,"fields-map":m,handler:o,"process-types":i},c.$attrs),null,16,["ext","device-values","mode-options","device-info"])}}}),gt=x({loader:()=>b(()=>import("./devicesettings-a038eb10.js"),["./devicesettings-a038eb10.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./setting.vue_vue_type_style_index_0_lang-315c55c2.js","./setting.vue_vue_type_script_setup_true_lang-0ee96bfb.js","./modal-c96d5b67.js","./button-00b27872.js","./light-87cce264.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js","./scrollbar-5a89bf25.js","./fade-in.cssr-8e3c8f09.js","./image-bad03660.js","./spin-afa417d1.js","./text-3b674000.js","./light-28752129.js","./checkbox-9495194d.js","./inputnumber-fff11604.js","./headers-069f588a.js","./use-message-cd8b9f19.js"],import.meta.url)}),_t=x({loader:()=>b(()=>import("./walkbordertipmodal-fc01cf96.js"),["./walkbordertipmodal-fc01cf96.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./setting.vue_vue_type_style_index_0_lang-315c55c2.js","./modal-c96d5b67.js","./button-00b27872.js","./light-87cce264.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js","./scrollbar-5a89bf25.js","./fade-in.cssr-8e3c8f09.js","./image-bad03660.js","./spin-afa417d1.js","./text-3b674000.js","./light-28752129.js"],import.meta.url)}),Rt=x({loader:()=>b(()=>import("./walkbordersettings-9b4eee2f.js"),["./walkbordersettings-9b4eee2f.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./headers-069f588a.js","./light-87cce264.js","./light-28752129.js","./devicedata-18553816.js","./params-f8cc805d.js","./urlparam-4b6ed041.js"],import.meta.url)}),ft=x({loader:()=>b(()=>import("./previewleftsider-9e0a13ba.js"),["./previewleftsider-9e0a13ba.js","./setting.vue_vue_type_style_index_0_lang-315c55c2.js","../assets/index-83a10b2e.js","./index-55948043.js","./xcs-vue-family-70642f71.js","./xcs-canvas-5c2592d6.js","./checkbutton.vue_vue_type_script_setup_true_lang-c0bad176.js","./button-00b27872.js","./light-87cce264.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js","./scrollbar-5a89bf25.js","./fade-in.cssr-8e3c8f09.js","./headers-069f588a.js","./light-28752129.js","./element-17c18d0e.js","./inputnumber-fff11604.js","./text-3b674000.js","./grid-9031c693.js","./devicedata-18553816.js","./params-f8cc805d.js","./urlparam-4b6ed041.js"],import.meta.url)}),Tt=x({loader:()=>b(()=>import("./uploadturnon-973f788f.js"),["./uploadturnon-973f788f.js","./xcs-vue-family-70642f71.js","./text-3b674000.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./fade-in.cssr-8e3c8f09.js","./light-28752129.js","./image-bad03660.js","./space-5433d955.js","./use-style-1280d407.js","./scrollbar-5a89bf25.js","../assets/index-83a10b2e.js","./index-55948043.js"],import.meta.url)}),Lt=x({loader:()=>b(()=>import("./changelogbutton-4e88c58e.js"),["./changelogbutton-4e88c58e.js","./xcs-vue-family-70642f71.js","./button-00b27872.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js"],import.meta.url)}),Pt=x({loader:()=>b(()=>import("./uploadturnonfooter-61fe21be.js"),["./uploadturnonfooter-61fe21be.js","./xcs-vue-family-70642f71.js","./button-00b27872.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./space-5433d955.js","./use-style-1280d407.js","./loading-b06a4834.js"],import.meta.url)}),St=x({loader:()=>b(()=>import("./success-b098b420.js"),["./success-b098b420.js","./xcs-vue-family-70642f71.js","./text-3b674000.js","./light-87cce264.js","./xcs-canvas-5c2592d6.js","./fade-in.cssr-8e3c8f09.js","./light-28752129.js","./image-bad03660.js","./space-5433d955.js","./use-style-1280d407.js","./scrollbar-5a89bf25.js","../assets/index-83a10b2e.js","./index-55948043.js"],import.meta.url)}),yt={DeviceSetting:gt,WalkBorderTipModal:_t,WalkBorderSettings:Rt,ProcessingModeForm:Et,ProcessingDataForm:mt},{LASER_PLANE:Nt,LASER_CYLINDER:Ct,SUPER_LASER_PLANE:It}=L,{VECTOR_ENGRAVING:ne,FILL_VECTOR_ENGRAVING:ce,VECTOR_CUTTING:le,BITMAP_ENGRAVING:de}=E,wt={speed:{[Nt]:[{type:ne,min:1,max:80,defaultValue:1},{type:ce,min:1,max:180,defaultValue:1},{type:le,min:1,max:20,defaultValue:1},{type:le,min:1,power:[40],max:60,defaultValue:1},{type:de,min:1,max:180,defaultValue:1}],[Ct]:[{type:ne,roller:!0,min:1,max:25,defaultValue:1},{type:ce,roller:!0,min:1,max:180,defaultValue:1},{type:de,roller:!0,min:1,max:180,defaultValue:1},{type:ne,catch:!0,min:1,max:120,defaultValue:1},{type:ce,catch:!0,min:1,max:180,defaultValue:1},{type:de,catch:!0,min:1,max:180,defaultValue:1}],[It]:[{type:ne,min:1,max:80,defaultValue:1},{type:ce,min:1,max:180,defaultValue:1},{type:le,min:1,max:20,defaultValue:1},{type:le,min:1,max:60,power:[40],defaultValue:1},{type:de,min:1,max:180,defaultValue:1}]},offset:[{power:10,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}},{power:20,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}},{power:40,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}},{power:2,redCross:{x:0,y:-21.8},measure:{x:21.5,y:-21.8}}]},At=[{code:"err:flameCheck",msg:"err_flame_check"},{code:"err:limitCheck",msg:"err_limit_check"},{code:"err:tiltCheck",msg:"err_tilt_check"},{code:"err:movingCheck",msg:"err_moving_check"}],Ot=`# d1 BITMAP HEAD
\${isContinuousLight ? 'M4': ''}
# motion_start
# motionConfig=\${motionConfig}
`,vt=`# d1 BITMAP TAIL
# motion_end
`,Gt=`# d1 HEAD
M17 S1
M207 \${ isWalkBorder ? 'S0':'S1'}
M106 \${crossCommand}
M205 X\${width} Y\${height}
\${typeCommand}
G92 X\${startPoint.x} Y\${startPoint.y}
G0 F9600
G1 F1000
`,$t=`# d1 TAIL
G90
G0 X\${startPoint.x} Y\${startPoint.y}
M18
\${needFire ? 'M9 S'+ lowLightPower + ' N9007199254740991':''}
`,Mt=`
# d1 VECTOR HEAD
\${isContinuousLight ? 'M3': ''}
# motion_start
# motionConfig=\${motionConfig}
G90
`,Vt=`# d1 VECTOR TAIL
# motion_end
`,Y={gCodeTail:$t,gCodeHead:Gt,bitmapHead:Ot,vectorHead:Mt,bitmapTail:vt,vectorTail:Vt},kt={head(e){const{crossCommand:s,size:{w:o,h:i},typeCommand:n,startPoint:m,isWalkBorder:c}=e;return re(Y.gCodeHead)({crossCommand:s,width:o,height:i,typeCommand:n,startPoint:m,isWalkBorder:c})},tail(e){const{needFire:s,startPoint:o,lowLightPower:i}=e;return re(Y.gCodeTail)({needFire:s,lowLightPower:i,startPoint:o})},vectorHead(e){const s=re(Y.vectorHead),{isContinuousLight:o,color:i}=e;return s({isContinuousLight:o,motionConfig:JSON.stringify({color:i})})},vectorTail(){return Y.vectorTail},bitmapHead(e){const s=re(Y.bitmapHead),{isContinuousLight:o,color:i,enableRelative:n}=e;return s({isContinuousLight:o,enableRelative:n,motionConfig:JSON.stringify({color:i})})},bitmapTail(){return Y.bitmapTail}},H=(e,s)=>{let o;try{o=JSON.parse(e)}catch(i){o=s,console.debug("[JSON.parse]",e,i)}return o},Dt=[{name:"progress",url:"/progress"},{name:"version",url:"/system",params:{action:"version"},transformResponse(e){const s=H(e);return s==null?void 0:s.version}},{name:"ping",url:"/ping"},{name:"machineType",url:"/getmachinetype"},{name:"laserPowerType",url:"/getlaserpowertype"},{name:"system",url:"/system",params:{action:"mac"}},{name:"setLaserPower",url:"/cmd",params:{cmd:"M9"}},{name:"toRedCrossMode",url:"/cmd",params:{cmd:"M97 S0"}},{name:"toLowLightMode",url:"/cmd",params:{cmd:"M97 S1"}},{name:"setRedCrossOffset",url:"/cmd",params:{cmd:"M98"}},{name:"openPowerApply",url:"/cmd",params:{cmd:"M204 X500 Y40"}},{name:"queryKeyLockStatus",url:"/system",params:{action:"usb_key_sta"},timeout:5e3,transformResponse(e){const s=H(e);return!s.hasOwnProperty("usb_key_sta")||s.usb_key_sta==="0"}},{name:"setDeviceName",url:"/cmd",params:{cmd:"M100"}},{name:"setProcessPause",url:"/cnc/data",params:{action:"pause"}},{name:"setFlameAlarm",url:"/cmd",params:{cmd:"M310"}},{name:"setFlameAlarmSensitivity",url:"/cmd",params:{cmd:"M309"}},{name:"setTiltStop",url:"/cmd",params:{cmd:"M317"}},{name:"setMoveStop",url:"/cmd",params:{cmd:"M318"}},{name:"setLimitSwitch",url:"/cmd",params:{cmd:"M319"}},{name:"openRedPoint",url:"/cmd",params:{cmd:"M97 S0"}},{name:"stopWalkBorder",url:"/cmd",params:{cmd:"M108"}},{name:"getWorkingSta",url:"/system",params:{action:"get_working_sta"},timeout:5e3,transformResponse(e){const s=H(e);return!s.hasOwnProperty("working")||s.working==="0"}},{name:"getSDCardStatus",url:"/peripherystatus",transformResponse(e){return H(e,{sdCard:0}).sdCard===1}},{name:"cmd",url:"/cmd",params:{cmd:""}},{name:"deviceInfo",timeout:6e3,list:[{url:"/system",params:{action:"get_dev_name"}},{url:"/system",params:{action:"version"}},{url:"/getlaserpowertype"},{url:"/system",params:{action:"dotMode"}},{url:"/system",params:{action:"offset"}},{url:"/peripherystatus"}],transformResult(e){const[s,o,i,n,m,c]=e,u=(s==null?void 0:s.name)||"",t=o==null?void 0:o.version,r=o==null?void 0:o.sn,a=i==null?void 0:i.power,p=n==null?void 0:n.dotMode,l=m.x??0,h=m.y??0,_=c.flameAlarmSensitivity??2,N=c.movingStopFlag??0,U=c.limitStopFlag??0,O={power:a,isRedLight:a===2,gMode:p,redCrossOffsetX:l,redCrossOffsetY:h,flameAlarmSensitivity:_,moveStop:N,limitSwitch:U};return u&&(O.name=u),r&&(O.snCode=r),t&&(O.version=t),console.log(["=> info",O]),O}},{name:"framing",url:"/framing"},{name:"uploadGcode",url:"/cnc/data",type:"post",headers:{"Content-Type":"multipart/form-data"},timeout:0,transformRequest:e=>{const s=new FormData,o=new Blob([e.gcode],{type:"text/plain"});return s.append("tmp.gcode",o),s},transformResponse(e){return H(e,{result:""}).result==="ok"}},{name:"downloadFirmware",responseType:"blob",timeout:0},{name:"updateFirmware",url:"/upgrade",type:"post",headers:{"Content-Type":"multipart/form-data"},timeout:0,transformRequest:e=>{const s=new FormData,o=new Blob([e],{type:"application/macbinary"});return s.append("file",o),s},transformResponse(e){if(typeof e=="string"&&e.toLocaleUpperCase()==="OK")return Promise.resolve(!0);try{return H(e,{result:""}).result.toLocaleUpperCase()==="OK"?Promise.resolve(!0):(console.error(["=> D1 uploadFirmware fail",e]),Promise.resolve(!1))}catch(s){return console.error(["=> D1 uploadFirmware fail",s]),Promise.resolve(!1)}}},{name:"stopProcessing",url:"/cnc/data",params:{action:"stop"}},{name:"endProcessing",url:"/cmd",params:{cmd:`M108 
`}}],{FIVE:Ft,TEN:bt,TWENTY:Se,TWO:ye,FORTY:Ne}=se,Ce=5,Ie=2,me={min:1,max:10,default:3,enable:!0},pe={min:80,max:180,default:160,enable:!0},xt={power:{min:1,max:10,default:10,enable:!1},speed:{min:80,max:180,default:160,enable:!0},enable:!0},Ut={canStopWalkBorder:!0,walkBorder:{default:xt,[Ft]:{power:me,speed:pe,enable:!0},[bt]:{power:me,speed:pe,enable:!0},[Se]:{power:{...me,default:Ie},speed:pe,enable:!0},[Ne]:{power:{...me,default:Ce},speed:pe,enable:!0}},buildParams:{delta:.1,neg_sign:0,swap_xy:0,enableRelative:!0,accel:{defaultValue:2500,list:[{key:2,value:500}]},overScanRequired:!0,finishInOneTime:!1},extendDirection:{[J.LASER_CYLINDER]:je.BOTTOM},showOverTemperature:{[ye]:!0},showLowLight:{[ye]:!1},lowLightPower:{[Ne]:{value:Ce,formula:e=>e*9/50},[Se]:{value:Ie}},backlash:[]},{LASER_PLANE:C,LASER_CONVEYOR_FEEDER:I,LASER_CYLINDER:w,SUPER_LASER_PLANE:A}=J,{RED_CROSS:R,LOW_LIGHT:f,RED_DOT:M}=F,{ZERO:P,FIVE:V,TEN:k,TWENTY:D,TWO:ue}=se,Wt={base:{width:424,height:400,angle:0},data:[{key:`${C}${R}${P}`,width:426,height:403},{key:`${C}${R}${V}`,width:426,height:403},{key:`${C}${R}${k}`,width:426,height:403},{key:`${C}${R}${D}`,width:426,height:393},{key:`${C}${f}${P}`,width:432,height:403},{key:`${C}${f}${V}`,width:432,height:403},{key:`${C}${f}${k}`,width:432,height:403},{key:`${C}${f}${D}`,width:432,height:393},{key:`${C}${M}${P}`,width:432,height:393},{key:`${C}${M}${ue}`,width:432,height:393},{key:`${w}${R}${P}`,width:426,height:403},{key:`${w}${R}${V}`,width:426,height:403},{key:`${w}${R}${k}`,width:426,height:403},{key:`${w}${R}${D}`,width:426,height:393},{key:`${w}${f}${P}`,width:432,height:403},{key:`${w}${f}${V}`,width:432,height:403},{key:`${w}${f}${k}`,width:432,height:403},{key:`${w}${f}${D}`,width:432,height:403},{key:`${w}${M}${P}`,width:430,height:393},{key:`${w}${M}${ue}`,width:432,height:393},{key:`${A}${R}${P}`,width:426,height:930},{key:`${A}${R}${V}`,width:426,height:930},{key:`${A}${R}${k}`,width:426,height:930},{key:`${A}${R}${D}`,width:426,height:930},{key:`${A}${f}${P}`,width:432,height:930},{key:`${A}${f}${V}`,width:432,height:930},{key:`${A}${f}${k}`,width:432,height:930},{key:`${A}${f}${D}`,width:432,height:930},{key:`${A}${M}${P}`,width:430,height:930},{key:`${A}${M}${ue}`,width:432,height:930},{key:`${I}${R}${P}`,width:424,height:3050},{key:`${I}${R}${V}`,width:424,height:3050},{key:`${I}${R}${k}`,width:424,height:3050},{key:`${I}${R}${D}`,width:424,height:3050},{key:`${I}${f}${P}`,width:430,height:3050},{key:`${I}${f}${V}`,width:430,height:3050},{key:`${I}${f}${k}`,width:430,height:3050},{key:`${I}${f}${D}`,width:430,height:3050},{key:`${I}${M}${P}`,width:430,height:3050},{key:`${I}${M}${ue}`,width:430,height:3050}]},te={...$e,auto_measure:"device.common.auto_measure",focal_length_is_empty:"device.process.focal_length_is_empty",no_tf_card:"device.process.no_tf_card",no_key_lock:"device.process.no_key_lock"},ge={addonCheckLists:["TFCard"],rules:{TFCard:{checkKey:"TFCardStatus",correctStatus:!0,ignoreConnectType:["SERIAL"],handler:()=>({type:q.text,text:te.no_tf_card})}}},Bt={[J.LASER_PLANE]:{addonStatusRules:ge,collisionRules:{checkSizeType:"totalSize",ignoredDirection:[],handler:()=>({type:q.text,text:te.element_out_zoom})}},[J.LASER_CYLINDER]:{addonStatusRules:ge,collisionRules:{checkSizeType:"totalSize",ignoredDirection:["bottom"],handler:()=>({type:q.text,text:te.element_out_zoom})},integrityDataRules:{requireKeys:["rotateMultiple"],handler:()=>({type:q.text,text:te.catch_data_empty})}},[J.SUPER_LASER_PLANE]:{addonStatusRules:ge,collisionRules:{checkSizeType:"totalSize",ignoredDirection:[],handler:()=>({type:q.text,text:te.element_out_zoom})}}},Kt=[{name:"uploadGcode",type:"set",cmd:e=>e},{name:"enterWalkBorderMode",type:"set",cmd:`M8 N13 
`},{name:"enterProcessingMode",type:"set",cmd:`M8 N11 
`},{name:"stopWalkBorder",type:"set",cmd:`M108 
`},{name:"stopProcessMode",type:"set",cmd:`M8 N1 
`},{name:"setLaserPower",type:"set",cmd:e=>e},{name:"queryKeyLockStatus",type:"get",cmd:"M66",options:{timeout:5e3,dataTransform(e){return!e.includes("S")||e==="S0"}}},{name:"toRedCrossMode",type:"set",cmd:"M97 S0"},{name:"toLowLightMode",type:"set",cmd:"M97 S1"},{name:"setRedCrossOffset",type:"set",cmd:"M98"},{name:"setDeviceName",type:"set",cmd:"M100"},{name:"setFlameAlarm",type:"set",cmd:"M310"},{name:"setFlameAlarmSensitivity",type:"set",cmd:"M309"},{name:"setMoveStop",type:"set",cmd:"M318"},{name:"setTiltStop",type:"set",cmd:"M317"},{name:"setLimitSwitch",type:"set",cmd:"M319"},{name:"setProcessPause",type:"set",cmd:"M22 S1"},{name:"cmd",type:"set",cmd:e=>e},{name:"setStatus",type:"set",cmd:"M8"},{name:"openRedPoint",type:"set",cmd:"M97 S0"},{name:"openPowerApply",type:"set",cmd:"M204 X500 Y40"},{name:"getWorkingSta",type:"get",cmd:"M96",options:{timeout:5e3,dataTransform(e){return!e.includes("N")||e==="N0"}}},{name:"stopProcessing",type:"set",cmd:`M108 
`,options:{timeout:5e3}},{name:"configWifi",type:"set",cmd({data:e}){const{username:s,passwd:o}=e;return`M2001 "${s}" "${o}"`}},{name:"listWifi",type:"get",cmd:"M2000",options:{timeout:1e4,dataTransform(e){let s=e.match(/[^\s\"](.*?)\"/g)||[];return Be(s)||(s=s.slice(1),s=[...new Set(s)],s=s.map(o=>o.slice(0,o.length-1))),s}}},{name:"deviceInfo",type:"get",cmd:["M97","M99","M116","M304","M2002","M98","M310","M318","M319","M100","M309"],options:{timeout:1e4,dataTransform(e){const[s,o,i,n,m,c,u,t,r,a,p]=e,l={};if(s&&(l.gMode=Number(s.replace("S",""))),o&&(l.version=o),i){const[,h]=(i||"0").replace(/X|Y/g,"").split(" ");l.power=Number(h)}if(n&&(l.snCode=n),m&&(l.ip=m),c){const[h="",_=""]=c.split(" ");l.redCrossOffsetX=Number(h.replace("X","")),l.redCrossOffsetY=Number(_.replace("Y",""))}return u&&(l.flameAlarm=Number(u.replace("N",""))),t&&(l.moveStop=Number(t.replace("N",""))),r&&(l.limitSwitch=Number(r.replace("N",""))),a&&(l.name=a),p&&(l.flameAlarmSensitivity=Number(p.replace("N",""))),console.log(["=> info",l]),l}}},{name:"ip",type:"get",cmd:"M2002",options:{timeout:1e4}},{name:"goBorder",type:"set",cmd(e){if(Ke(e))return e;const{x:s=0,y:o=0,z:i=0,width:n=100,height:m=100,power:c=50,speed:u=6e3}=e??{},t=(a=s,p=o,l=i,h=c,_=u)=>`G1 X${a} Y${p} Z${l} S${h} F${_}`;return["M17 S1",t(),t(n,o),t(n,m),t(s,m),t(),"M18"].join(`
`)}}],Yt={id:"D1",name:"xTool D1",cover:Ee.cover,readyImg:Ee.readyImg,guidePic:Ee.d1TurnOn,productID:"MDP",firmwareContentId:"xcs-d1-firmware",canUseSocket:!0,connectType:"wifi",deviceExceptions:At,protocols:{network:Dt,serial:Kt},firmware:{shouldHandshake:!1},processingArea:Wt,gcodeHooks:kt,useCheckButtonInProcess:!0,calculateTime:{accelX:2500,accelY:300,accelU:100,thresholdAngle:175},supportUrls:{firmware:"https://s.xtool.com/doc/d1/firmware",faqUrl:"https://s.xtool.com/doc/d1/lower-machine-error",laserFaq:"https://s.xtool.com/doc/d1/unrecognized-laser-head"},process:Ut,checkRules:Bt,deviceMetaData:wt,firmwareSteps:{changeLog:{footer:Lt,nextStep:"uploadTurnOn"},uploadTurnOn:{nextStep:"download",content:Tt,footer:Pt},success:{content:St}},showOverTemperature:{[se.TWO]:!0},showAirAssistSetTip:{[se.FORTY]:!0}},we=Yt,{PREVIEW:Ht,UPLOAD:Xt,PROCESSING:zt}=qe;function jt(e,s,o){return[{name:Ht,placeholder:{leftSider:{component:ft,props:{ext:e,disConnect:o.disConnect,info:o.info,isInProcessing:o.isInProcessing,onChangeLowLight(n){e.settingParams.isLowLight=n.isLowLight,e.settingParams.lightPower=n.lightPower,e.setLowLight({isLowLight:n.isLowLight,lightPower:n.lightPower})},onChangeStartPoint:n=>{e.settingParams.startPointOrder=n+1,e.processParams.startPointId=n}}}}},{name:Xt},{name:zt}]}const qt=(e,s,o)=>{const i={roller:()=>s,catch:()=>Ge(o)&&o<32?1.17*Math.PI*o:120};return i[e]&&i[e]()},Ae=({key:e,isFortyWatt:s,rotaryAttachmentType:o,diameter:i})=>e==="VECTOR_CUTTING"?s?60:20:qt(o,25,i),Jt={LASER_PLANE:{material:0,thickness:null,perimeter:null,diameter:null},LASER_CYLINDER:{material:0,thickness:null,focalLength:null,rotaryAttachmentType:"roller",perimeter:null,diameter:null},PASS_THROUGH:{material:0,thickness:null,focalLength:null,perimeter:null,diameter:null}},B={DEFAULT:{VECTOR_CUTTING:{max:e=>e?60:20,min:1},VECTOR_ENGRAVING:{max:80,min:1},FILL_VECTOR_ENGRAVING:{max:400,min:1},BITMAP_ENGRAVING:{max:400,min:1},KNIFE_CUTTING:{max:80,min:1}},LASER_CYLINDER:{VECTOR_CUTTING:{max:({isFortyWatt:e,rotaryAttachmentType:s,diameter:o})=>Ae({key:"VECTOR_CUTTING",isFortyWatt:e,rotaryAttachmentType:s,diameter:o}),min:1},VECTOR_ENGRAVING:{max:({isFortyWatt:e,rotaryAttachmentType:s,diameter:o})=>Ae({key:"VECTOR_ENGRAVING",isFortyWatt:e,rotaryAttachmentType:s,diameter:o}),min:1},FILL_VECTOR_ENGRAVING:{max:400,min:1},BITMAP_ENGRAVING:{max:400,min:1},KNIFE_CUTTING:{max:80,min:1}},SUPER_LASER_PLANE:{VECTOR_CUTTING:{max:e=>e?60:20,min:1},VECTOR_ENGRAVING:{max:80,min:1},FILL_VECTOR_ENGRAVING:{max:400,min:1},BITMAP_ENGRAVING:{max:400,min:1},KNIFE_CUTTING:{max:80,min:1}}},Zt=[{type:E.VECTOR_ENGRAVING,label:"line_engrave",color:16421416,fillColor:"#f9932b",isFill:!1,modes:[L.LASER_PLANE,L.LASER_CYLINDER,L.SUPER_LASER_PLANE],imageType:z.VECTOR,components:["ignore","processingType","materialType","power","speed","repeat"]},{type:E.FILL_VECTOR_ENGRAVING,label:"fill_engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[L.LASER_PLANE,L.LASER_CYLINDER,L.SUPER_LASER_PLANE],imageType:z.VECTOR,components:["ignore","processingType","materialType","power","speed","repeat","density","bitmapScanMode"]},{type:E.VECTOR_CUTTING,label:"line_cut",color:10036991,fillColor:"#9928ff",isFill:!1,modes:[L.LASER_PLANE,L.SUPER_LASER_PLANE],imageType:z.VECTOR,components:["ignore","processingType","materialType","power","speed","repeat"]},{type:E.BITMAP_ENGRAVING,label:"engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[L.LASER_PLANE,L.LASER_CYLINDER,L.SUPER_LASER_PLANE],imageType:z.BITMAP,components:["ignore","processingType","materialType","power","speed","repeat","bitmapMode","density","bitmapScanMode"]},{type:E.KNIFE_CUTTING,label:"cut",color:2597107,fillColor:"#27a1f2",isFill:!1,modes:[],imageType:z.VECTOR,components:[]}],Qt=[{value:L.LASER_PLANE,label:"device.mode.laser_flat",iconName:"ext-laser-plane",components:["deviceMode","material"],processingTypes:e=>e?[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.BITMAP_ENGRAVING]:[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.VECTOR_CUTTING,E.BITMAP_ENGRAVING]},{value:L.LASER_CYLINDER,label:"device.mode.laser_cylindrical",iconName:"ext-laser-cylinder",components:["deviceMode","material","rotaryAttachmentType","catchMode"],processingTypes:[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.BITMAP_ENGRAVING]},{value:L.SUPER_LASER_PLANE,label:"device.mode.super_laser_plane",iconName:"ext-super-laser-plane",components:["deviceMode","material"],processingTypes:e=>e?[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.BITMAP_ENGRAVING]:[E.VECTOR_ENGRAVING,E.FILL_VECTOR_ENGRAVING,E.VECTOR_CUTTING,E.BITMAP_ENGRAVING]}];class es extends tt{onGModeOrPowerChange(s){s.forEach(o=>{const i=this.data.value.get(o);i&&this.updateProcessingArea(o,i.mode)})}}const{RED_DOT:_e,RED_CROSS:Oe,LOW_LIGHT:ts}=F,{LASER_CYLINDER:ss}=J;class os extends st{constructor(){super(...arguments);y(this,"_startPointId",0);y(this,"_lowLightOpen",!1);y(this,"_lowLightPower",0);y(this,"isMovingLaserHead",!1)}set startPointId(o){this._startPointId=o}set lowLightPower(o){this._lowLightPower=o}set lowLightOpen(o){this._lowLightOpen=o}get startPoint(){const{x:o=0,y:i=0,width:n,height:m}=this.totalSize,c=o+n/2,u=i+m/2,r=[{x:o,y:i},{x:c,y:i},{x:o+n,y:i},{x:o,y:u},{x:c,y:u},{x:o+n,y:u},{x:o,y:i+m},{x:c,y:i+m},{x:o+n,y:i+m}][this._startPointId];return{x:Number(r.x.toFixed(3)),y:Number(r.y.toFixed(3))}}get locateMode(){return this.deviceInfo.power===2?_e:this.deviceInfo.gMode}get needFire(){return this.locateMode===ts&&this._lowLightPower&&this._lowLightOpen&&(this.isWalkBorder||this.isMovingLaserHead)}get isCrossOn(){return[_e,Oe].includes(this.locateMode)&&(this.isWalkBorder||this.isMovingLaserHead)}get typeCommand(){const o=ot(this.deviceData);return[ss].includes(this.deviceData.mode)?`M102 S${o}`:"M101"}get accel(){const i=this.config.process.buildParams.accel;if(Ge(i))return i;if(Ye(i)){const{list:n,defaultValue:m}=i,c=n.find(u=>Number(u.key)===Number(this.deviceInfo.power));return c?c.value:m}return 2500}parse(){if(!this.deviceData)return;const o=(()=>{const n=(()=>{const m=this.locateMode===Oe,c=this.deviceInfo.power;return m&&this.isWalkBorder?{x:this.deviceInfo.redCrossOffsetX,y:this.deviceInfo.redCrossOffsetY}:m&&!this.isWalkBorder?{x:this.deviceInfo.redCrossOffsetX+(c===40?0:-16),y:this.deviceInfo.redCrossOffsetY+(c===40?-21:0)}:{x:0,y:0}})();return{x:this.startPoint.x-n.x,y:this.startPoint.y-n.y}})();return{...super.parse(),typeCommand:this.typeCommand,needFire:this.needFire,crossCommand:this.isCrossOn?"S1":"S0",startPoint:o,lowLightPower:this._lowLightPower,isContinuousLight:this.locateMode===_e,accel:this.accel}}}const{CANCEL:rs,ERROR:is,IDLE:as,WORKING_OFFLINE:ns,WORKING_ONLINE:cs,WORKING:ls,NO_USB_KEY_LOCK:ds,HAVE_USB_KEY_LOCK:ms,USB_KEY_LOCK_ERROR:ps}=lt,us=!0;function hs(e){var s,o,i,n,m;return m=class extends e{constructor(...t){super(we,...t);y(this,"processingTypes",Zt);y(this,"processingModes",Qt);Q(this,s,!1);Q(this,o,!1);Q(this,i,void 0);Q(this,n,!1);y(this,"settingParams",{startPointOrder:1,isLowLight:!1,moveSpeed:50,lightPower:3,distance:20});y(this,"deviceDataValues",ut);y(this,"elementDataValues",pt);y(this,"changeWalkBorderParams",()=>{const t=this.config.process.walkBorder,{power:r,speed:a}=t[this.deviceInfo.power]??t.default;this.walkBorderParams={speed:a.default,power:this.deviceInfo.gMode===F.RED_CROSS?0:r.default}});this.addonStatus=Object.assign({},super.addonStatus,{UsbKeyLockStatus:!0,TFCardStatus:!0}),this.deviceData=new es(Jt,()=>this.speedScope,()=>this.getProcessingModes,this.processingTypes,()=>this.getProcessingArea)}get getProcessingArea(){const t=this.config.processingArea.base,r=[];return this.processingModes.forEach(a=>{const p=this.config.processingArea.data.find(l=>l.key===`${a.value}${this.info.isRedLight?F.RED_DOT:this.info.gMode}${this.info.power}`);p&&r.push({...p,key:a.value})}),{base:t,data:r}}get processingAreaKey(){const{gMode:t,power:r,isRedLight:a}=this.deviceInfo;return`${a?F.RED_DOT:t}${r}`}initProcessParams(t){this.processParams=new os(t)}get getProcessingModes(){return this.processingModes.map(t=>({...t,processingTypes:ee(t.processingTypes)?t.processingTypes(this.info.isRedLight):t.processingTypes}))}get speedScope(){const t=(this.info.power??0)===40;return{DEFAULT:{...B.DEFAULT,VECTOR_CUTTING:{max:B.DEFAULT.VECTOR_CUTTING.max(t),min:1}},LASER_CYLINDER:{...B.LASER_CYLINDER,VECTOR_CUTTING:{max:(r,a)=>B.LASER_CYLINDER.VECTOR_CUTTING.max({isFortyWatt:t,rotaryAttachmentType:r,diameter:a}),min:1},VECTOR_ENGRAVING:{max:(r,a)=>B.LASER_CYLINDER.VECTOR_ENGRAVING.max({isFortyWatt:t,rotaryAttachmentType:r,diameter:a}),min:1}},SUPER_LASER_PLANE:{...B.SUPER_LASER_PLANE,VECTOR_CUTTING:{max:B.SUPER_LASER_PLANE.VECTOR_CUTTING.max(t),min:1}}}}get useSocket(){const t="40.30.005",{version:r=""}=this.deviceInfo;return Je(r,t)>0}get ui(){return yt}async checkDeviceOnline(){const t=super.checkDeviceOnline();if(t)return t;if(!await this.apis.getWorkingSta())return{type:q.text,text:$e.device_is_working}}checkProcessData({canvasData:t,centralAxisPosition:r,isWalkBorder:a,dataSource:p}){const l=p.currentDeviceData.mode,{power:h,gMode:_}=this.deviceInfo,N=`${l}${h}${_}`;return this.addonStatus={...this.addonStatus,processingKey:N},super.checkProcessData({canvasData:t,centralAxisPosition:r,isWalkBorder:a,dataSource:p})}updateDeviceInfo(t){var h;const r=this.info,a=(t==null?void 0:t.power)===F.RED_DOT;t.gMode=(t==null?void 0:t.gMode)??this.info.gMode;const p=a?F.RED_CROSS:t.gMode;super.updateDeviceInfo(Object.assign(t||{},{isRedLight:a,gMode:p})),a&&((h=this.apis)==null||h.toRedCrossMode(),this.apis.setLaserPower("S0 N0"));const l=()=>{var _;this.settingParams.lightPower=((_=this.config.process.lowLightPower[this.deviceInfo.power])==null?void 0:_.value)||3};r.power!==this.deviceInfo.power&&(console.log("激光头功率发生改变",r.power,"=>",this.deviceInfo.power),this.emit(v.BATCH_UPDATE_PROCESSING_AREA),l()),r.gMode!==this.deviceInfo.gMode&&(console.log("定位方式发生改变",r.gMode,"=>",this.deviceInfo.gMode),this.emit(v.BATCH_UPDATE_PROCESSING_AREA),this.changeWalkBorderParams())}get projectData(){const t=He({id:we.productID,power:this.info.power,data:this.deviceData.data.value,materialList:[]});return console.log(["=> getProjectData",t]),t}get isWifiConnect(){return this.connectType===ae.WIFI}getProcessingSteps(t,r){return jt(this,t,r)}async stopWalkBorder(){this.emit(v.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!1),await super.stopWalkBorder(),await this.setLowLight({isLowLight:this.settingParams.isLowLight,lightPower:this.settingParams.lightPower})}downloadFirmware(t){return this.connectType===ae.SERIAL?Pe.downloadFirmware({...t,url:t.url[0]}):super.downloadFirmware(t)}updateFirmware(t){var r,a,p;return this.connectType===ae.SERIAL?Pe.updateFirmware({...t,firmwarePath:t.data,baud:115200,port:(r=this.device)==null?void 0:r.connectIdentify}):super.updateFirmware(t,(p=(a=this.config)==null?void 0:a.firmware)==null?void 0:p.shouldHandshake)}async checkFirmwareUpdated(t){return this.connectType===ae.SERIAL?(await Ze(3e3),Promise.resolve(!0)):super.checkFirmwareUpdated(t,{delay:1e3,loopCount:20})}async onConnected(){this.appContext.resetProcessingState();const t=await this.apis.getWorkingSta();if(this.isWifiConnect){const r=await this.apis.getSDCardStatus();this.addonStatus={...this.addonStatus,TFCardStatus:r}}t||this.deviceCmdParsing(X.WORK_OFFLINE)}async uploadGCodeByHttp(t,r){const{onProgress:a,isFullPath:p=!1}=r||{};if(this.uploadGcodeHelper){const{baseUrl:N,url:U,params:O={}}=await this.apis.uploadGcode({method:"info"}),he=await this.builder.gcode(t),oe=`${N}${U}${rt({...O,filetype:1})}`,Z=await this.builder.gcodeHeadAndTail(t);try{return(await super.uploadByBuilder({url:oe,path:he,options:{isFullPath:p,headCode:Z.headCode,tailCode:Z.tailCode,useFormData:!0,onProgress:K=>{ee(a)&&a(K)},onCancel:K=>{g(this,i,K)}}})).result==="ok"?(this.deviceCmdParsing(X.WORK_PREPARED),Promise.resolve(!0)):Promise.reject(!1)}catch($){return console.log("uploadGcode by builder error",$),Promise.reject(!1)}}const l=await this.builder.gcode(t),{signal:h,cancel:_}=Qe();return g(this,i,_),await this.apis.uploadGcode({data:{gcode:l},signal:h,url:"?filetype=1",onUploadProgress:N=>{const U=N.loaded/N.total;ee(a)&&a(U)}}),this.deviceCmdParsing(X.WORK_PREPARED),Promise.resolve(!0)}async uploadGCode(t){this.processParams.isWalkBorder=!1,this.processParams.isMovingLaserHead=!1;const r=this.processParams.parse();return this.isWifiConnect?this.uploadGCodeByHttp(r,t):(await this.builder.gcode(r),this.apis.enterProcessingMode(),this.deviceCmdParsing(X.WORK_PREPARED),Promise.resolve(!0))}startProcessing(){return this.uploadGCode()}pauseProcessing(){return this.apis.setProcessPause()}async stopSendGcode(){var t,r;if(this.isWifiConnect)try{const a=Promise.all([(r=this.apis)==null?void 0:r.endProcessing(),this.apis.stopProcessing()]);return g(this,s,!0),this.useSocket||(this.deviceCmdParsing(X.WORK_STOPED),console.log("不支持socket固件版本升级")),a}catch(a){console.log("取消加工错误=>",a)}else return(t=this.device)==null||t.stopReadGcodeFile(),this.apis.stopProcessing()}async cancelProcessing(){const t=await this.stopSendGcode();return this.isWifiConnect||this.apis.stopProcessMode(),t}async startWalkBorder(t){if(console.log("上传走边框gcode",t),this.emit(v.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!0),this.isWifiConnect)return this.apis.uploadGcode({data:{gcode:t},url:"?filetype=0"});{await this.apis.enterWalkBorderMode(),t=`M206 
 ${t}`;const r=t.split(`
`).join(":")+`
`;return this.apis.cmd(r)}}cancelUploadGCode(){ee(W(this,i))&&W(this,i).call(this)}exportLog(){throw new Error("current device no log.")}getPower(t){let r=t;const{power:a}=this.deviceInfo,p=this.config.process.lowLightPower[a];return p&&p.formula&&(r=p.formula(t)),r}async setLowLight(t){const{isLowLight:r,lightPower:a}=t,p=this.getPower(a),l=Number.MAX_SAFE_INTEGER,h=r?`M9 S${p*10} N${l}`:"M9 S0 N0",_=this.isWifiConnect?{params:{cmd:h}}:h;await this.apis.setLaserPower(_),this.processParams.lowLightOpen=r,this.processParams.lowLightPower=p*10}async movingLaserHead(t){var K;const{mode:r}=(K=this.dataSource)==null?void 0:K.currentDeviceData,a=r===d.LASER_CYLINDER;g(this,o,!1),this.processParams.isMovingLaserHead=!0;const{moveSpeed:p,direction:l,distance:h,lightPower:_}=t,{current:{width:N=0,height:U=0},base:{width:O=0,height:he=0}}=this.getCurrentArea(r),oe=N||O,Z=U||he;let $=[];if(l===j.CENTER)$=[`M205 X${oe} Y${Z}`,"M28"],this.setLowLight({isLowLight:!1,lightPower:this.settingParams.lightPower});else{const xe={[j.BOTTOM]:`Y${a?-h:h}`,[j.LEFT]:`X${-h}`,[j.RIGHT]:`X${h}`,[j.TOP]:`Y${a?h:-h}`}[l],fe=this.processParams.needFire,Te=this.getPower(_);$=["M17 S1","M207 S0",`M106 S${this.processParams.isCrossOn?1:0}`,`M205 X${oe} Y${Z}`,`${this.processParams.typeCommand}`,"G92 X0 Y0","G90",`G1 ${xe} F${p*60} S${fe?Te*10:0}`,"M18"],fe&&$.push(`M9 S${Te*10} N9007199254740991`)}if(this.isWifiConnect)for(const Re of $)await this.apis.cmd({params:{cmd:Re}});else await this.apis.cmd($.join(`
`)),await this.whenReceiveCmd(T.FINISH_PROCESS);console.log(["移动激光头结束"])}handlerProcessingError(t){if(is.includes(t)){g(this,o,!0);const r=ct.find(({code:a})=>a===t);r&&(this.emit(Fe.Error,r),this.emit(T.CANCEL_PROCESS),this.stopWalkBorder()),W(this,n)&&(this.stopSendGcode(),console.log("==停止发送gcode==="),g(this,n,!1)),console.log("===设备报错===")}}handlerProcessingUsbKey(t){ps.includes(t)&&(g(this,o,!0),this.stopSendGcode(),g(this,n,!1),console.log("===安全钥匙报错===")),ds.includes(t)&&(this.emit(v.UPDATE_DEVICE_INFO,{isUsbKeyLock:!1}),this.addonStatus={...this.addonStatus,UsbKeyLockStatus:!1},console.log("===没有安全钥匙===")),ms.includes(t)&&(this.emit(v.UPDATE_DEVICE_INFO,{isUsbKeyLock:!0}),this.addonStatus={...this.addonStatus,UsbKeyLockStatus:!0},console.log("===有安全钥匙==="))}handlerProcessingFinish(){!this.processParams.isWalkBorder&&!this.processParams.isMovingLaserHead&&(this.processParams.lowLightOpen=!1,this.settingParams.isLowLight=!1)}handlerProcessingEvent(t){const r=dt[t];if(r===T.BEFORE_START&&(g(this,s,!1),g(this,o,!1),console.log("===进入ready状态===")),cs.includes(t)&&(this.apis.uploadGcode({type:"D",name:this.builder.gcodeFileName}),g(this,n,!0),console.log("===串口开始加工===")),ls.includes(t)&&(g(this,s,!1),console.log("串口继续加工")),ns.includes(t)&&(g(this,s,!1),g(this,o,!1),console.log("===离线模式开始加工===")),r===T.PAUSE_PROCESS&&console.log("===设备暂停状态==="),rs.includes(t)&&(g(this,s,!0),console.log("===设备加工取消==="),this.emit(v.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!1),W(this,n)&&!this.processParams.isWalkBorder&&(this.stopSendGcode(),console.log("==停止发送gcode==="),g(this,n,!1))),this.handlerProcessingError(t),as.includes(t)&&(this.handlerProcessingFinish(),console.log("===设备加工完成===")),r){W(this,o)||W(this,s)?this.emit(v.UPDATE_DEVICE_INFO,{currentStatus:T.CANCEL_PROCESS}):this.emit(v.UPDATE_DEVICE_INFO,{currentStatus:r});const a=this.whenReceiveCmdResolveMap.get(r);ee(a)&&a(r)}}deviceCmdParsing(t){t=t.replace(/[\r\n]/g,""),console.log("=> d1",t),this.handlerProcessingEvent(t),this.handlerProcessingUsbKey(t)}dispose(){this.deviceData.dispose(),super.dispose()}},s=new WeakMap,o=new WeakMap,i=new WeakMap,n=new WeakMap,m}const Ss=Object.freeze(Object.defineProperty({__proto__:null,DeviceExt:hs,v2:us},Symbol.toStringTag,{value:"Module"}));export{F as L,j as a,Ss as i};
