var Ft=Object.defineProperty;var Bt=(n,t,i)=>t in n?Ft(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i;var M=(n,t,i)=>(Bt(n,typeof t!="symbol"?t+"":t,i),i),qe=(n,t,i)=>{if(!t.has(n))throw TypeError("Cannot "+i)};var R=(n,t,i)=>(qe(n,t,"read from private field"),i?i.call(n):t.get(n)),G=(n,t,i)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,i)},b=(n,t,i,e)=>(qe(n,t,"write to private field"),e?e.call(n,i):t.set(n,i),i);import{C as $t,a as zt}from"./index-17630698.js";import{bQ as Fe,bJ as je,bK as Je,bw as ae,bq as Z,bM as Ve,bx as E,b8 as X,by as Yt,b7 as ft,br as O,bt as Me,bu as v,bs as Xt,_ as Be,bB as D,bv as Wt,bE as Ht,bC as Pe,cb as Kt,bR as Qe,bS as qt,bU as jt}from"../assets/index-83a10b2e.js";import{b as Jt,c as Qt,L as gt,C as Lt,S as vt,d as es,M as ts,e as ss,D as se,Z as os,E as Ie,f as De,g as as,h as is,i as et,j as Ae,k as le,R as we,l as tt,m as st,n as ns,o as rs,p as cs,q as ls}from"./constant-2a798a0e.js";import{C as ue,A as Ne,l as yt,i as ds,m as us,o as ot,q as Ce,r as ms,Y as ps,e as hs,w as fs}from"./xcs-canvas-5c2592d6.js";import{k as Q,f as T,I as ie,J as A,u as L,D as U,j as S,G as I,K as Se,ak as Mt,a6 as gs,q as wt,E as Ee,L as Ls,F as Ct,ac as vs,ad as ys,r as _t,b as _e,c as Ms,w as St,o as ws,M as at,y as xt,H as Cs}from"./xcs-vue-family-70642f71.js";import{N as Et}from"./divider-c77484ad.js";import{c as _s,X as Rt}from"./modal-c96d5b67.js";import{g as $e,a as bt,_ as Pt,b as Ss,c as it,d as xs}from"./laserposition.vue_vue_type_script_setup_true_lang-86881cde.js";import{S as oe}from"./setting.vue_vue_type_style_index_0_lang-315c55c2.js";import{N as de}from"./button-00b27872.js";import{N as nt}from"./space-5433d955.js";import{N as Es}from"./text-3b674000.js";import{N as Rs}from"./image-bad03660.js";import{B as bs}from"./params-f8cc805d.js";import{d as Ps}from"./image-c9c8ff8c.js";import"./index-55948043.js";import"./light-87cce264.js";import"./scrollbar-5a89bf25.js";import"./use-style-1280d407.js";import"./fade-in.cssr-8e3c8f09.js";import"./spin-afa417d1.js";import"./loading-b06a4834.js";import"./light-28752129.js";var $,K,q,j,J,pe,he;class Is{constructor(t){G(this,$,void 0);G(this,K,"");G(this,q,"");G(this,j,"");G(this,J,"");G(this,pe,void 0);G(this,he,void 0);b(this,$,t)}clean(){b(this,K,""),b(this,q,""),b(this,j,""),b(this,J,"")}get localImgData(){return R(this,pe)}set localImgData(t){b(this,pe,t)}get globalImageData(){return R(this,he)}set globalImageData(t){b(this,he,t)}set apis(t){b(this,$,t)}async getLocalCalibrationData(){return R(this,K)||b(this,K,await R(this,$).getLocalCalibrationData()),R(this,K)}async getGlobalCalibrationData(){return R(this,q)||b(this,q,await R(this,$).getGlobalCalibrationData()),R(this,q)}async getLocalIrData(){return R(this,J)||b(this,J,await R(this,$).getLocalIrData()),R(this,J)}async getGlobalIrData(){return R(this,j)||b(this,j,await R(this,$).getGlobalIrData()),R(this,j)}}$=new WeakMap,K=new WeakMap,q=new WeakMap,j=new WeakMap,J=new WeakMap,pe=new WeakMap,he=new WeakMap;class Ds{constructor(t){M(this,"name");M(this,"type",Fe);M(this,"createDisplayFn");M(this,"viewport");M(this,"container");M(this,"rect");this.name=t}async init(t){this.viewport=t}destroy(){this.container.destroy(!0)}initViewportDisplay(t){return this.createDisplayFn=t,this.createContainer(),this.createRect(),this.container.addChild(this.rect),this.container}createContainer(){this.container=this.createDisplayFn("RECT")}createRect(){this.rect=this.createDisplayFn("RECT",{width:10,height:10,scale:{x:1,y:1},lineColor:16711680})}updateRect(t){const{x:i=this.rect.x,y:e=this.rect.y,width:s=this.rect.width,height:o=this.rect.height}=t;this.rect.position.set(i,e),this.rect.width=s,this.rect.height=o}}const As=""+new URL("../assets/cover-9554b4dd.png",import.meta.url).href,Ts=""+new URL("../assets/d2-ready-3656cc4b.png",import.meta.url).href,Os=""+new URL("../assets/multiPoint-a41a8eb4.png",import.meta.url).href,xe={cover:As,readyImg:Ts,multiPoint:Os},{LASER_PLANE:Vs,LASER_CYLINDER:Ns}=Jt,{VECTOR_ENGRAVING:Te,FILL_VECTOR_ENGRAVING:ee,VECTOR_CUTTING:Gs,BITMAP_ENGRAVING:te}=Qt,ks={speed:{[Vs]:[{type:Te,min:1,max:300,defaultValue:1},{type:ee,min:1,max:400,power:[10],defaultValue:1},{type:ee,min:1,max:600,power:[2,20,40],defaultValue:1},{type:Gs,min:1,max:300,defaultValue:1},{type:te,min:1,max:400,power:[10],defaultValue:1},{type:te,min:1,max:600,power:[2,20,40],defaultValue:1}],[Ns]:[{type:Te,roller:!0,min:1,max:25,defaultValue:1},{type:ee,roller:!0,min:1,power:[10],max:400,defaultValue:1},{type:ee,roller:!0,min:1,power:[2,20,40],max:160,defaultValue:1},{type:te,roller:!0,min:1,power:[10],max:400,defaultValue:1},{type:te,roller:!0,min:1,power:[2,20,40],max:600,defaultValue:1},{type:Te,catch:!0,min:1,max:120,defaultValue:1},{type:ee,catch:!0,min:1,power:[10],max:600,defaultValue:1},{type:ee,catch:!0,min:1,power:[2,20,40],max:600,defaultValue:1},{type:te,catch:!0,min:1,power:[10],max:400,defaultValue:1},{type:te,catch:!0,min:1,power:[2,20,40],max:600,defaultValue:1}]}},me="M363 S3",Ge="M363 S0",ke="M363 S2",Zs=[{code:"M222 S4",msg:"err_moving_check",title:"加工过程中移动"},{code:"M222 S7",msg:"",title:"无加工文件情况下启动加工，未关闭上盖进行加工"},{code:"M222 S8",msg:"",title:"SD 卡异常或损坏"},{code:"M222 S9",msg:"err_flame_check",title:"检测到火焰"},{code:"M53 C1",msg:"",title:"底板/增高架左边松动"},{code:"M53 C2",msg:"",title:"底板/增高架右边松动"},{code:"M53 C3",msg:"",title:"底板/增高架全部松动"},{code:ke,msg:"",title:"对焦模块硬件异常"},{code:Ge,msg:"",title:"对焦模块未正常安装或运动过程中脱落"},{code:"M363 S4",msg:"",title:"测量异常，请检查对焦模块"},{code:me,msg:"",title:"对焦模块未复位异常"},{code:"M8",msg:"",title:"电机驱动芯片报错"}],{RED_DOT:rt,RED_CROSS:ct,LOW_LIGHT:Us}=gt,{LASER_CYLINDER:Fs,LASER_PLANE:Bs}=ae;var fe,ge,Le;class $s extends bs{constructor(){super(...arguments);G(this,fe,0);G(this,ge,!1);G(this,Le,0)}set startPointId(i){b(this,fe,i)}set lowLightPower(i){b(this,Le,i)}set lowLightOpen(i){b(this,ge,i)}get startPoint(){const{x:i=0,y:e=0,width:s,height:o}=this.totalSize,a=i+s/2,r=e+o/2,c=[{x:i,y:e},{x:a,y:e},{x:i+s,y:e},{x:i,y:r},{x:a,y:r},{x:i+s,y:r},{x:i,y:e+o},{x:a,y:e+o},{x:i+s,y:e+o}][R(this,fe)];return{x:Number(c.x.toFixed(3)),y:Number(c.y.toFixed(3))}}get locateMode(){return this.deviceInfo.power===2?rt:this.deviceInfo.gMode}get needFire(){return this.locateMode===Us&&R(this,Le)&&R(this,ge)&&this.isWalkBorder}get isCrossOn(){return[rt,ct].includes(this.locateMode)&&this.isWalkBorder}get offset(){const{gMode:i,power:e}=this.deviceInfo;if(i===ct){const s=$e(e),o=bt(s);return this.isWalkBorder?{x:o.x*-1,y:o.y*-1}:{x:0,y:0}}return{x:0,y:0}}parse(){const{data:i,mode:e}=this.deviceData,s=super.parse();switch(s.deviceInfo=this.deviceInfo,i[e].focalLength&&(s.focalLen=(i[e].focalLength??0)+2),s.offset=this.offset,s.isRedLight=this.deviceInfo.power===2,s.originPoint=this.deviceInfo.laserPosition||{x:0,y:0},s.isWalkBorder=this.isWalkBorder,this.deviceData.mode){case Bs:{s.id=0,s.funcName=je.plane;break}case Fs:{s.swap_xy=0,s.id=7,s.start.x=(s.start.x||0)+s.offset.x,s.start.y=this.totalSize.y,s.rotateMultiple&&(s.rotateMultiple=Number((s.rotateMultiple*-1).toFixed(1))),s.funcName=je.cylinder,s.funcArgs=[this.totalSize.y+(this.isWalkBorder?s.offset.y:0),this.totalSize.y,s.rotateMultiple],this.isWalkBorder&&(s.offset.y=0),s.keys=[Je.x,Je.u];break}}return s}}fe=new WeakMap,ge=new WeakMap,Le=new WeakMap;const lt="M222 ",Ze={S0:"",S1:Z.IDLE,S2:"",S3:"",S10:"",S11:Z.FRAME_READY,S12:Z.FRAME_WORKING,S13:Z.BEFORE_START,S14:Z.START_PROCESS,S15:Z.PAUSE_PROCESS,S18:Z.CANCEL_PROCESS,S19:Z.FINISH_PROCESS,S16:"",S17:Z.SLEEP},zs=["S11","S12","S13","S14","S15","S18","S19"],Ys=new RegExp("X(-?\\d*\\.?\\d+)"),Xs=new RegExp("Y(-?\\d*\\.?\\d+)"),Ws=new RegExp("Z(-?\\d*\\.?\\d+)"),Hs=new RegExp("U(-?\\d*\\.?\\d+)"),It=(n="")=>{const t=n.match(Ys),i=n.match(Xs),e=n.match(Ws),s=n.match(Hs);return{x:t?parseFloat(t[1]):void 0,y:i?parseFloat(i[1]):void 0,z:e?parseFloat(e[1]):void 0,u:s?parseFloat(s[1]):void 0}},k=(n,t)=>{if(!n)return;const i=new RegExp(`${t}(-?\\d*\\.?\\d+)`),e=n.match(i);return e?parseFloat(e[1]):void 0},ze=(n,t)=>{const i=[];return t.forEach(e=>{i.push(k(n,e))}),i},dt=n=>{console.log({str:n});try{return JSON.parse(n)}catch{return n}},Ks=n=>{const[t,i]=ze(n,["X","Y"]);return{x:t,y:i}};function Dt(n){const t={label:"device.setting.red_cross",value:0};return n!==2?[t,{label:"device.setting.laser_spot",value:1}]:[t]}function ut(n,t,i){return n===!1?[]:[i||i===0?i:Lt,t||t===0?t:vt]}function qs(n){const[t,i,e]=ze(n,["S","X","Y"]);return{index:t,x:i,y:e}}const js=`# D2 BITMAP START
\${powerMode}
\${!isWalkBorder && (gear|| gear===0) ? 'M15 S'+gear: ''}
\${enableRelative?'G90':''}
\${startY? 'G0 Y' + startY : ''}
\${enableRelative?'G91':''}
`,Js=`# motion_end
# D2 BITMAP END
`,Qs=`
# D2 HEAD
M110 X1 Y1 Z1
M109 S1
M7 S1
M96 S0
G90
G0 F9600
G1 F1000
G0Z0
# motion_start
# motionConfig=\${motionConfig}

\${motionCode}

# motion_end

G90
G0X0Y0
G0 Z0
M5
M6
`,eo=`# D2 HEAD
M110 X1 Y1 Z1
M109 S1
M223 X\${size.w} Y\${size.h}
\${!isWalkBorder ? 'M7 S1': ''}
M96 \${isOpenCross ? 'S1' : 'S0'}
G90
G0X\${originPoint.x}Y\${originPoint.y}
G0 F9600
G1 F1000
G0Z0
`,to=`G90
G0X\${originPoint.x}Y\${originPoint.y}
G0U0
G0Z0
<% if(enableLaserSpot) { %>
G1S10
<% } %>
M6
# D2 TAIL
`,so=`# VECTOR START
G90
\${powerMode}
\${!isWalkBorder && (gear|| gear===0) ? 'M15 S'+gear: ''}
`,oo=`# motion_end
# VECTOR TAIL
`,W={gCodeTail:to,gCodeHead:eo,bitmapHead:js,vectorHead:so,bitmapTail:Js,vectorTail:oo,curveVector:Qs},{VECTOR_CUTTING:ao}=Ve,io={head(n){const{isWalkBorder:t=!1,crossCommand:i,size:{w:e,h:s},typeCommand:o,startPoint:a,deviceInfo:r,originPoint:d}=n,c=ue(W.gCodeHead);return console.log({params:n,deviceInfo:r}),c({...n,isWalkBorder:t,isOpenCross:t&&(r==null?void 0:r.gMode)===0,crossCommand:i,width:e,height:s,typeCommand:o,startPoint:a,originPoint:d})},tail(n){const{originPoint:t}=n;return ue(W.gCodeTail)({...n,enableLaserSpot:!1,...n.deviceInfo,originPoint:t})},vectorHead(n){const{groupKey:t,isRedLight:i}=n,{cutAirAssist:e,scoreAirAssist:s,airAssist:o}=n.deviceInfo,[a,r]=ut(o,s,e),d=t===ao;return n.gear=d?a:r,n.powerMode=i||d?"M3":"M4",ue(W.vectorHead)(n)},vectorTail(){return W.vectorTail},bitmapHead(n){const{cutAirAssist:t,scoreAirAssist:i,airAssist:e}=n.deviceInfo,[,s]=ut(e,i,t);return n.gear=s,n.startY=n.start.y,n.powerMode="M4",ue(W.bitmapHead)(n)},bitmapTail(){return W.bitmapTail}},no=n=>{try{const[t,i,e="",s,o,a,r]=n,d=JSON.parse(t),{M100:c,M222:l,M99:u="",M1199:f="",M2099:g="",M97:C="",M116:_="",M321:m,M27:h,M13:x=0,M98:V,M310:z="XXX-XXXX-XXXX"}=d;console.log({flameAlarm:s});const[F,N=0,B]=ze(_,["X","Y","B"]),ve=[{contentId:"xcs-d2-0x20",contentVersion:u},{contentId:"xcs-d2-0x21",contentVersion:f},{contentId:"xcs-d2-0x22",contentVersion:g}];return{ip:dt(i||""),name:dt(c||""),power:N,snCode:z,laserType:F,laserProducer:B,redCrossOffsetX:k(V,"X"),redCrossOffsetY:k(V,"Y"),moveStop:k(e,"N")===1,showVersion:Ne(ve,"contentVersion").join(`
`),version:ve,coord:It(h),fillLight:k(x,"A"),sdCard:k(m,"S"),gMode:k(C,"S"),flameAlarm:k(s,"A"),airAssist:k(a,"A")===1,currentStatus:Ze[l],enableLaserSpot:o!=="S0",xTouchResetPos:Ks(r)}}catch(t){console.error(t)}},At=[{name:"cancelPrint",type:"get",cmd:"M108",options:{timeout:5e3}},{name:"pausePrint",type:"set",cmd:"M22 S1"},{name:"resumeProcessing",type:"set",cmd:"M22 S0"},{name:"ip",type:"get",cmd:"M2002"},{name:"listWifi",type:"get",cmd:"M2000",options:{timeout:1e4,paramsTransform(){return"N2"},dataTransform(n){try{const t=JSON.parse(n);return console.log({res:t,data:n}),Object.keys(t)}catch{return[]}}}},{name:"configWifi",type:"set",cmd({data:n}){const{username:t,passwd:i}=n;return`M2001 "${t}" "${i}"`},options:{timeout:3e3}},{name:"setDeviceName",type:"set",cmd(n){return`M100 "${n}"`}},{name:"deviceInfo",type:"get",cmd:["M2003","M2002","M318","M340","M36","M15","M366"],options:{timeout:3e3,dataTransform(n){return no(n)}}},{name:"setFileTransferStatus",type:"get",cmd:"M325"},{name:"setFrameStatus",type:"get",cmd:"M206"},{name:"getLaserCoord",type:"get",cmd:"M303",options:{dataTransform(n){return It(n)}}},{name:"setGMode",type:"set",cmd(n){return`M97 S${n}
M96 S${n===0?1:0}`}},{name:"setFillLight",type:"set",cmd:"M13"},{name:"redCrossOffset",type:"set",cmd:"M98"},{name:"toggleLaser",type:"set",cmd({power:n,isOpen:t}){return console.log({power:n,isOpen:t}),t?`M109 S1
M36 S${n}`:`M109 S0
M36 S0`}},{name:"toggleDebugMode",type:"set",cmd(n){return`M802 S${n?1:0}
M346 S1`}},{name:"moveLaser",type:"set",cmd({dir:n,val:t,speed:i}){return`G91
M110 X1 Y1 Z1
G0 ${n}${t} F${i}`}},{name:"moveLaserToZero",type:"set",cmd:"M111 S7"},{name:"moveLaserXYToZero",type:"set",cmd:"M111 S3"},{name:"moveLaserZToZero",type:"set",cmd:"M111 S2"},{name:"checkXTouchStatu",type:"get",cmd:"M362"},{name:"moveToPoint",type:"set",cmd({x:n,y:t,speed:i}){return["M110 X1 Y1 Z1",`G90
G0 X${n.toFixed(3)} Y${t.toFixed(3)} F${i}`].join(`
`)}},{name:"startMeasure",type:"get",cmd:"M311 S0"},{name:"enterMeasureMode",type:"get",cmd:"M312 S1",options:{timeout:3e3}},{name:"exitMeasureMode",type:"get",cmd:"M312 S0",options:{timeout:3e3}},{name:"moveToResetFocusModel",type:"set",cmd({x:n,y:t,speed:i}){return n=n||516,`G90
G0 X${n} Y${t} F${i}`}},{name:"resetFocusModel",type:"set",cmd:`M311 R0
`},{name:"airAssistCloseDelay",type:"set",cmd:"M1099"},{name:"moveStop",type:"set",cmd:"M318"},{name:"flameAlarm",type:"set",cmd:"M340 S1"},{name:"enterUpgradeMode",type:"set",cmd:"M22 S3"},{name:"enterMultiPointMode",type:"set",cmd:"M22 S4"},{name:"exitMultiPointMode",type:"set",cmd:"M108"},{name:"exitUpgradeMode",type:"set",cmd:"M108"}],ro=At.map(n=>n).concat([{name:"uploadGcode",url:"/upload",type:"post",headers:{"Content-Type":"multipart/form-data"},timeout:0,transformRequest:n=>{const t=new FormData,i=new Blob([n.gcode],{type:"text/plain"});return t.append("frame.gcode",i),t}},{name:"beforeUploadGCode",cmd:"M322",timeout:3e3},{name:"afterUploadGCode",cmd:"M323",timeout:3e3}]),co={power:{min:1,max:10,default:10,enable:!1},speed:{min:80,max:180,default:160,enable:!0},enable:!0},lo={items:[{name:"power",label:"device.common.power",widget:"slider",widgetAttrs:{size:"small",min:1,max:10}},{name:"speed",label:"device.common.speed",widget:"slider",widgetAttrs:{size:"small"}},{name:"redCross",label:"device.setting.position_mode",widget:"radio",widgetAttrs:{size:"small",options:[{label:"device.setting.red_cross",value:0},{label:"device.setting.laser_spot",value:1}]}}]},Tt={canStopWalkBorder:!0,showTotalTime:!1,walkBorder:{formConfig:lo,default:co},buildParams:{delta:.1,neg_sign:0,swap_xy:0,enableRelative:!0,accel:2500,overScanRequired:!0},extendDirection:{[ae.LASER_CYLINDER]:E.BOTTOM}},{TEN:uo,TWENTY:mo,TWO:po,FORTY:ho}=es,fo={base:{width:508,height:330,angle:0},data:[{key:`${po}`,width:508,height:308},{key:`${uo}`,width:508,height:335},{key:`${mo}`,width:508,height:330},{key:`${ho}`,width:508,height:308}]},H={...Yt,auto_measure:"device.common.auto_measure",focal_length_is_empty:"device.process.focal_length_is_empty",no_tf_card:"device.process.no_tf_card"},mt={addonCheckLists:["TFCard"],rules:{TFCard:{checkKey:"TFCardStatus",ignoreConnectType:["SERIAL"],correctStatus:!0,handler:()=>({type:X.text,text:H.no_tf_card})}}},go={[ae.LASER_PLANE]:{addonStatusRules:mt,collisionRules:{checkSizeType:"totalSize",ignoredDirection:[],handler:()=>({type:X.text,text:H.element_out_zoom})},integrityDataRules:{requireKeys:["focalLen"],handler:(n,t)=>{if(!t.isWalkBorder)return{type:X.text,text:H.focal_length_is_empty}}}},[ae.LASER_CYLINDER]:{addonStatusRules:mt,collisionRules:{checkSizeType:"totalSize",ignoredDirection:["right"],handler:()=>({type:X.text,text:H.element_out_zoom})},integrityDataRules:{requireKeys:["rotateMultiple","focalLen"],handler:(n,t)=>n==="focalLen"?t.isWalkBorder?void 0:{type:X.text,text:H.focal_length_is_empty}:{type:X.text,text:H.catch_data_empty}}},[ae.CURVE_PROCESS]:{collisionRules:{checkSizeType:"totalSize",ignoredDirection:[],handler:()=>({type:X.text,text:H.element_out_zoom})}}},Lo={enable:!0,values:{power:1,speed:300,mode:"rect",gMode:0,laserSpot:1,autoStart:!1,enableLaserSpot:!1}},vo={id:"D2",name:"xTool D2",cover:xe.cover,readyImg:xe.readyImg,productID:"MD2",firmwareContentId:"xcs-d2-firmware",canUseSocket:!0,dataFromSocket:!0,connectType:"serialport",deviceExceptions:Zs,protocols:{network:ro,serial:At},processingArea:fo,gcodeHooks:io,calculateTime:{accelX:2500,accelY:300,accelU:100,thresholdAngle:175},supportUrls:{firmware:"https://s.xtool.com/doc/d2/firmware",faqUrl:"https://s.xtool.com/doc/d2/lower-machine-error",laserFaq:"https://s.xtool.com/doc/d2/unrecognized-laser-head"},process:Tt,checkRules:go,walkBorder:Lo,deviceMetaData:ks},yo=vo,Mo={style:{"z-index":"2",background:"var(--n-color-modal)"},class:"text-lg pb-4 text-base sticky top-0"},wo={style:{"z-index":"2",background:"var(--n-color-modal)"},class:"text-lg pb-4 text-base sticky top-0"},Co=Q({__name:"DeviceSettings",props:{show:{type:Boolean},laserFaq:null,info:null,checkUpdateFirmware:{type:Function},exportLog:{type:Function},exportGcode:{type:Function}},emits:["close","showWifiConfig","showConnector"],setup(n,{emit:t}){const i=n,e=Mt(),s=()=>{t("close"),t("showConnector")},o=[{name:"name",label:"device.setting.name",widget:"input",widgetAttrs:{maxlength:50,size:"small"}},{name:"power",label:"device.setting.model",widget:"text",widgetAttrs:{format(m){return`${m}w`}},suffix:{widget:"button",label:"device.setting.unrecognized_laser_faq",widgetAttrs:{text:!0,size:"small"}}},{name:"snCode",label:"device.setting.serial_num",widget:"text"},{name:"showVersion",label:"device.setting.firmware_version",widget:"text",widgetAttrs:{style:"white-space: pre"},suffix:{name:"checkFirmware",label:"device.setting.check_firmware",widget:"button",widgetAttrs:{value:"device.setting.check_firmware",size:"small"}}},{name:"ip",label:"device.connect.wifi_config",widget:"text",suffix:{name:"configWifi",label:"device.connect.wifi_config_button_label",widget:"button",widgetAttrs:{size:"small"}}}],a=T(()=>[{name:"gcode",label:"device.setting.export_gcode",suffix:{name:"exportGCode",label:"device.common.export",widget:"button",widgetAttrs:{size:"small"}},inline:!0},{name:"gMode",label:"device.setting.position_mode",widget:"radioGroup",widgetAttrs:{options:Dt(i.info.power),defaultValue:0}},{name:"redCrossOffset",label:"device.setting.red_cross_offset",childs:[{name:"redCrossOffsetX",widget:"number",widgetAttrs:{max:100,step:1,size:"small",prefix:"X",suffix:"mm",defaultValue:0}},{max:100,step:1,name:"redCrossOffsetY",widget:"number",widgetAttrs:{size:"small",prefix:"Y",suffix:"mm",defaultValue:0}}]},{name:"flameAlarm",label:"device.setting.flame_alarm",widget:"radioGroup",widgetAttrs:{options:[{value:0,label:"device.setting.high_sensitivity"},{value:1,label:"device.setting.low_sensitivity"},{value:2,label:"device.setting.not_show_sensitivity_again"}],defaultValue:void 0}},{name:"moveStop",label:"device.setting.stop_move",widget:"switch",widgetAttrs:{size:"small"},inline:!0},{name:"airAssistCloseDelay",label:"device.setting.purifier_timeout",widget:"number",widgetAttrs:{size:"small",suffix:"S",style:"width: 5em",step:1,min:0,max:600,defaultValue:10},inline:!0},{name:"fillLight",label:"补光灯亮度",widget:"number",widgetAttrs:{size:"small",suffix:"%",style:"width: 5em",min:0,max:100,defaultValue:10},inline:!0},{name:"airAssist",label:"空气辅助自动调节",widget:"switch",value:i.info.airAssist,widgetAttrs:{disabled:!i.info.airAssist},inline:!0},{name:"cutAirAssist",label:"切割",widget:"radioGroup",widgetAttrs:{options:[{value:0,label:"0"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:4,label:"4"}],defaultValue:Lt,disabled:!i.info.airAssist},inline:!0},{name:"scoreAirAssist",label:"雕刻",widget:"radioGroup",widgetAttrs:{options:[{value:0,label:"0"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:4,label:"4"}],defaultValue:vt,disabled:!i.info.airAssist},inline:!0}]),r={name(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.setDeviceName(m)},gMode(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.setGMode(m)},redCrossOffsetX(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.redCrossOffset(`X${m}`)},redCrossOffsetY(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.redCrossOffset(`Y${m}`)},fillLight(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.setFillLight(`A${m}B${m}`)},configWifi(){t("close"),t("showWifiConfig")},checkFirmware(){return i.checkUpdateFirmware()},exportGCode(){return i.exportGcode()},flameAlarm(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.flameAlarm(`A${m}`)},moveStop(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.moveStop(`N${m===!0?1:0}`)},airAssistCloseDelay(m){var h;return(h=e.getters.ext.apis)==null?void 0:h.airAssistCloseDelay(`T${m}`)},airAssist(m){return m},scoreAirAssist(m){return m},cutAirAssist(m){return m}},d=(m,h)=>{if(console.log({key:m,value:h}),m in r){const x=r[m](h);return x instanceof Promise?x.then(()=>{e.getters.ext.deviceInfo={[m]:h}}):(e.getters.ext.deviceInfo={[m]:h},x)}},c=Ne(o,"name"),l=Ne(a.value,"name"),u=m=>{const h={};return m.forEach(x=>{h[x]=i.info[x]}),h},f=T(()=>u(c)),g=T(()=>u([...l,"redCrossOffsetX","redCrossOffsetY","flameAlarmSensitivity"])),C=(...m)=>{const[h,x]=m;return f[h]=x,d(h,x)},_=async(...m)=>{const[h,x]=m;return g[h]=x,d(h,x)};return(m,h)=>{const x=ft,V=gs("x-settings");return U(),ie(L(_s),{style:{width:"640px",height:"480px"},preset:"card","header-style":"position: absolute; right: 0; z-index: 2; padding: 1rem","content-style":"padding: 0; height: 100%",show:n.show,onClose:h[0]||(h[0]=z=>m.$emit("close")),onEsc:h[1]||(h[1]=z=>m.$emit("close"))},{default:A(()=>[S(V,{meta:{cover:n.info.cover,name:n.info.name,onShowConnector:s}},{default:A(()=>[I("h3",Mo,Se(m.$t("device.setting.basic")),1),S(x,{items:o,values:L(f),handler:C},null,8,["values"]),S(L(Et)),I("h3",wo,Se(m.$t("device.setting.work_info")),1),S(x,{items:L(a),values:L(g),handler:_},null,8,["items","values"])]),_:1},8,["meta"])]),_:1},8,["show"])}}}),_o={[O.VECTOR_CUTTING]:{processingLightSource:"blue",power:1,speed:16,repeat:1,cuttingDrop:!1},[O.VECTOR_ENGRAVING]:{processingLightSource:"blue",power:1,speed:20,repeat:1},[O.FILL_VECTOR_ENGRAVING]:{processingLightSource:"blue",power:1,speed:80,repeat:1,density:100,bitmapScanMode:"zMode"},[O.BITMAP_ENGRAVING]:{processingLightSource:"blue",power:1,speed:80,repeat:1,bitmapMode:"grayscale",density:100,bitmapScanMode:"zMode"}},Ot=[{value:O.VECTOR_ENGRAVING,label:"device.processing_type.line_engrave",color:16421416,fillColor:"#f9932b",isFill:!1,imageType:Me.VECTOR,modes:[v.LASER_PLANE,v.LASER_CYLINDER,v.CURVE_PROCESS,v.LASER_CYLINDER_CURVED_SURFACE]},{value:O.FILL_VECTOR_ENGRAVING,label:"device.processing_type.fill_engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[v.LASER_PLANE,v.LASER_CYLINDER,v.CURVE_PROCESS,v.LASER_CYLINDER_CURVED_SURFACE],imageType:Me.VECTOR},{value:O.VECTOR_CUTTING,label:"device.processing_type.line_cut",color:10036991,fillColor:"#9928ff",isFill:!1,modes:[v.LASER_PLANE,v.CURVE_PROCESS,v.LASER_CYLINDER_CURVED_SURFACE],imageType:Me.VECTOR,ignorePower:[2]},{value:O.BITMAP_ENGRAVING,label:"device.processing_type.engrave",color:16421416,fillColor:"#f9932b",isFill:!0,modes:[v.LASER_PLANE,v.CURVE_PROCESS,v.LASER_CYLINDER,v.LASER_CYLINDER_CURVED_SURFACE],imageType:Me.BITMAP}],So=Q({__name:"ProcessingDataForm",props:{ext:null,deviceInfo:null,elementValues:null,deviceValues:null,selectedTypes:null},setup(n){const t=n,i=()=>{var c;const a=(c=t.deviceInfo)==null?void 0:c.power,r=t.deviceValues.mode,d=t.selectedTypes[0];return yt(Ot,l=>{const f=!(l.ignorePower||[]).includes(a);return l.imageType===d&&l.modes.includes(r)&&f})},e={name:"cuttingDrop",label:"切割下沉",widget:"radioGroup",widgetAttrs:{options:[{label:"device.common.on",value:!0},{label:"device.common.off",value:!1}]}},s={name:"cuttingDropValue",label:"下沉距离",widget:"number",widgetAttrs:{size:"tiny",suffix:"mm",min:1,max:6,style:{flex:"auto",width:"78px"}},defaultValue:3,visible:a=>!!a.cuttingDrop,inline:!0},o={[O.VECTOR_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat"],[O.FILL_VECTOR_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat","density","bitmapScanMode"],[O.VECTOR_CUTTING]:["processIgnore","processingType","materialType","power","speed","repeat",e,s],[O.BITMAP_ENGRAVING]:["processIgnore","processingType","materialType","power","speed","repeat","bitmapMode","density","bitmapScanMode"]};return(a,r)=>{const d=Xt;return U(),ie(d,wt({ext:n.ext,"fields-map":o,"element-values":n.elementValues,"device-values":n.deviceValues,"device-info":n.deviceInfo,"selected-types":n.selectedTypes,"type-options":i},a.$attrs),null,16,["ext","element-values","device-values","device-info","selected-types"])}}}),xo="M12 -0.176389L22 -0.176389L22 0.176389L12 0.176389L12 -0.176389ZM27 -0.176389L37 -0.176389L37 0.176389L27 0.176389L27 -0.176389ZM42 -0.176389L52 -0.176389L52 0.176389L42 0.176389L42 -0.176389ZM57 -0.176389L67 -0.176389L67 0.176389L57 0.176389L57 -0.176389ZM72 -0.176389L82 -0.176389L82 0.176389L72 0.176389L72 -0.176389ZM87 -0.176389L97 -0.176389L97 0.176389L87 0.176389L87 -0.176389ZM102 -0.176389L112 -0.176389L112 0.176389L102 0.176389L102 -0.176389ZM117 -0.176389L127 -0.176389L127 0.176389L117 0.176389L117 -0.176389ZM132 -0.176389L142 -0.176389L142 0.176389L132 0.176389L132 -0.176389ZM147 -0.176389L157 -0.176389L157 0.176389L147 0.176389L147 -0.176389ZM162 -0.176389L172 -0.176389L172 0.176389L162 0.176389L162 -0.176389ZM177 -0.176389L187 -0.176389L187 0.176389L177 0.176389L177 -0.176389ZM192 -0.176389L202 -0.176389L202 0.176389L192 0.176389L192 -0.176389ZM207 -0.176389L217 -0.176389L217 0.176389L207 0.176389L207 -0.176389ZM222 -0.176389L232 -0.176389L232 0.176389L222 0.176389L222 -0.176389ZM237 -0.176389L247 -0.176389L247 0.176389L237 0.176389L237 -0.176389ZM252 -0.176389L262 -0.176389L262 0.176389L252 0.176389L252 -0.176389ZM267 -0.176389L277 -0.176389L277 0.176389L267 0.176389L267 -0.176389ZM282 -0.176389L292 -0.176389L292 0.176389L282 0.176389L282 -0.176389ZM297 -0.176389L307 -0.176389L307 0.176389L297 0.176389L297 -0.176389ZM312 -0.176389L322 -0.176389L322 0.176389L312 0.176389L312 -0.176389ZM327 -0.176389L337 -0.176389L337 0.176389L327 0.176389L327 -0.176389ZM342 -0.176389L352 -0.176389L352 0.176389L342 0.176389L342 -0.176389ZM357 -0.176389L367 -0.176389L367 0.176389L357 0.176389L357 -0.176389ZM372 -0.176389L382 -0.176389L382 0.176389L372 0.176389L372 -0.176389ZM387 -0.176389L397 -0.176389L397 0.176389L387 0.176389L387 -0.176389ZM402 -0.176389L412 -0.176389L412 0.176389L402 0.176389L402 -0.176389ZM417 -0.176389L427 -0.176389L427 0.176389L417 0.176389L417 -0.176389ZM432 -0.176389L442 -0.176389L442 0.176389L432 0.176389L432 -0.176389ZM447 -0.176389L457 -0.176389L457 0.176389L447 0.176389L447 -0.176389ZM462 -0.176389L472 -0.176389L472 0.176389L462 0.176389L462 -0.176389ZM477 -0.176389L487 -0.176389L487 0.176389L477 0.176389L477 -0.176389ZM492 -0.176389L502 -0.176389L502 0.176389L492 0.176389L492 -0.176389ZM507 -0.176389L508.176 -0.176389L508.176 9L507.824 9L507.824 0L508 0L508 0.176389L507 0.176389L507 -0.176389ZM508.176 14L508.176 24L507.824 24L507.824 14L508.176 14ZM508.176 29L508.176 39L507.824 39L507.824 29L508.176 29ZM508.176 44L508.176 54L507.824 54L507.824 44L508.176 44ZM508.176 59L508.176 69L507.824 69L507.824 59L508.176 59ZM508.176 74L508.176 84L507.824 84L507.824 74L508.176 74ZM508.176 89L508.176 99L507.824 99L507.824 89L508.176 89ZM508.176 104L508.176 114L507.824 114L507.824 104L508.176 104ZM508.176 119L508.176 129L507.824 129L507.824 119L508.176 119ZM508.176 134L508.176 144L507.824 144L507.824 134L508.176 134ZM508.176 149L508.176 159L507.824 159L507.824 149L508.176 149ZM508.176 164L508.176 174L507.824 174L507.824 164L508.176 164ZM508.176 179L508.176 189L507.824 189L507.824 179L508.176 179ZM508.176 194L508.176 204L507.824 204L507.824 194L508.176 194ZM508.176 209L508.176 219L507.824 219L507.824 209L508.176 209ZM508.176 224L508.176 234L507.824 234L507.824 224L508.176 224ZM508.176 239L508.176 249L507.824 249L507.824 239L508.176 239ZM508.176 254L508.176 264L507.824 264L507.824 254L508.176 254ZM508.176 269L508.176 279L507.824 279L507.824 269L508.176 269ZM508.176 284L508.176 294L507.824 294L507.824 284L508.176 284ZM508.176 299L508.176 309L507.824 309L507.824 299L508.176 299ZM504 310.176L494 310.176L494 309.824L504 309.824L504 310.176ZM489 310.176L479 310.176L479 309.824L489 309.824L489 310.176ZM474 310.176L464 310.176L464 309.824L474 309.824L474 310.176ZM459 310.176L449 310.176L449 309.824L459 309.824L459 310.176ZM444 310.176L434 310.176L434 309.824L444 309.824L444 310.176ZM429 310.176L419 310.176L419 309.824L429 309.824L429 310.176ZM414 310.176L404 310.176L404 309.824L414 309.824L414 310.176ZM399 310.176L389 310.176L389 309.824L399 309.824L399 310.176ZM384 310.176L374 310.176L374 309.824L384 309.824L384 310.176ZM369 310.176L359 310.176L359 309.824L369 309.824L369 310.176ZM354 310.176L344 310.176L344 309.824L354 309.824L354 310.176ZM339 310.176L329 310.176L329 309.824L339 309.824L339 310.176ZM324 310.176L314 310.176L314 309.824L324 309.824L324 310.176ZM309 310.176L299 310.176L299 309.824L309 309.824L309 310.176ZM294 310.176L284 310.176L284 309.824L294 309.824L294 310.176ZM279 310.176L269 310.176L269 309.824L279 309.824L279 310.176ZM264 310.176L254 310.176L254 309.824L264 309.824L264 310.176ZM249 310.176L239 310.176L239 309.824L249 309.824L249 310.176ZM234 310.176L224 310.176L224 309.824L234 309.824L234 310.176ZM219 310.176L209 310.176L209 309.824L219 309.824L219 310.176ZM204 310.176L194 310.176L194 309.824L204 309.824L204 310.176ZM189 310.176L179 310.176L179 309.824L189 309.824L189 310.176ZM174 310.176L164 310.176L164 309.824L174 309.824L174 310.176ZM159 310.176L149 310.176L149 309.824L159 309.824L159 310.176ZM144 310.176L134 310.176L134 309.824L144 309.824L144 310.176ZM129 310.176L119 310.176L119 309.824L129 309.824L129 310.176ZM114 310.176L104 310.176L104 309.824L114 309.824L114 310.176ZM99 310.176L89 310.176L89 309.824L99 309.824L99 310.176ZM84 310.176L74 310.176L74 309.824L84 309.824L84 310.176ZM69 310.176L59 310.176L59 309.824L69 309.824L69 310.176ZM54 310.176L44 310.176L44 309.824L54 309.824L54 310.176ZM39 310.176L29 310.176L29 309.824L39 309.824L39 310.176ZM24 310.176L14 310.176L14 309.824L24 309.824L24 310.176ZM9 310.176L-0.176389 310.176L-0.176389 309L0.176389 309L0.176389 310L0 310L0 309.824L9 309.824L9 310.176ZM-0.176389 304L-0.176389 294L0.176389 294L0.176389 304L-0.176389 304ZM-0.176389 289L-0.176389 279L0.176389 279L0.176389 289L-0.176389 289ZM-0.176389 274L-0.176389 264L0.176389 264L0.176389 274L-0.176389 274ZM-0.176389 259L-0.176389 249L0.176389 249L0.176389 259L-0.176389 259ZM-0.176389 244L-0.176389 234L0.176389 234L0.176389 244L-0.176389 244ZM-0.176389 229L-0.176389 219L0.176389 219L0.176389 229L-0.176389 229ZM-0.176389 214L-0.176389 204L0.176389 204L0.176389 214L-0.176389 214ZM-0.176389 199L-0.176389 189L0.176389 189L0.176389 199L-0.176389 199ZM-0.176389 184L-0.176389 174L0.176389 174L0.176389 184L-0.176389 184ZM-0.176389 169L-0.176389 159L0.176389 159L0.176389 169L-0.176389 169ZM-0.176389 154L-0.176389 144L0.176389 144L0.176389 154L-0.176389 154ZM-0.176389 139L-0.176389 129L0.176389 129L0.176389 139L-0.176389 139ZM-0.176389 124L-0.176389 114L0.176389 114L0.176389 124L-0.176389 124ZM-0.176389 109L-0.176389 99L0.176389 99L0.176389 109L-0.176389 109ZM-0.176389 94L-0.176389 84L0.176389 84L0.176389 94L-0.176389 94ZM-0.176389 79L-0.176389 69L0.176389 69L0.176389 79L-0.176389 79ZM-0.176389 64L-0.176389 54L0.176389 54L0.176389 64L-0.176389 64ZM-0.176389 49L-0.176389 39L0.176389 39L0.176389 49L-0.176389 49ZM-0.176389 34L-0.176389 24L0.176389 24L0.176389 34L-0.176389 34ZM-0.176389 19L-0.176389 9L0.176389 9L0.176389 19L-0.176389 19ZM-0.176389 4L-0.176389 -0.176389L7 -0.176389L7 0.176389L0 0.176389L0 0L0.176389 0L0.176389 4L-0.176389 4Z";class Eo{constructor(t){M(this,"name");M(this,"type",Fe);M(this,"container");M(this,"viewport");M(this,"viewportDisplay");M(this,"createDisplayFn");M(this,"crossIconOffset",{x:0,y:0});M(this,"laserIcon");M(this,"crossIcon");M(this,"dashRect");this.name=t}createIcon(){const t=this.createDisplayFn("PATH",{dPath:"M33 17.9a1 1 0 0 1-1-1v-15c0-.4-.4-.7-.7-.7H18c-.3 0-.6.3-.6.7v15c0 .5-.5 1-1 1h-15c-.3 0-.6.3-.6.6V32c0 .3.3.6.7.6h14.9c.5 0 1 .5 1 1v15c0 .4.3.7.6.7h13.3c.3 0 .6-.3.6-.7v-15c0-.5.5-1 1-1h15c.3 0 .6-.3.6-.6V18.5c0-.3-.3-.6-.7-.6H33Z",isFill:!0});t.parseJSON({lineColor:14423100,fillColor:14423100}),t.width=.5,t.height=.5;const{width:i,height:e}=t.getLocalBounds();return t.pivot.set(i/2,e/2),t}createDashRect(){const t=this.createDisplayFn("PATH",{dPath:xo,isFill:!0});return t.parseJSON({lineColor:9737364,fillColor:9737364}),t.interactive=!1,t}createCircle(){const t=this.createDisplayFn("CIRCLE",{width:10,height:10,scale:{x:1,y:1},isFill:!0,lineColor:48894,fillColor:48894}),{width:i,height:e}=t.getLocalBounds();return t.pivot.set(i/2,e/2),t.position.set(0,0),t}createContainer(){const t=this.createDisplayFn("RECT");return t.interactive=!1,t}async init(t){this.viewport=t}initViewportDisplay(t){var a;this.createDisplayFn=t;const i=this.createCircle(),e=this.createIcon(),s=this.createDashRect(),o=this.createContainer();return this.container=o,this.crossIcon=e,this.laserIcon=i,this.dashRect=s,this.container.addChild(i,s,e),this.updateIcon({x:0,y:0}),this.updateIconScale((a=this.viewport)==null?void 0:a.scale),this.crossIcon.visible=!1,this.dashRect.visible=!1,this.laserIcon.visible=!1,this.container}initIconEvent(){let t=!1;const i=this.laserIcon;i&&(i.on("pointerdown",e=>{e.stopPropagation(),t=!0}),i.cursor="move",i.on("pointermove",e=>{const s=e.data.getLocalPosition(this.viewport);t&&i.position.set(s.x,s.y)}),i.on("pointerup",()=>{t=!1}))}onViewportScale(t){this.updateIconScale(t.scale)}destroy(){this.container.destroy(!0)}updateCrossIconOffset(t){this.crossIconOffset=t;const{worldWidth:i,worldHeight:e}=this.viewport||{};i&&e&&(this.dashRect.width=i-t.x,this.dashRect.height=e-t.y)}updateIcon(t){this.laserIcon.position.set(t.x,t.y),this.crossIcon.position.set(t.x+this.crossIconOffset.x,t.y+this.crossIconOffset.y),this.dashRect.position.set(this.crossIconOffset.x,this.crossIconOffset.y)}updateIconScale(t={x:1,y:1}){this.laserIcon.scale.set(1/t.x,1/t.y),this.crossIcon.scale.set(.2/t.x,.2/t.y)}switchIcon(t){t===0&&(this.crossIcon.visible=!0,this.dashRect.visible=!0,this.laserIcon.visible=!1),t===1&&(this.crossIcon.visible=!1,this.dashRect.visible=!1,this.laserIcon.visible=!0)}}const Vt=n=>(vs("data-v-b031f62f"),n=n(),ys(),n),Ro={class:"wrapper"},bo={class:"left-side"},Po=["src"],Io={class:"right-side"},Do=Vt(()=>I("div",{class:"right-side-item"}," 请挪动激光头，通过两点标记预设加工范围。 每确定一个点，点按设备按键完成标定 ",-1)),Ao=Vt(()=>I("div",{style:{"font-weight":"500"},class:"right-side-item"}," 标记点的坐标位置 ",-1)),To={style:{"margin-left":"5px","":"0.8rem"}},Oo=Q({__name:"MultiPointModal",props:{visible:{type:Boolean},points:null},emits:["close","confirm"],setup(n,{emit:t}){const i=n,e=!0,s=T(()=>[{label:"确定",type:"primary",disabled:Object.values(i.points).length<2,onClick:()=>{t("confirm")}}]),o=a=>a?`x:${a.x} y:${a.y}`:"坐标未获取";return(a,r)=>(U(),ie(L(Rt),{closable:e,show:i.visible,footer:L(s),title:"测量加工区域",onClose:r[0]||(r[0]=d=>a.$emit("close"))},{default:A(()=>[I("div",Ro,[I("div",bo,[I("img",{src:L(xe).multiPoint},null,8,Po)]),I("div",Io,[Do,Ao,(U(),Ee(Ct,null,Ls(2,d=>I("div",{key:`mark${d}`,size:0,class:"right-side-item"},[S(L(oe),{class:"mark-icon",name:i.points[`${d}`]?"marked":"unmark"},null,8,["name"]),I("span",To,Se(o(i.points[`${d}`])),1)])),64))])])]),_:1},8,["show","footer"]))}});const Vo=Be(Oo,[["__scopeId","data-v-b031f62f"]]),No={[v.LASER_PLANE]:{material:0,focalLength:null},[v.LASER_CYLINDER]:{material:0,focalLength:null,rotaryAttachmentType:"roller",perimeter:null,diameter:null},[v.CURVE_PROCESS]:{material:0,measureWidth:10,measureHeight:10,measureRowCount:3,measureColCount:3},[v.LASER_CYLINDER_CURVED_SURFACE]:{material:0,measureWidth:10,measureHeight:10,measureRowCount:3,measureColCount:3}},Go=[{icon:"ext-laser-plane",label:"device.mode.laser_flat",value:v.LASER_PLANE},{icon:"ext-laser-cylinder",label:"device.mode.laser_cylindrical",value:v.LASER_CYLINDER},{icon:"ext-curve-process",value:v.CURVE_PROCESS,label:"device.mode.curve_process"}],ko=Q({__name:"ProcessingModeForm",props:{ext:null,canvasId:null,deviceValues:null,deviceInfo:null,handler:{type:Function},isInProcessing:{type:Boolean},disConnect:{type:Boolean},isFrameMode:{type:Boolean}},setup(n){var We;const t=n,i="d2-canvas-plugin";let e=_t({});const s=_e(!1),o=()=>new Promise((p,y)=>{const w={x:0,y:0,width:0,height:0,alpha:0,angle:0,showStar:!0};t.ext.emit("MARK_POSITION",w),t.ext.once("MARK_POSITION_DONE",P=>{P?p(P):y("cancel mark point.")})});Ms(()=>{var p;(p=t.ext.dataSource)==null||p.on(D.SET_CURVE_PREVIEW_DISABLED,x)});const a=_e(!1),r=T(()=>t.isFrameMode===!1&&t.isInProcessing===!1&&t.disConnect===!1);St(()=>t.canvasId,()=>{var y;const p=(y=t.ext.customData)==null?void 0:y.getData(`${t.canvasId}.showCoord`);p&&(a.value=p)},{immediate:!0}),ws(()=>{var p;(p=t.ext.dataSource)==null||p.off(D.SET_CURVE_PREVIEW_DISABLED,x)});const d=p=>{const{index:y,x:w,y:P}=p;e[`${y}`]={x:w,y:P}},c={async measureDistance(){var w,P;if(!await((w=t.ext)==null?void 0:w.deviceChecker([se.X_TOUCH])))return;const{z:y}=await((P=t.ext)==null?void 0:P.measurePoint());t.handler("focalLength",y)},async measureMatrix(){var He;const{x:y,y:w}=await o(),P=[],{measureWidth:ne,measureHeight:Y,measureRowCount:re,measureColCount:ce}=t.deviceValues,ye=ce>1?ne/(ce-1):0,kt=re>1?Y/(re-1):0;for(let Re=0;Re<re;Re++){const Ke=[];for(let be=0;be<ce;be++){const Ut={x:y+be*ye,y:w+Re*kt,speed:3600};Ke.push(Ut)}P.push(Ke)}const Zt=await((He=t.ext)==null?void 0:He.measureMatrix(P));console.log(Zt)},mode(p){const{ext:y}=t;p!==v.CURVE_PROCESS?(y.toggleSelectionPlugin(y.dataSource,!1),V&&(V.curveData.previewDisabled=!0),x(!0),l.value=!0):l.value=!1;const w=h(p);t.handler("mode",{value:p,processingTypeList:w})},curvePreview(){const{ext:p}=t;p.emit(D.CURVE_PREVIEW)},async curveMeasurement(){const{ext:p}=t;!p.connected||!await p.beforeCurveMeasure()||p.emit(D.CURVE_MEASURE)}},l=_e(!0),u=async()=>{var p,y;s.value=!0,await((p=t.ext.apis)==null?void 0:p.exitUpgradeMode()),await((y=t.ext.apis)==null?void 0:y.enterMultiPointMode()),t.ext.on("handleReceiveMultiPoint",w=>{console.log("[ handleReceiveMultiPoint ] >"),d(w)})},f=async()=>{var p;s.value=!1,await((p=t.ext.apis)==null?void 0:p.exitUpgradeMode())},g=async()=>{var p,y;await f(),(y=(p=t.ext).toggleMultiPointPlugin)==null||y.call(p,e),e={}},C=(p,{})=>{var ye;const{x:y=0,y:w=0}=p||{},{power:P}=t.deviceInfo;t.ext.updateDeviceInfo({laserPosition:p});let Y=t.ext.dataSource.canvasManager.canvas.getPluginByName(i);Y==null||Y.switchIcon(((ye=t.deviceInfo)==null?void 0:ye.gMode)||0);const re=$e(P),ce=bt(re);Y&&(Y.updateCrossIconOffset(ce),Y.updateIcon({x:y,y:w}))},_=p=>{var P,ne;(P=t.ext.customData)==null||P.setData(`${t.canvasId}.showCoord`,p),(ne=t.ext.customData)==null||ne.set,a.value=p;const y=t.ext.dataSource.canvasManager.canvas;let w=y.getPluginByName(i);p?(w||(w=new Eo(i)),y.registerPlugin(w)):(console.log("[ 插件销毁 ] >"),y.unRegisterPlugin(w),w=null)},m=(p,y)=>p in c?c[p](y):t.handler(p,y),h=p=>{const y=p||t.deviceValues.mode;return yt(Ot,w=>w.modes.includes(y))},x=p=>{F.value=p},V=(We=t.ext.customData)==null?void 0:We.getModeData(t.canvasId,v.CURVE_PROCESS),z=V?V.curveData.previewDisabled:!0,F=_e(z),N={name:"curveMeasurement",widget:"button",widgetAttrs:{label:"device.common.curve_measure",size:"small"},style:{flex:1}},B=T(()=>({name:"curvePreview",widget:"button",widgetAttrs:{icon:"curve-preview",size:"small",title:"device.common.preview",disabled:F.value}})),ve=T(()=>({name:"curve",label:"device.common.curve",type:"group",widget:"buttonGroups",childs:[N,B.value]})),Ye=Go.map(({icon:p,label:y,value:w})=>({icon:p,label:y,value:w})),Xe=T(()=>({name:"focalLength",label:"距离",widget:"unitInput",widgetAttrs:{max:ts,min:ss},suffix:{name:"measureDistance",widget:"button",widgetAttrs:{icon:"accurate",size:"small",title:"device.common.auto_measure",disabled:t.isInProcessing||t.disConnect||t.isFrameMode}},min:0,max:58})),Nt=[{name:"matrixSize",label:"曲面测量",childs:[{name:"measureWidth",widget:"number",widgetAttrs:{size:"small",prefix:"W",min:1,max:999,defaultValue:1}},{name:"measureHeight",widget:"number",widgetAttrs:{size:"small",prefix:"H",min:1,max:999,defaultValue:1}},{name:"measureRowCount",widget:"number",widgetAttrs:{size:"small",prefix:"R",min:1,max:20,defaultValue:99}},{name:"measureColCount",widget:"number",widgetAttrs:{size:"small",prefix:"C",min:1,max:20,defaultValue:99}}]},{name:"measureMatrix",widget:"button",widgetAttrs:{icon:"accurate",size:"small"}}],Gt=T(()=>({[v.LASER_PLANE]:["mode","material",Xe.value],[v.LASER_CYLINDER]:["mode","material","rotaryAttachmentType","catchMode",Xe.value],[v.CURVE_PROCESS]:["mode",ve.value],[v.LASER_CYLINDER_CURVED_SURFACE]:["mode","material",...Nt]}));return(p,y)=>{const w=Wt;return U(),Ee(Ct,null,[S(w,wt({ext:n.ext,"device-values":n.deviceValues,"mode-options":L(Ye),"device-info":n.deviceInfo,"fields-map":L(Gt),handler:m,"process-types":h},p.$attrs),null,16,["ext","device-values","mode-options","device-info","fields-map"]),S(Pt,{ext:n.ext,"device-info":n.deviceInfo,"show-coord":a.value,"update-coord":L(r),"show-multi-point-btn":l.value,onOnUpdateValue:C,onOnUpdateStatu:_,onOnMultiPointBtnClick:u},null,8,["ext","device-info","show-coord","update-coord","show-multi-point-btn"]),S(Vo,{visible:s.value,points:L(e),onClose:f,onConfirm:g},null,8,["visible","points"])],64)}}}),Zo={class:"direction-buttons"},Uo=Q({__name:"DirectionButtons",props:{onMove:{type:Function},onReset:{type:Function},excludeDirection:null},setup(n){const t=n;return(i,e)=>(U(),Ee("div",Zo,[S(L(de),{type:"primary",size:"small",style:{"grid-area":"1 / 2 / 2 / 3"},class:"roundBtn",onClick:e[0]||(e[0]=()=>t.onMove(L(E).TOP))},{default:A(()=>[S(L(oe),{name:"move-arrow-up"})]),_:1}),t.excludeDirection.includes(L(E).LEFT)?at("",!0):(U(),ie(L(de),{key:0,type:"primary",size:"small",style:{"grid-area":"2 / 1 / 3 / 2"},class:"roundBtn",onClick:e[1]||(e[1]=()=>t.onMove(L(E).LEFT))},{default:A(()=>[S(L(oe),{name:"move-arrow-left"})]),_:1})),S(L(de),{type:"primary",size:"small",class:"roundBtn",style:{"grid-area":"2 / 2 / 2 / 3"},onClick:t.onReset},{default:A(()=>[S(L(oe),{name:"move-center"})]),_:1},8,["onClick"]),n.excludeDirection.includes(L(E).RIGHT)?at("",!0):(U(),ie(L(de),{key:1,type:"primary",class:"roundBtn",size:"small",style:{"grid-area":"2 / 3 / 3 / 4"},onClick:e[2]||(e[2]=()=>t.onMove(L(E).RIGHT))},{default:A(()=>[S(L(oe),{name:"move-arrow-right"})]),_:1})),S(L(de),{class:"roundBtn",type:"primary",size:"small",style:{"grid-area":"3 / 2 / 4 / 3"},onClick:e[3]||(e[3]=()=>t.onMove(L(E).BOTTOM))},{default:A(()=>[S(L(oe),{name:"move-arrow-down"})]),_:1})]))}});const pt=Be(Uo,[["__scopeId","data-v-577d7d6d"]]),Fo={style:{display:"flex","margin-top":"20px"}},Bo={style:{"margin-left":"20px"}},$o=I("span",null,"XY",-1),zo={style:{"margin-left":"20px"}},Yo=I("span",null,"Z",-1),Xo=Q({__name:"WalkBorderSettings",props:{deviceInfo:null,ext:null},setup(n,{expose:t}){var d;const i=n,e=_t({gMode:(d=i.deviceInfo)==null?void 0:d.gMode,mode:"rect",power:1,speed:100,xySpeed:100,laserSpot:1,autoStart:!1,enableLaserSpot:!1,debugMode:!1,xyDistance:50,zDistance:10}),s=T(()=>[{name:"gMode",label:"device.setting.position_mode",widget:"radioGroup",widgetAttrs:{defaultValue:0,options:Dt(i.deviceInfo.power)}},{name:"laserSpot",label:"device.process.laser_spot",widget:"number",widgetAttrs:{disabled:e.gMode===0,size:"small",min:1,max:10,suffix:"%",defaultValue:1},visible:()=>i.deviceInfo.power!==2,suffix:{name:"enableLaserSpot",label:`device.process.${i.deviceInfo.enableLaserSpot?"disable":"enable"}`,widget:"button",widgetAttrs:{disabled:e.gMode===0,type:"primary",size:"small"}}},{name:"speed",label:"走边框速度（mm/s）",widget:"slider",widgetAttrs:{min:80,max:300}},{name:"xySpeed",label:"XY移动速度（mm/s）",widget:"slider",widgetAttrs:{min:1,max:300}},{name:"xyDistance",label:"XY 移动距离（mm）",widget:"slider",widgetAttrs:{min:1,max:300}},{name:"zDistance",label:"Z 移动距离（mm）",widget:"slider",widgetAttrs:{min:1,max:58}}]),o=[{name:"debugMode",label:"开启调试模式",widget:"switch",widgetAttrs:{size:"small",defaultValue:!1},inline:!0},{name:"autoStart",label:"自动执行走边框",widget:"switch",widgetAttrs:{size:"small",defaultValue:!1},inline:!0},{name:"mode",label:"device.process.framing_mode",widget:"radioGroup",widgetAttrs:{options:[{label:"device.process.framing_rect",value:"rect"},{label:"device.process.framing_outline",value:"outline"}],defaultValue:"rect"}}],a={gMode(c){var u;const l=i.ext;return(u=l==null?void 0:l.apis)==null?void 0:u.setGMode(c).then(f=>(c===0&&i.deviceInfo.enableLaserSpot&&a.enableLaserSpot(),l&&(l.deviceInfo={gMode:c}),f))},moveLaser(c){var f,g,C,_;if(c==="zero")return(g=(f=i.ext)==null?void 0:f.apis)==null?void 0:g.moveLaserXYToZero();const l=e.xyDistance,u={[E.TOP]:{dir:"Y",val:l*-1},[E.BOTTOM]:{dir:"Y",val:l*1},[E.LEFT]:{dir:"X",val:l*-1},[E.RIGHT]:{dir:"X",val:l*1}};return(_=(C=i.ext)==null?void 0:C.apis)==null?void 0:_.moveLaser({speed:e.xySpeed*60,...u[c]})},moveZLaser(c){var g,C,_,m;if(c==="zero")return(C=(g=i.ext)==null?void 0:g.apis)==null?void 0:C.moveLaserZToZero();const l=os,u=e.zDistance,f={[E.TOP]:{dir:"Z",val:u*-1},[E.BOTTOM]:{dir:"Z",val:u*1}};return console.log("[ val ] >",c),(m=(_=i.ext)==null?void 0:_.apis)==null?void 0:m.moveLaser({speed:l*60,...f[c]})},enableLaserSpot(){var l,u;const c=i.deviceInfo.enableLaserSpot;return(u=(l=i.ext)==null?void 0:l.apis)==null?void 0:u.toggleLaser({power:e.laserSpot*10,isOpen:!c})},debugMode(){var c,l;return(l=(c=i.ext)==null?void 0:c.apis)==null?void 0:l.toggleDebugMode(e.debugMode)}},r=async(...c)=>{const[l,u]=c;if(l!=="enableLaserSpot"&&(e[l]=u),l in a)return a[l](u)};return St(()=>{var c;return(c=i.deviceInfo)==null?void 0:c.gMode},c=>{c!==e.gMode&&(e.gMode=c)}),t({values:e}),(c,l)=>{const u=ft;return U(),Ee("section",null,[S(u,{style:{width:"15rem","max-width":"calc(256px - 28px)"},items:L(s),values:e,handler:r},null,8,["items","values"]),I("div",Fo,[I("div",Bo,[$o,S(pt,{"on-move":a.moveLaser,"on-reset":()=>{a.moveLaser("zero")},"exclude-direction":[]},null,8,["on-move","on-reset"])]),I("div",zo,[Yo,S(pt,{"on-move":f=>{a.moveZLaser(f)},"on-reset":()=>{a.moveZLaser("zero")},"exclude-direction":[L(E).LEFT,L(E).RIGHT]},null,8,["on-move","on-reset","exclude-direction"])])]),S(L(Et),null,{default:A(()=>[xt("调试使用")]),_:1}),S(u,{style:{width:"15rem","max-width":"calc(256px - 28px)"},items:o,values:e,handler:r},null,8,["values"])])}}}),Wo=Q({__name:"WalkBorderTipModal",setup(n){const{t}=Cs(),{state:i,getters:e}=Mt(),s=T(()=>i.modal.walkBorderTipModelVisible),o=async()=>{const{ext:r}=e;try{await r.stopWalkBorder()}catch(d){console.log(d)}},a=T(()=>[{label:t("device.modal.end"),type:"primary",onClick:()=>{o()}}]);return(r,d)=>(U(),ie(L(Rt),{show:L(s),title:r.$t("device.modal.tip"),style:{width:"640px"},footer:L(a)},{default:A(()=>[S(L(nt),{vertical:"",align:"center",justify:"center",size:30,class:"confirm-modal"},{default:A(()=>[S(L(nt),{vertical:"",align:"center",justify:"center",size:10},{default:A(()=>[S(L(Es),null,{default:A(()=>[xt(Se(L(t)("device.process.walk_border")),1)]),_:1})]),_:1}),S(L(Rs),{width:"298","preview-disabled":!0,src:L(xe).readyImg},null,8,["src"])]),_:1})]),_:1},8,["show","title","footer"]))}});const Ho=Be(Wo,[["__scopeId","data-v-0f444cb2"]]),Ko={WalkBorderSettings:Xo,DeviceSetting:Co,ProcessingDataForm:So,ProcessingModeForm:ko,LaserPosition:Pt,WalkBorderTipModal:Ho};function Ue(n,t){const{x:i,y:e}=n,{x:s,y:o}=t,a={x:Math.min(i,s),y:Math.min(e,o)},r={x:Math.max(i,s),y:Math.max(e,o)};return{topLeft:a,buttonRight:r}}function qo(n,t){const{x:i=0,y:e=0,width:s,height:o}=t,{x:a,y:r}=n;return a>=i&&a<=i+s&&r>=e&&r<=e+o}function ht(n,t,i){return n>i?i:n<t?t:n}const Oe=2670148;class jo{constructor(t){M(this,"name");M(this,"type",Fe);M(this,"createDisplayFn");M(this,"viewport");M(this,"container");M(this,"rect");this.name=t}async init(t){this.viewport=t}destroy(){this.container.destroy(!0)}initViewportDisplay(t){return this.createDisplayFn=t,this.createContainer(),this.createRect(),this.container.addChild(this.rect),this.container}createContainer(){this.container=this.createDisplayFn("RECT")}createRect(){this.rect=this.createDisplayFn("RECT",{width:10,height:10,scale:{x:1,y:1},lineColor:16711680})}onViewportScale(t){this.updatePointScale(t.scale)}updatePointScale(t={x:1,y:1}){this.rect.children.forEach(i=>{i.scale.set(1/t.x,1/t.y)})}updateRect(t){var c;const{"1":i,"2":e}=t;console.log("[ 定位 ] >",i,e);const{topLeft:s,buttonRight:o}=Ue(i,e),a=o.x-s.x,r=o.y-s.y;this.rect.clear().lineStyle({width:1,color:Oe,alignment:0,native:!0}).drawRect(s.x,s.y,a,r),this.rect.children.length>0&&this.rect.removeChildren(0,this.rect.children.length);const d=this.drawPoints([i,e]);this.rect.addChild(...d),this.updatePointScale((c=this.viewport)==null?void 0:c.scale)}drawPoints(t){const i=[];return t.forEach(e=>{const s=this.createDisplayFn("RECT");s.position.set(e.x,e.y),s.beginFill(Oe,.5).drawCircle(0,0,2).endFill(),s.beginFill(Oe,.5).drawCircle(0,0,5).endFill(),i.push(s)}),i}}const Jo={id:115,board:[{key:"xcs-d2-0x20",type:32,subType:8},{key:"xcs-d2-0x21",type:33,subType:9},{key:"xcs-d2-0x22",type:34,subType:10},{key:"xcs-d2-0x30",type:48,subType:80},{key:"xcs-d2-0x31",type:49,subType:81},{key:"xcs-d2-0x34",type:52,subType:84},{key:"xcs-d2-0x3d",type:61,subType:91},{key:"xcs-d2-0x3f",type:63,subType:92}]},_a=!0;function xa(n){return class extends n{constructor(...e){super(yo,...e);M(this,"deviceDataValues",No);M(this,"elementDataValues",_o);M(this,"uploadGcodeCancelable");M(this,"customData",new $t);M(this,"cacheData");M(this,"curveWorker");M(this,"curvature",as);M(this,"isEnableMeasure",!0);M(this,"correctCurveBounds",()=>{const e=this.customData.getData(this.canvasId),s=v.CURVE_PROCESS,o=e[s].curveData.tempData;if(!o.laserMeasureStartPosition||!o.laserMeasureEndPosition)return!1;const{topLeft:a,buttonRight:r}=Ue(o.laserMeasureStartPosition,o.laserMeasureEndPosition);o.laserMeasureStartPosition=a,o.laserMeasureEndPosition=r;const d=Ue(o.laserMeasureStartPosition,o.laserMeasureEndPosition);o.laserMeasureStartPosition=d.topLeft,o.laserMeasureEndPosition=d.buttonRight;const{current:c}=this.getCurrentArea(),{x:l,y:u}=o.locationStartPos,{x:f,y:g}=o.locationEndPos;o.locationStartPos={x:Math.min(l,f),y:Math.min(u,g)},o.locationEndPos={x:Math.max(l,f),y:Math.max(u,g)};const C=o.locationStartPos,_=o.locationEndPos,m=Math.abs(_.x-C.x),h=Math.abs(_.y-C.y);return C.x<0||C.y<0||_.x>c.width||_.y>c.height||m<we||h<we?!1:(o.densityArea={x:C.x,y:C.y,width:m,height:h},console.log("[ 模型的尺寸 ] >",o.densityArea),!0)});M(this,"calCurveDensityPoints",e=>{const s=this.customData.getData(this.canvasId),o=v.CURVE_PROCESS,a=s[o].curveData.tempData,{row:r,col:d}=a.curveRange,c=[],l=a.laserMeasureStartPosition,u=a.laserMeasureEndPosition,f=Math.abs(u.x-l.x),g=Math.abs(u.y-l.y),C=f/(d-1),_=g/(r-1),m=e.width-e.pointSize,h=e.height-e.pointSize,x=m/(d-1),V=h/(r-1);let z=r*d,F=!0,N=0,B=0;for(;z>0;)c.push({ox:l.x+C*N,oy:l.y+_*B,x:0,y:0,z:0,colIndex:N,rowIndex:B,left:x*N+e.pointSize/2,top:V*B+e.pointSize/2,color:le.GRAY}),F&&N<d-1?N++:!F&&N>0?N--:B<r-1&&(B++,F=!F),z--;return a.densityPoints=c,a.densityPoints});M(this,"toggleSelectionPlugin",(e,s)=>{const o=e.canvasManager.canvas;let a=o.getPluginByName(tt);return s?(a||(a=new Ds(tt)),o.registerPlugin(a)):(console.log("[ 插件销毁 ] >"),o.unRegisterPlugin(a),a=null),a});this.cacheData=new Is(this.apis),this.deviceInfo.ableLaserSpot=!1,this.on(Ie.Disconnected,()=>{this.isEnableMeasure=!1})}set walkBorderParams({speed:e,power:s}){const o=this.deviceInfo.power,a=this.config.process.lowLightPower[o];a&&a.formula&&(s=a.formula(o)),this._walkBorderParams.power=s,this._walkBorderParams.speed=e}get walkBorderParams(){return this.deviceInfo.gMode===gt.RED_CROSS?{...this._walkBorderParams,power:0}:this._walkBorderParams}getExceptionsByKey(e){const s=super.getExceptionsByKey(e),a={[me]:{confirmLabelKey:"去复位",closable:!0,type:"default",confirmAction:async()=>{await this.measurePoint(!0)}}}[e],r={...s,...a};return console.log("[ result ] >",r),r}initProcessParams(e){this.processParams=new $s(e)}get ui(){return Ko}async checkDeviceIsReadyToUpload(){return this.deviceChecker(["sdCard",se.X_TOUCH_NO_MEASURE])}updateDeviceInfo(e){const s=this.info;super.updateDeviceInfo(e);const{power:o,gMode:a}=this.deviceInfo;s.power!==o&&(this.emit(D.UPDATE_POWER),this.emit(D.BATCH_UPDATE_PROCESSING_AREA)),s.gMode!==a&&(console.log("定位方式发生改变",s.gMode,"=>",a),this.emit(D.UPDATE_GMODE),this.emit(D.BATCH_UPDATE_PROCESSING_AREA))}getSpeed(e,s){const{speed:o={}}=this._config.deviceMetaData??{},a=o[e.mode],r=this.deviceInfo.power,{rotaryAttachmentType:d}=e,{processingType:c}=s;let l=[],u=[];if(ds(a)){const g=Object.keys(o)[0];return o[g][0]}const f=a.filter(g=>g.type===c);return d&&(l=f.filter(g=>g[d])),us(r)&&r>0&&(u=l.filter(g=>g.power&&g.power.includes(r)),u.length===0&&(u=f.filter(g=>g.power&&g.power.includes(r)))),u[0]||l[0]||f[0]}get processingAreaKey(){const{power:e}=this.deviceInfo;return`${e}`}getCurrentArea(){return super.getCurrentArea("")}async checkProcessData({canvasData:e,centralAxisPosition:s,isWalkBorder:o=!1,dataSource:a}){var l,u;const{x:r,y:d}=await((l=this.apis)==null?void 0:l.getLaserCoord())||{x:0,y:0};if(this.deviceInfo.laserPosition={x:r,y:d},a.currentDeviceData.mode===ae.CURVE_PROCESS){const f=(u=this.customData)==null?void 0:u.getModeData(this.canvasId,v.CURVE_PROCESS);if(!(f!=null&&f.curveData))return{type:X.text,text:"device.measure.curve_process_mode_data_tip"}}return super.checkProcessData({canvasData:e,centralAxisPosition:s,isWalkBorder:o,dataSource:a})}async deviceChecker(e){const s=async r=>{const d=await this.apis.checkXTouchStatu(),c={S2:me,S0:Ge,S3:ke};r=r??Object.values(c);const l=c[d];return l&&r.includes(l)?(this.emit(Ie.Error,this.getExceptionsByKey(l)),!1):!0},o={connect:{func:()=>this.connected,msg:"device.measure.measure_fail_disconnect"},idle:{func:()=>!0,msg:"device.status.busy_tip"},curveBounds:{func:this.correctCurveBounds,msg:"device.measure.measure_min_error"},measureBounds:{func:r=>{const{pos:d,bounds:c}=r;return qo(d,c)},msg:"device.measure.measure_disable"},[se.X_TOUCH_NO_MEASURE]:{func:async()=>await s([me])},[se.X_TOUCH]:{func:async()=>await s()},sdCard:{func:()=>this.deviceInfo.sdCard===0,msg:"device.process.tf_tips"}};let a=!0;for(let r=0;r<e.length;r++){let d,c="";const l=e[r];ot(l)?c=l:(c=l.name,d=l.args);const u=o[c];if(!u)continue;if(!await u.func.bind(this)(d)){a=!1,u.msg&&this.appContext.showMessage({contentI18nKey:u.msg});break}}return a}async httpUploadFrameGCode(e,s){const{signal:o}=Ht();await this.apis.beforeUploadGCode("S0");const a={signal:o,data:{gcode:s},params:{filename:e}};await this.apis.uploadGcode(a),await this.apis.afterUploadGCode("S0")}async httpUploadGCode(e,s,o){await this.apis.beforeUploadGCode("S1");const a={method:"info",params:{filename:e}},r=await this.apis.uploadGcode(a),d=new URLSearchParams({filename:e}).toString(),c=new URL(r.url+"?"+d,r.baseUrl).toString();await this.uploadGCodeByNative({url:c,path:s,options:{isFullPath:!1,useFormData:!0,onProgress:l=>{Ce(o)&&o(l)},onCancel:l=>{this.uploadGcodeCancelable=l}}}),await this.apis.afterUploadGCode("S1")}async serialUploadGCode(e,s,o){await this.apis.uploadGcode({data:{gcode:s,name:e},limit:window.UPLOAD_LIMIT,isWalkBorder:e==="frame.gcode",onUploadProgress:a=>{const r=a.loaded/a.total;console.log(["d2 serial upload gcode progress",r]),Ce(o)&&o(r)},onCancel:a=>{console.log("=> on cancel",a),this.uploadGcodeCancelable=a}})}async uploadGCode(e){const s=await this.builder.gcode(),{onProgress:o}=e||{};return this.connectType==="SERIAL"?await this.serialUploadGCode("tmp.gcode",s,o):await this.httpUploadGCode("tmp.gcode",s,o),!0}startProcessing(){return this.uploadGCode()}pauseProcessing(){return this.apis.pausePrint()}cancelProcessing(){return this.apis.cancelPrint()}async startWalkBorder(e,s){const o=await this.deviceChecker([se.X_TOUCH_NO_MEASURE]);if(console.log("[ pass ] >",o),!o)return;this.connectType==="SERIAL"?await this.serialUploadGCode("frame.gcode",e):await this.httpUploadFrameGCode("frame.gcode",e);const{autoStart:a=!1}=s??{};await this.apis.setFrameStatus("S0"),this.emit(D.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!0),a&&await this.apis.setFrameStatus("S1")}stopWalkBorder(){return this.emit(D.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!1),this.apis.setFrameStatus("S2")}cancelUploadGCode(){console.log(["=> cancelUploadGCode"]),Ce(this.uploadGcodeCancelable)&&this.uploadGcodeCancelable()}downloadFirmware(e){if(this.connectType===Pe.SERIAL){const{url:s,...o}=e;return this.apis.downloadFirmware({...o,url:ms(s)?s[0]:ps(s)})}return super.downloadFirmware(e)}async updateFirmware(e){if(this.connectType===Pe.SERIAL){const{data:s,...o}=e,a=hs(Jo);for(const r in s){const d=s[r],c=a.board.find(l=>l.key===r);c&&(c.fpath=d)}return this.apis.updateFirmware({...o,config:a,useF0f7:!0})}else return super.updateFirmware(e,!1)}async checkFirmwareUpdated(e){return this.connectType===Pe.SERIAL?(await Kt(3e3),Promise.resolve(!0)):super.checkFirmwareUpdated(e,{delay:1e3,loopCount:20})}exportLog(){return super.exportLog("xcs_d2_log.gz")}async resetCurveLaserHead(){var e;await((e=this.apis)==null?void 0:e.moveLaserToZero())}async moveCurveLaserPosition(e,s=De){var c;if(!await((c=this.deviceChecker)==null?void 0:c.call(this,["connect","idle"])))return!1;const{x:a,y:r}=await this.apis.getLaserCoord(),d={[E.TOP]:{x:a,y:r-s},[E.BOTTOM]:{x:a,y:r+s},[E.LEFT]:{x:a-s,y:r},[E.RIGHT]:{x:a+s,y:r}};return await this.moveLaser({...d[e]}),{hasMax:!1}}async moveLaser(e,s=3600){var o;console.log("移动激光头",e),await((o=this.apis)==null?void 0:o.moveToPoint({x:e.x,y:e.y,z:0,speed:s})),await this.whenReceiveCmd("M22"),console.log(["移动激光头结束"])}async beforeMeasure(){var e;console.info(["1. 进入测量模式"]),await((e=this.apis)==null?void 0:e.enterMeasureMode()),console.info(["1-1. 进入测量模式成功"])}async afterMeasure(e){var s;console.info("2. 开始重置对焦模块"),await this.apis.moveToResetFocusModel({...this.deviceInfo.xTouchResetPos,speed:De}),await this.apis.resetFocusModel(),await this.whenReceiveCmd("M22"),console.info("2. 重置对焦模块完成"),console.info(["3. 退出测量模式"]),await((s=this.apis)==null?void 0:s.exitMeasureMode()),console.info(["3-1. 退出测量模式成功"]),e&&await this.moveLaser({x:e.x,y:e.y},De)}async measure(){console.info(["启动测量"]),await this.apis.startMeasure();const[e,s]=await Promise.all([this.whenReceiveCmd("M313"),this.whenReceiveCmd("M311"),this.whenReceiveCmd("M22")]),o=k(e,"Z")??NaN,a=k(s,"S"),r={z:o,valid:a===2};return console.info(["完成测量",r]),r}async measurePoint(e=!1){const s=this.deviceInfo.enableLaserSpot,o=await this.apis.getLaserCoord(),{x:a,y:r}=this.calLaserPosByMeasurePos(o);let d={z:-1,valid:!1};if(!e){const{current:c}=this.getCurrentArea();if(!await this.deviceChecker([{name:"measureBounds",args:{pos:{x:a,y:r},bounds:c}}]))return;await this.moveLaser({x:a,y:r}),await this.beforeMeasure(),d=await this.measure()}return await this.afterMeasure({x:o.x,y:o.y}),s&&setTimeout(()=>{this.apis.toggleLaser({power:10,isOpen:!0})},3e3),d}toggleMultiPointPlugin(e,s=!0){var r;const o=(r=this.dataSource)==null?void 0:r.canvasManager.canvas;let a=o.getPluginByName("D2MultiPointPlugin");s?(a||(a=new jo("D2MultiPointPlugin"),o.registerPlugin(a)),a.updateRect(e)):o.unRegisterPlugin(a)}deviceCmdParsing(e){if(console.log({cmd:e}),ot(e)&&(e=e.replace(/[\r\n]/g,"")),[me,ke,Ge].includes(e)&&(this.isEnableMeasure=!1),e==="M222 S8"&&(this.deviceInfo.sdCard=1),e==="M321 S0"&&(this.deviceInfo.sdCard=0),this.exceptionsKeys.includes(e))this.emit(Ie.Error,this.getExceptionsByKey(e)),this.emit(D.UPDATE_DEVICE_INFO,{currentStatus:Ze.S0});else if(e.includes(lt)){e=e.replace(/.+M/,"M"),e=e.replace(lt,""),console.log("加工状态改变",e);const s=Ze[e];zs.includes(e)&&(this.emit(D.UPDATE_DEVICE_INFO,{currentStatus:s}),s===Z.CANCEL_PROCESS&&this.emit(D.UPDATE_WALK_BORDER_TIP_MODAL_VISIBLE,!1))}else if(e.startsWith("M")){const[s,o]=e.split(" ");if(s==="M36"){const a=o!=="S0";this.deviceInfo.enableLaserSpot=a,this.emit(D.UPDATE_DEVICE_INFO,{enableLaserSpot:a})}if(s==="M372"&&this.emit("handleReceiveMultiPoint",qs(o)),this.whenReceiveCmdResolveMap.has(s)){const a=this.whenReceiveCmdResolveMap.get(s);Ce(a)&&a(o)}}}async beforeCurveMeasure(){const e=await this.deviceChecker([se.X_TOUCH]);if(!e)return e;const s=this.customData.getData(this.canvasId),o=v.CURVE_PROCESS;return s?(s[o].curveData.tempData=et(),s[o].curveData.remeasurePoints=[],!0):(this.customData.setData(`${this.canvasId}.${o}`,is()),!0)}finishCurvePreview(){var f;const e=this.customData.getData(this.canvasId),s=v.CURVE_PROCESS,o=(f=e[s])==null?void 0:f.curveData,{current:a}=this.getCurrentArea(),r=(a==null?void 0:a.offsetX)??0,d=(a==null?void 0:a.offsetY)??0,c={x:o.locationStartPos.x+r,y:o.locationStartPos.y+d},l={x:o.locationEndPos.x+r,y:o.locationEndPos.y+d},u=this.toggleSelectionPlugin(this.dataSource,!0);u&&u.updateRect({x:c.x,y:c.y,width:Math.abs(l.x-c.x),height:Math.abs(l.y-c.y)})}async afterCurveMeasure(e){e&&await this.afterCurveMeasureAllPoints()}async beforeRecordCurvePosition(){var s;return await((s=this.deviceChecker)==null?void 0:s.call(this,["connect","idle"]))?(this.resetCurveTempData(),!0):!1}async afterRecordCurvePosition(){var s;return!!await((s=this.deviceChecker)==null?void 0:s.call(this,["connect","idle","curveBounds"]))}async curveMeasurePoint(e){if(!this.isEnableMeasure)throw this.isEnableMeasure=!0,new Error("suspend");try{await this.moveLaser({x:e.ox,y:e.oy});const{z:s}=await this.measure();console.log("[ curveMeasurePoint z ] >",s);const o={x:e.ox,y:e.oy,z:Ae-s},a=Ss(this.deviceInfo.power);return{...e,x:e.ox+a.x,y:e.oy+a.y,z:o.z,color:le.GREEN,result:"success"}}catch(s){if(console.log("curveMeasure err: ",s),["timeout of 30000ms exceeded","Network Error"].includes(s.message))throw new Error("disconnected");return{...e,z:0,color:le.RED,result:"fail"}}}async recordCurveStartPosition(){var f;if(!await((f=this.deviceChecker)==null?void 0:f.call(this,["connect","idle"])))return!1;const s=this.customData.getData(this.canvasId),o=v.CURVE_PROCESS,a=s[o].curveData.tempData,r=await this.apis.getLaserCoord(),d=this.calLaserPosByMeasurePos(r),c={ox:d.x,oy:d.y,x:0,y:0,z:0},{power:l,gMode:u}=this.deviceInfo;return a.laserMeasureStartPosition=d,a.laserStartPosition=r,a.locationStartPos=it(r,l,u),console.log("[ 开始点 ] >",c),{result:"success",position:c}}calLaserPosByMeasurePos(e){const{power:s,gMode:o}=this.deviceInfo,a=$e(s),r=xs(o,a);return{x:e.x-r.x,y:e.y-r.y}}updateCurveDensityPoints(){const e=this.customData.getData(this.canvasId),s=v.CURVE_PROCESS,o=e[s].curveData;return o.densityPoints.forEach(a=>{o.remeasurePoints.findIndex(d=>a.rowIndex===d.rowIndex&&a.colIndex===d.colIndex)!==-1?(a.color=le.BLUE,a.skipMeasure=!1,a.z=0,a.result=""):(a.color=le.SILVERY,a.skipMeasure=!0)}),o.densityPoints}async recordCurveEndPosition(){const e=this.customData.getData(this.canvasId),s=v.CURVE_PROCESS,o=e[s].curveData.tempData,a=await this.apis.getLaserCoord(),r=this.calLaserPosByMeasurePos(a),d={ox:r.x,oy:r.y,x:0,y:0,z:0},{power:c,gMode:l}=this.deviceInfo;return o.laserMeasureEndPosition=r,o.laserEndPosition=a,o.locationEndPos=it(a,c,l),console.log("[ 结束点 ] >",d),{result:"success",position:d}}setRecommendAttr(){const e=this.customData.getData(this.canvasId),s=v.CURVE_PROCESS,o=e[s].curveData.tempData,{width:a,height:r}=o.densityArea,d=Math.ceil(r/we),c=Math.ceil(a/we);o.curveRange={row:ht(d,rs,ns),col:ht(c,ls,cs)}}async beforeCurveMeasureAllPoints(){await this.beforeMeasure()}async afterCurveMeasureAllPoints(){var o,a;const e=(o=this.customData.getModeData(this.canvasId,v.CURVE_PROCESS))==null?void 0:o.curveData,s=((a=e==null?void 0:e.tempData)==null?void 0:a.laserStartPosition)||(e==null?void 0:e.laserStartPosition)||{};this.afterMeasure({x:s.x,y:s.y})}beforeCurveRemeasure(){return this.deviceChecker(["connect","idle","xTouch"])}beforeCurveMeasuring(){return this.deviceChecker(["connect","idle","xTouch"])}resetCurveTempData(){const e=this.customData.getData(this.canvasId),s=v.CURVE_PROCESS;e[s].curveData.tempData=et()}setFinalCurveData(e,s=!0){const o=this.customData.getData(this.canvasId),a=v.CURVE_PROCESS,r=o[a].curveData;s&&(Object.assign(r,r.tempData),this.resetCurveTempData()),r.remeasurePoints=[],r.densityPoints=e,r.smoothness=3,r.tension=3,r.previewDisabled=!1,r.needDangerTip=!1}async getCurveData(e){this.curveWorker||(this.curveWorker=new zt);const s=this.customData.getData(this.canvasId),o=v.CURVE_PROCESS,a=s[o].curveData,r=a.curveRange,d=a.densityPoints,c={tension:e.tension||3,smoothness:e.smoothness||3,size:r,densityPoints:d},l=await this.curveWorker.getCurveData({info:c}),u=this.curvature.large.angle[0],f=l.points.some(g=>g.a>u);return{densityPoints:d,modelData:l,hasDangerPoint:f}}buildProcessGcode(e){return e===v.CURVE_PROCESS?this.buildCurveGcode():super.buildProcessGcode(e)}async buildCurveGcode(){const{printData:e,params:s}=this.printInfo,{current:{offsetX:o=0,offsetY:a=0}}=this.getCurrentArea(),r=Qe(e,Ve.VECTOR_ENGRAVING);let d="";if(r&&r.list.length>0){const g=await this.getCurveVectorGCode(r,{offsetX:o,offsetY:a});g&&(d+=g)}const c=Qe(e,Ve.BITMAP_ENGRAVING);if(c&&c.list.length>0){const g=await this.getCurveBitmapGCode(c,{offsetX:o,offsetY:a});g&&(d+=`
${g}`)}if(!d)return;const l=ue(W.curveVector),u=this.builder.hook.note(s),f=l({focalLen:s.focalLen,motionCode:d,motionConfig:`{"color": ${qt.VECTOR_ENGRAVING}}`});return this.builder.place(u,f)}async getCurveVectorGCode(e,s){var c;const o={},a=e.list;for(let l=0;l<a.length;l++){const{source:u,power:f,speed:g,repeat:C}=a[l];if(!u)continue;const _=`${f}-${g}-${C}`;o[_]||(o[_]={path:"",power:f,speed:g,repeat:C});const m=fs(String(u)).translate(-s.offsetX,-s.offsetY).toString();o[_].path+=m}let r="";const d=Object.values(o);for(let l=0;l<d.length;l++){const{path:u,power:f,speed:g,repeat:C}=d[l],_=await((c=this.curveWorker)==null?void 0:c.getVectorGCode({svg:jt(u),params:{power:f*10,speed:g*60,z_max:Ae-st,repeat:C}}))||"";return _&&(r+=`# blockConfig={"powerFactor": -1} 
`,r+=_),r}}async getCurveBitmapGCode(e,s){var d;const o=e.list;let a="";const r=Tt.buildParams.accel;for(let c=0;c<o.length;c++){if(!o[c].source)continue;let l=o[c].source;o[c].isFill&&(l=Ps(o[c].source));const u=Math.pow(o[c].speed-0,2)/2/r,f=await((d=this.curveWorker)==null?void 0:d.getBitmapGCode({imgData:{imgData:l,resolutionX:o[c].oWidth,resolutionY:o[c].oHeight,x:o[c].x-s.offsetX,y:o[c].y-s.offsetY,imgWidth:o[c].width,imgHeight:o[c].height},params:{overDist:u,power:o[c].power*10,speed:o[c].speed*60,repeat:o[c].repeat,density:o[c].density,z_max:Ae-st}}))||"";f&&(a+=`# blockConfig={"powerFactor":${.01*o[c].power}} 
`,a+=f)}return a}}}export{xa as DeviceExt,_a as v2};
