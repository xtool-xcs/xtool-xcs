(function(){"use strict";function k(n,s,r=128){const t=s;let o,c,l,f;const y=n.length;for(let i=0;i<y;i++){o=[i+1,i+2,i+t-1,i+t,i+t+1,i+2*t],c=n[i]<r?0:255,l=n[i]-c,n[i]=c;for(let e=0;e<o.length;e++)f=o[e],n[f]+=l/8>>0}}function v(n,s,r,t=128){const o=[[96,40,48,104,140,188,196,148],[32,0,8,56,180,236,244,204],[88,24,16,64,172,228,252,212],[120,80,72,112,132,164,220,156],[136,184,192,144,100,44,52,108],[176,232,240,200,36,4,12,60],[168,224,248,208,92,28,20,68],[128,160,216,152,124,84,76,116]];let c,l,f;for(l=0;l<r;l++)for(f=0;f<s;f++){c=l*s+f;const y=n[c]+o[l&7][f&7]>>1>>0;n[c]=y<t?0:255}}function z(n,s,r=180,t=0){const o=s;let c,l,f,y;const i=[7,3,5,1],e=n.length,u=16+t;for(let a=0;a<e;a++){c=[a+1,a+o-1,a+o,a+o+1],l=n[a]<r?0:255,f=n[a]-l,n[a]=l;for(let h=0;h<c.length;h++)y=c[h],n[y]=n[y]+f*i[h]/u}}function L(n,s,r=255){const t=s;let o,c,l,f;const y=[7,5,3,5,7,5,3,1,3,5,3,1],i=n.length;for(let e=0;e<i;e++){o=[e+1,e+2,e+t-2,e+t-1,e+t,e+t+1,e+t+2,e+t*2-2,e+t*2-1,e+t*2,e+t*2+1,e+t*2+2],c=n[e]<r?0:255,l=n[e]-c,n[e]=c;for(let u=0;u<o.length;u++)f=o[u],n[f]+=l*y[u]/48}}function x(n,s,r=128){const t=s;let o,c,l,f;const y=[5,3,2,4,5,4,2,2,3,2],i=n.length;for(let e=0;e<i;e++){o=[e+1,e+2,e+t-2,e+t-1,e+t,e+t+1,e+t+2,e+t*2-1,e+t*2,e+t*2+1],c=n[e]<r?0:255,l=n[e]-c,n[e]=c;for(let u=0;u<o.length;u++)f=o[u],n[f]+=l*y[u]/32>>0}}function I(n,s,r=128){const t=s;let o,c,l,f;const y=[8,4,2,4,8,4,2,1,2,4,2,1],i=n.length;for(let e=0;e<i;e++){o=[e+1,e+2,e+t-2,e+t-1,e+t,e+t+1,e+t+2,e+t*2-2,e+t*2-1,e+t*2,e+t*2+1,e+t*2+2],c=n[e]<r?0:255,l=n[e]-c,n[e]=c;for(let u=0;u<o.length;u++)f=o[u],n[f]+=l*y[u]/42>>0}}function d(n){const s=n.length/4,r=new Uint8ClampedArray(s);for(let t=0;t<n.length;t+=4){const o=n[t],c=n[t+1],l=n[t+2],f=n[t+3],y=A({R:o,G:c,B:l,A:f});r[t>>2]=C(y.R,y.G,y.B)}return r}function A(n,s={R:255,G:255,B:255}){const r=n.A/255;return{R:(1-r)*s.R+r*n.R,G:(1-r)*s.G+r*n.G,B:(1-r)*s.B+r*n.B}}function C(n,s,r){return .3*n+.6*s+.1*r>>0}function b(n,s,r,t,o){const c=t*o,l=new Uint8ClampedArray(c),f=s/t,y=r/o;for(let i=0;i<o;i++)for(let e=0;e<t;e++){const u=e*f>>0,a=i*y>>0,h=a*s+u,g=e*f-u,j=i*y-a,G=n[h],F=u===s-1?G:n[h+1],J=a===r-1?G:n[h+s],T=a===r-1||u===s-1?G:n[h+s+1],U=G*(1-g)*(1-j)+F*g*(1-j)+J*j*(1-g)+T*g*j>>0,V=i*t+e;l[V]=U}return l}var p=(n=>(n.Grayscale="grayscale",n.Bayer="Bayer",n.Stucki="Stucki",n.Atkinson="Atkinson",n.Jarvis="Jarvis",n.Sierra="Sierra",n.Floyd="Floyd",n))(p||{});function w(n,s,r,t,o){switch(n){case"Atkinson":return k(s,r,o);case"Bayer":return v(s,r,t,o);case"Jarvis":return L(s,r,o);case"Sierra":return x(s,r,o);case"Stucki":return I(s,r,o);case"Floyd":return z(s,r,o);default:return d(s)}}class P{constructor(s){s&&this.setup(s),self.onerror=(r,t,o,c,l)=>{const f={source:t,lineno:o,colno:c,error:l};console.error(["=> worker process error",f]),this.send({type:"error",data:f})}}setup(s){self.onmessage=r=>{const{type:t}=r.data,o=s[t];typeof o=="function"&&o(r.data)}}send(s){self.postMessage(s)}}function _(n,s,r){const t=n.length*4,o=new Uint8ClampedArray(t);for(let c=0;c<n.length;c++){const l=c*4;o[l]=n[c],o[l+1]=n[c],o[l+2]=n[c],o[l+3]=255}return new ImageData(o,s,r)}const S=(n,s)=>{const r=n*s/10;return r%1>.1?Math.ceil(r):Math.floor(r)},B={async resize(n){console.time("1. resize");const{type:s,reqId:r,data:t}=n,{bitmapMode:o,imgData:c,oWidth:l,oHeight:f,destWidth:y,destHeight:i}=t,e=d(c),u=b(e,l,f,y,i);o.toLowerCase()!==p.Grayscale&&w(o,u,y,i,127),console.timeEnd("1. resize"),R.send({type:s,reqId:r,data:{source:u}})},async imageProcess(n){console.time("2. imageProcess");const{type:s,reqId:r,data:t}=n,{bitmapMode:o=p.Grayscale,oWidth:c,oHeight:l,width:f,height:y,density:i}=t;let{imgData:e}=t;const u=S(f,i),a=S(y,i);e=d(e),(c!==u||l!==a)&&(e=b(e,c,l,u,a)),o.toLowerCase()!==p.Grayscale&&w(o,e,u,a,127);const h=_(e,u,a);console.timeEnd("2. imageProcess"),R.send({type:s,reqId:r,data:h})}},R=new P;R.setup(B)})();
